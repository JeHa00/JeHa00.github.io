<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Project: Docker를 사용하여 django app 배포하기 | Jeha DevLog</title><meta name=keywords content="deployment"><meta name=description content="docker compose를 사용하여 nginx, gunicorn, AWS S3, AWS RDS와 연결된 django application을 배포한다. 이때, AWS S3에 접근하기 위해서 AWS IAM을 사용한다. static files에 연결하는 방식으로 3가지를 사용했다."><meta name=author content><link rel=canonical href=http://jeha00.github.io/post/project/devket/deployment/01_deployment/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.min.1e44d58192cbf6d7a4eb649bc43dbc3d4cc432677e5d8adc69b08c34cbe461ac.css integrity="sha256-HkTVgZLL9tek62SbxD28PUzEMmd+XYrcabCMNMvkYaw=" rel="preload stylesheet" as=style><link rel=icon href=http://jeha00.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://jeha00.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://jeha00.github.io/favicon-32x32.png><link rel=apple-touch-icon href=http://jeha00.github.io/apple-touch-icon.png><link rel=mask-icon href=http://jeha00.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.101.0"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Project: Docker를 사용하여 django app 배포하기"><meta property="og:description" content="docker compose를 사용하여 nginx, gunicorn, AWS S3, AWS RDS와 연결된 django application을 배포한다. 이때, AWS S3에 접근하기 위해서 AWS IAM을 사용한다. static files에 연결하는 방식으로 3가지를 사용했다."><meta property="og:type" content="article"><meta property="og:url" content="http://jeha00.github.io/post/project/devket/deployment/01_deployment/"><meta property="og:image" content="http://jeha00.github.io/47"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-12-08T14:43:44+09:00"><meta property="article:modified_time" content="2022-12-08T14:43:44+09:00"><meta property="og:site_name" content="JeHa00 DevLog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://jeha00.github.io/47"><meta name=twitter:title content="Project: Docker를 사용하여 django app 배포하기"><meta name=twitter:description content="docker compose를 사용하여 nginx, gunicorn, AWS S3, AWS RDS와 연결된 django application을 배포한다. 이때, AWS S3에 접근하기 위해서 AWS IAM을 사용한다. static files에 연결하는 방식으로 3가지를 사용했다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://jeha00.github.io/post/"},{"@type":"ListItem","position":2,"name":"Project: Docker를 사용하여 django app 배포하기","item":"http://jeha00.github.io/post/project/devket/deployment/01_deployment/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Project: Docker를 사용하여 django app 배포하기","name":"Project: Docker를 사용하여 django app 배포하기","description":"docker compose를 사용하여 nginx, gunicorn, AWS S3, AWS RDS와 연결된 django application을 배포한다. 이때, AWS S3에 접근하기 위해서 AWS IAM을 사용한다. static files에 연결하는 방식으로 3가지를 사용했다.","keywords":["deployment"],"articleBody":"0. Introduction 이 repository는 현재 러닝스푼즈 나노디그리 - django backend 부트캠프에서 팀 프로젝트를 진행하면서 다음과 같은 내용들에 대해 정리하고자 만들었습니다.\n팀 정책을 이것으로 정한 이유 개발하면서 부딪힌 문제들에 대한 원인, 해결방안, 해결과정, 그리고 그 이유들 배포 작업 시작 1차적으로 구현한 기능을 마치고, Docker 내용을 복습한 후 배포 작업을 시작했다. 배포 작업 순서, 에러, 해결방안, 그리고 여러 이유들에 대해 정리해본다.\n배포 관련 이전 학습 내용들 배포에 관련해서 배운 내용은 다음과 같다.\ndjango live 강의에서는 docker를 사용하지 않고, AWS EC2 서버에서 nginx, uwsgi와 django app을 연결 후, AWS RDS, IAM, S3와 연결하여 배포했다. Docker 강의에서는 AWS EC2 서버에서 Docker container만을 사용하여 nginx, gunicorn, django app, postgreSQL image들을 사용하여 배포했다. 위 내용을 바탕으로 구성한 배포 구조 그래서 이번 프로젝트 배포에서는 django live 강의 마지막에 학습한 배포와 docker 강의에서 학습한 docker를 활용한 배포 내용을 정리한 것을 보고 합하여 진행해본다.\nAWS EC2 서버에 docker-compose를 사용하여 nginx, django의 각 custom image를 만든다. django app에는 AWS RDS(postgreSQL), IAM, S3 연결 세팅을 해놓은 후 build 실행한다. uWSGI와 gunicorn 중 후자를 택한 이유 uWSGI 와 gunicorn 중 gunicorn을 선택했다.\n지난 강의 때 들었던 내용을 정리한 WSGI의 종류를 참고하면 gnicorn은 입문자가 사용하기에 편리하고, 성능을 내는 데에는 uWSGI가 좋다고 판단했다.\n하지만, 이외의 여러 블로그 의견들을 취합했고 많은 공통된 의견들을 발견했다.\n한 예로 python개발자 uWSGI를 버리고 gunicorn으로 갈아타다.을 근거로 전달하자면 uWSGI는 다른 WSGI에 비해서 무거워 자원 소모가 큰 문제점이 있다.\n하지만, gunicorn은 가볍고 큰 프로젝트가 아닌 경우 uWSGI보다 빠른 성능을 낸다는 장점이 있다.\n현재 프로젝트는 규모가 크지 않아서 uWSGI보다는 gunicorn을 사용하는 것이 적절하다고 판단했다.\nroot 계정으로 하지 않기 root 계정으로 배포를 하게 되면 일반 user는 로그인하지 못하기 때문이다.\n1. git clone 및 file directory 구조 git clone 하여 가져오기 ~/development/devket directory를 생성하여 git clone으로 가져온다.\n이에 따라 requirements.txt를 docker compose를 실행하기 위해서 위치를 바꾼다. Devket 안이 아니라 Dockerfile과 동일한 레벨로 옮긴다.\nfile directory 익숙하지 않아서 먼저 구조를 잡기 위해 파일들을 생성했다.\n아래 파일 구조를 출력하기 위해 sudo apt-get install tree을 설치한 후, tree ./을 입력한다.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # ~/deployment ./ ├── devket │ ├── Devket │ │ ├── config │ │ ├── manage.py │ │ ├── pocket │ │ ├── static │ │ │ ├── css │ │ │ └── js │ │ └── templates │ ├── Dockerfile │ └── requirements.txt ├── docker-compose.yml └── nginx ├── Dockerfile └── default.conf 2. Dockerfile 생성 2.1 django app(devket) Dockerfile 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 FROM python:3.10.8 WORKDIR /usr/src/app COPY . . RUN python -m pip install --upgrade pip \\ \u0026\u0026 pip install -r requirements.txt \\ \u0026\u0026 pip install boto3 \\ \u0026\u0026 pip install django-storages \\ \u0026\u0026 pip install gunicorn # git WORKDIR ./Devket RUN python manage.py collectstatic --noinput CMD sh -c \"python manage.py makemigrations \\ \u0026\u0026 python manage.py migrate \\ \u0026\u0026 python manage.py runserver 0:8000\" CMD gunicorn config.wsgi:application --bind 0:8000 EXPOSE 8000 boto3를 사용하는 이유: 파이썬 언어를 사용하여 EC2, S3 같은 AWS 서비스를 구성하고 관리하려면 boto3를 사용해야 한다. django-storages를 설치하는 이유: 장고 프로젝트가 특정 storage를 사용하기 위해서 설치한다. docs.docker - CMD 위 문서에 따르면 기본 명령어 형식으로 CMD는 여러 개를 입력할 수 없다. 그래서 shell에 입력하듯이 하는 방식으로 CMD를 입력했다. ❗️ EOFError python manage.py collecstatic은 input 값을 기본적으로 필요로 하는 명령어다.\n오랫동안 입력값이 없으면 EOFError가 발생한다. 그래서 옵션으로 --noinput을 하면 input 값을 기다렸다가 yes로 자동적으로 입력되어 진행된다.\nDockerfile이 진행되는 동안 입력값을 받지 못하고, 처음 image build 시 collectstatic을 반드시 실행해야하기 때문에 이 옵션을 사용했다.\n출처: Where to run collectstatic when deploying django app…using Docker 2.2 django app Dockerfile version 입력 위 Dockerfile에서 다음 명령어를 삭제 또는 수정하기로 했다.\n1 2 3 \u0026\u0026 pip install boto3 \\ \u0026\u0026 pip install django-storages \\ \u0026\u0026 pip install gunicorn 왜냐하면 정확한 버전이 적혀있지 않아서 설치할 때 최신 버전을 설치하게 되는데, 이런 방식으로 설치하는 건 지금은 문제가 없을 수 있다.\n하지만, 그 당시 최신 버전에서 작동되었던 코드들이 업데이트 되면서 작동되지 않을 수 있기 때문이다.\n그래서 삭제 후, requirements.txt에 버전 명과 함께 구체적으로 입력한다.\n1 2 3 4 5 ... boto3==1.26.27 django-storages==1.13.1 gunicorn==20.1.0 ... 또는 위 명령어를 삭제하지 않고, 아래와 같이 정확한 버전 명을 입력하는 것도 또 하나의 방법이다.\n1 2 3 \u0026\u0026 pip install boto3==1.26.27 \\ \u0026\u0026 pip install django-storages==1.13.1 \\ \u0026\u0026 pip install gunicorn==20.1.0 2.3 nginx Dockerfile 1 2 3 4 FROM nginx RUN rm /etc/nginx/conf.d/default.conf COPY default.conf /etc/nginx/conf.d CMD [\"nginx\", \"-g\", \"daemon off;\"] 3. nginx의 default.conf 80 port로 트래픽을 받아서 web application에 전달한다.\nproxy_pass에서 devket은\n1 2 3 4 5 6 7 8 server { listen 80; server_name localhost; location /{ proxy_pass http://devket:8000; } } 4. docker-compose.yml 생성 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 version: \"3\" services: devket: build: ./devket container_name: devket restart: always expose: - \"8000\" devket-nginx: build: ./nginx container_name: devket-nginx restart: always ports: - \"80:80\" depends_on: - devket ❗️ 502 Bad Gateway docker logs 로 nginx와 django app을 확인해보자.\ndjango error 1 python: can't open file '/usr/src/app/devket/Devket/manage.py': [Errno 2] No such file or directory nginx error 1 nginx: [emerg] host not found in upstream \"devket\" in /etc/nginx/conf.d/default.conf:6 위 두 에러 모두 django Dockerfile의 WORKDIR을 수정하여 해결했다.\n5. RDS 생성 및 연결 RDS 생성 시 설정 세팅은 RDS 연결하기를 참고하여 진행했다.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 # config/settings.py DATABASES = { \"default\": { \"ENGINE\": \"django.db.backends.postgresql_psycopg2\", # 아래는 예시일 뿐, 리스트말고 문자열로 입력한다. “HOST\": [RDS 엔드포인트], \"NAME\": [DB 이름], \"PORT\": \"5432\", \"USER\": [마스터 사용자 이름], \"PASSWORD\": [비밀번호], } } RDS endpoint 는 연결 \u0026 보안에서 확인 가능 DB 이름, 마스터 사용자 이름은 구성에서 확인 가능 🔆 super user가 생성가능하면 DB 연결이 된 것이다.\n❗️ RDS 생성할 때 DB 이름의 기본값 RDS 생성 시, 추가사항 탭 클릭하여 DB 이름을 설정하지 않았다면 기본값으로 ‘postgres’가 입력된다.\nDB를 하나만 사용하고 있는 상황에서는 반드시 DB 이름을 입력할 필요는 없다고 판단되나, 프로젝트의 첫 배포 과정으로서 DB에 이름을 부여하고 싶어 입력했다.\n6. S3 연결하기 S3에 연결하기 전에 이전에 학습해던 3가지 방식을 다 사용하면서 왜 S3를 사용하는지 되새겨본다.\n6.1 첫 번째 방법: ’location /static/’ 추가 문제점: admin에 적용되는 css를 확인할 수 없다.\n1 2 3 4 5 6 # 경로: nginx의 default.conf # 추가할 파일 내용 location /static/ { alias /devket/static/; } 6.2 두 번째 방법: collectstatic - 장점: 첫 번째 방법에 대한 문제점 해결\n- 문제점: 프로젝트 내부에 정적 파일들을 모아놓기 때문에, 서버 부하를 피할 수 없다.\npython manage.py collectstatic 명령어를 사용하여 모든 static 파일들을 public directory 안에 모으기 위해서 location 설정을 바꾼다.\nsettings.py 설정 변경\n1 2 3 4 5 6 7 8 9 # 경로: cofig/settings.py # 추가할 파일 내용 # STATIC STATIC_URL = \"/static/\" STATICFILES_DIRS = [BASE_DIR / \"static\"] # 위에 두 줄은 이미 입력되어 있기 때문에, 밑에 한 줄만 입력한다. STATIC_ROOT = os.path.join(BASE_DIR, \"public\") python manage.py collectstatic 실행: public 폴더 생김\n먼저 docker compose up -d --build를 실행하여 변경사항이 반영된 container를 실행한다. django 명령어를 입력할 때는 해당 image에 접속하여 입력하면 된다. nginx/default.conf 설정 변경\n1 2 3 4 5 6 # 경로: nginx의 default.conf # 추가할 파일 내용 location /static/ { alias /devket/public/; } 6.3 세 번째 방법: S3에 연결하기 admin에 적용되는 css도 확인할 수 있으면서, 내부가 아닌 외부 AWS S3에 모아놓은 정적 파일들을 올려서 서버 부하를 분산시키기 때문에 이 방식을 최종적으로 선택한다.\n6.3.1 AWS S3 bucket 생성하기 bucket 명: devket 객체 소유권: ACL 활성화 + 객체 소유권: 객체 라이터 퍼블릭 액세스 차단 설정 6.3.2 AWS IAM을 사용하는 이유 IAM 역할을 사용하면 일반적으로 조직의 AWS 리소스에 대한 액세스 권한이 없는 사용자나 서비스에 액세스 권한을 위임할 수 있습니다. … 그러면 애플리케이션이 이러한 자격 증명을 사용해 Amazon S3 버킷 또는 Amazon DynamoDB 데이터 등의 리소스에 액세스할 수 있습니다.\n출처: AWS - manage-roles\nAWS S3 bucket을 데이터 저장소로 사용한다면 IAM을 사용해서 액세스 권한을 위임받아야한다는 내용이므로, 반드시 IAM을 사용해야 한다.\n6.3.3 AWS IAM에서 다운 받은 key를 settings.py에 반영하기 이 링크를 따라서 생성한다.\n하지만, config/settings.py 에 추가되는 설정은 아래 코드를 사용한다. 기존에는 KEY가 오픈되었지만, get_secret()을 사용하여 드러나지 않도록 했다.\nsecret.json 에도 추가하도록 한다.\n1 2 3 4 5 6 7 8 AWS_ACCESS_KEY_ID = get_secret(\"AWS_ACCESS_KEY_ID\") AWS_SECRET_ACCESS_KEY = get_secret(\"AWS_SECRET_ACCESS_KEY\") AWS_REGION = \"ap-northeast-2\" AWS_STORAGE_BUCKET_NAME = \"devket\" AWS_S3_CUSTOM_DOMAIN = f\"{AWS_STORAGE_BUCKET_NAME}.s3.{AWS_REGION}.amazonaws.com\" AWS_DEFAULT_ACL = \"public-read\" DEFAULT_FILE_STORAGE = \"config.storages.S3DefaultStorage\" STATICFILES_STORAGE = \"config.storages.S3StaticStorage\" 6.3.4 config/storages.py 추가하기 1 2 3 4 5 6 7 from storages.backends.s3boto3 import S3Boto3Storage class S3DefaultStorage(S3Boto3Storage): location = \"media\" class S3StaticStorage(S3Boto3Storage): location = \"static\" 6.3.5 현재 과정에서 file directory 구조 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 # ~/deployment ./ ├── devket │ ├── Dockerfile │ ├── Devket │ │ ├── config │ │ │ ├── __init__.py │ │ │ ├── asgi.py │ │ │ ├── settings.py │ │ │ ├── storages.py │ │ │ ├── urls.py │ │ │ └── wsgi.py │ │ ├── manage.py │ │ ├── pocket │ │ ├── static │ │ │ ├── css │ │ │ ├── images │ │ │ └── js │ │ └── templates │ └── requirements.txt ├── docker-compose.yml └── nginx ├── Dockerfile └── default.conf 6.3.6 static file들을 S3로 옮기기:`python manage.py collectstatic ❗️python manage.py collectstatic 시 발생된 Error\n첫 번째 Error : botocore.errorfactory.NoSuchBucket: An error occurred (NoSuchBucket) when calling the PutObject operation: The specified bucket does not exist\n지정한 bucket이 존재하지 않는다는 의미다. S3의 bucket name이 storages.py의 BUCKET_NAME과 동일한지 비교한다. 두 번째 Error : botocore.exceptions.ClientError: An error occurred (AccessControlListNotSupported) when calling the PutObject operation: The bucket does not allow ACLs\nbucket 인식문제는 해결되었지만, 이 문제가 새롭게 발생했다. bucket 생성 시, 아래 설정대로 했는지 확인해보자. 6.3.7 nginx의 location url로 경로 바꾸기 이 단계까지 수행하면 css file들이 AWS S3 bucket으로 연결되지 않은 걸 확인할 수 있다. 그래서 nginx의 default.conf 설정을 수정해야한다. 생성한 bucket에 들어가서 새로고침을 하면 static/이 생긴 걸 확인할 수 있다. 이를 선택하면 URL 복사가 활성화되는데, 이 버튼으로 복사해서 alias 옆 경로를 붙여넣는다. 1 2 3 location /static/ { alias https://devket.s3.ap-northeast-2.amazonaws.com/static/; } ❗️Error: Django amazon S3 SuspiciousOperation 위 nginx의 location url 경로를 수정해도 이와 같은 error가 발생했다.\ndjango S3 연결 SuspiciousOperation을 검색하니 아래와 같은 문서가 떴다.\n읽어보면 해결 방법은 총 3가지다.\n첫 번째 방법은 storages.py 의 class 내용을 수정하는 방식 두 번째 방법은 static tag 뒤에 파일 경로의 시작 부분 /를 삭제하는 방식 세 번째 방법은 img의 src에 static template tag를 사용하는 방식 기존에 알고 있던 django template tag를 사용하는 방식이 보다 django 를 잘 활용하는 개발 방식이라 판단하여 세 번째 방식을 선택했다. 그래서 img src에도 django template tag를 적용했다.\n그 전에는 이를 적용하지 않았던 이유는 django static template tag를 head tag 안에 import 시에만 사용하고, body 안에는 사용한다는 생각을 못 했기 때문이다.\n위 방식을 알아낸 것은 아래 문서를 통해서 인지했다.\n출처: Django amazon s3 SuspiciousOperation\nS3 CORS issue S3 CORS issue는 해당 링크 Project: deployment issue - S3 CORS를 참고한다.\n7. Django image size 줄이기: slim docker image ls로 확인한 결과 django image의 size는 다음과 같다.\n1 2 REPOSITORY TAG IMAGE ID CREATED SIZE deployment-devket latest 059f304f1f5d 11 minutes ago 1.09GB 1GB를 넘기 때문에 이를 줄이고자 python 버전을 slim으로 다운받아서 비교해본다.\n현재 django Dockerfile에서 FROM python:3.10.8으로 python 설치를 시작하지만, FROM python:3.10.8-slim으로 수정했다.\ndocker compose build를 실행한 결과, 설치 실패가 떴다.\n에러 내용은 다음과 같다.\n1 2 3 4 5 6 7 Error: pg_config executable not found. pg_config is required to build psycopg2 from source. Please add the directory containing pg_config to the $PATH or specify the full executable path with the option: python setup.py build_ext --pg-config /path/to/pg_config build ... or with the pg_config option in 'setup.cfg' stackoverflow - pg_config executable not found에 모든 답변을 따라서 시도했지만 계속해서 같은 오류가 떴다. 그래서 pip install psycopg2-binary=2.9.5을 설치하기로 한다.\npsycopg2 와 psycopg2-binary의 차이는 다음 글을 참고했다.\n먼저 공식문서 psycopg2 vs psycopg2-binary와 what is the different about psycopg2 and psycopg2-binary python package 를 참고했다. docker image ls로 확인해보면 다음과 같은 크기로 줄어들었다.\n1 2 REPOSITORY TAG IMAGE ID CREATED SIZE deployment-devket latest 2c0746fca459 2 minutes ago 308MB 동일한 기능을 낸다면 가벼운 것과 상대적으로 무거운 것 중 가벼운 것으로 가는 방향이 cost가 덜 나가기 때문에 size를 줄이는 방향을 선택했다.\nReference WSGI의 종류 python개발자 uWSGI를 버리고 gunicorn으로 갈아타다. boto3를 사용하는 이유 django-storages를 설치하는 이유 docs.docker - CMD Where to run collectstatic when deploying django app…using Docker RDS 연결하기 staticfiles 연결 3가지 방식 AWS IAM에서 다운 받은 key를 settings.py에 반영하기 Django amazon s3 SuspiciousOperation AWS - manage-roles stackoverflow - pg_config executable not found psycopg2 vs psycopg2-binary what is the different about psycopg2 and psycopg2-binary python package ","wordCount":"2022","inLanguage":"en","datePublished":"2022-12-08T14:43:44+09:00","dateModified":"2022-12-08T14:43:44+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://jeha00.github.io/post/project/devket/deployment/01_deployment/"},"publisher":{"@type":"Organization","name":"Jeha DevLog","logo":{"@type":"ImageObject","url":"http://jeha00.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://jeha00.github.io/ accesskey=h title="@Jeha00 (Alt + H)">@Jeha00</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=http://jeha00.github.io/me/ title=About><span>About</span></a></li><li><a href=http://jeha00.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=http://jeha00.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=http://jeha00.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://jeha00.github.io/>Home</a>&nbsp;»&nbsp;<a href=http://jeha00.github.io/post/>Posts</a></div><h1 class=post-title>Project: Docker를 사용하여 django app 배포하기</h1><div class=post-meta><span title='2022-12-08 14:43:44 +0900 KST'>December 8, 2022</span>&nbsp;|&nbsp;<a href=https://github.com/JeHa00/blog/content/post/Project/Devket/Deployment/01_deployment.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#0-introduction aria-label="0. Introduction">0. Introduction</a><ul><ul><li><a href=#%eb%b0%b0%ed%8f%ac-%ec%9e%91%ec%97%85-%ec%8b%9c%ec%9e%91 aria-label="배포 작업 시작">배포 작업 시작</a></li><li><a href=#%eb%b0%b0%ed%8f%ac-%ea%b4%80%eb%a0%a8-%ec%9d%b4%ec%a0%84-%ed%95%99%ec%8a%b5-%eb%82%b4%ec%9a%a9%eb%93%a4 aria-label="배포 관련 이전 학습 내용들">배포 관련 이전 학습 내용들</a></li><li><a href=#%ec%9c%84-%eb%82%b4%ec%9a%a9%ec%9d%84-%eb%b0%94%ed%83%95%ec%9c%bc%eb%a1%9c-%ea%b5%ac%ec%84%b1%ed%95%9c-%eb%b0%b0%ed%8f%ac-%ea%b5%ac%ec%a1%b0 aria-label="위 내용을 바탕으로 구성한 배포 구조">위 내용을 바탕으로 구성한 배포 구조</a></li><li><a href=#uwsgi%ec%99%80-gunicorn-%ec%a4%91-%ed%9b%84%ec%9e%90%eb%a5%bc-%ed%83%9d%ed%95%9c-%ec%9d%b4%ec%9c%a0 aria-label="uWSGI와 gunicorn 중 후자를 택한 이유">uWSGI와 gunicorn 중 후자를 택한 이유</a></li><li><a href=#root-%ea%b3%84%ec%a0%95%ec%9c%bc%eb%a1%9c-%ed%95%98%ec%a7%80-%ec%95%8a%ea%b8%b0 aria-label="root 계정으로 하지 않기">root 계정으로 하지 않기</a></li></ul></ul></li><li><a href=#1-git-clone-%eb%b0%8f-file-directory-%ea%b5%ac%ec%a1%b0 aria-label="1. git clone 및 file directory 구조">1. git clone 및 file directory 구조</a><ul><ul><li><a href=#git-clone-%ed%95%98%ec%97%ac-%ea%b0%80%ec%a0%b8%ec%98%a4%ea%b8%b0 aria-label="git clone 하여 가져오기">git clone 하여 가져오기</a></li><li><a href=#file-directory aria-label="file directory">file directory</a></li></ul></ul></li><li><a href=#2-dockerfile-%ec%83%9d%ec%84%b1 aria-label="2. Dockerfile 생성">2. Dockerfile 생성</a><ul><li><a href=#21-django-appdevket-dockerfile aria-label="2.1 django app(devket) Dockerfile">2.1 django app(devket) Dockerfile</a><ul><li><a href=#-eoferror aria-label="❗️ EOFError">❗️ EOFError</a></li></ul></li><li><a href=#22-django-app-dockerfile-version-%ec%9e%85%eb%a0%a5 aria-label="2.2 django app Dockerfile version 입력">2.2 django app Dockerfile version 입력</a></li><li><a href=#23-nginx-dockerfile aria-label="2.3 nginx Dockerfile">2.3 nginx Dockerfile</a></li></ul></li><li><a href=#3-nginx%ec%9d%98-defaultconf aria-label="3. nginx의 default.conf">3. nginx의 default.conf</a></li><li><a href=#4-docker-composeyml-%ec%83%9d%ec%84%b1 aria-label="4. docker-compose.yml 생성">4. docker-compose.yml 생성</a><ul><ul><li><a href=#-502-bad-gateway aria-label="❗️ 502 Bad Gateway">❗️ 502 Bad Gateway</a></li></ul></ul></li><li><a href=#5-rds-%ec%83%9d%ec%84%b1-%eb%b0%8f-%ec%97%b0%ea%b2%b0 aria-label="5. RDS 생성 및 연결">5. RDS 생성 및 연결</a><ul><ul><li><a href=#-rds-%ec%83%9d%ec%84%b1%ed%95%a0-%eb%95%8c-db-%ec%9d%b4%eb%a6%84%ec%9d%98-%ea%b8%b0%eb%b3%b8%ea%b0%92 aria-label="❗️ RDS 생성할 때 DB 이름의 기본값">❗️ RDS 생성할 때 DB 이름의 기본값</a></li></ul></ul></li><li><a href=#6-s3-%ec%97%b0%ea%b2%b0%ed%95%98%ea%b8%b0 aria-label="6. S3 연결하기">6. S3 연결하기</a><ul><li><a href=#61-%ec%b2%ab-%eb%b2%88%ec%a7%b8-%eb%b0%a9%eb%b2%95-location-static-%ec%b6%94%ea%b0%80 aria-label="6.1 첫 번째 방법: ’location /static/’ 추가">6.1 첫 번째 방법: ’location /static/’ 추가</a></li><li><a href=#62-%eb%91%90-%eb%b2%88%ec%a7%b8-%eb%b0%a9%eb%b2%95-collectstatic aria-label="6.2 두 번째 방법: collectstatic">6.2 두 번째 방법: collectstatic</a></li><li><a href=#63-%ec%84%b8-%eb%b2%88%ec%a7%b8-%eb%b0%a9%eb%b2%95-s3%ec%97%90-%ec%97%b0%ea%b2%b0%ed%95%98%ea%b8%b0 aria-label="6.3 세 번째 방법: S3에 연결하기">6.3 세 번째 방법: S3에 연결하기</a><ul><li><a href=#631-aws-s3-bucket-%ec%83%9d%ec%84%b1%ed%95%98%ea%b8%b0 aria-label="6.3.1 AWS S3 bucket 생성하기">6.3.1 AWS S3 bucket 생성하기</a></li><li><a href=#632-aws-iam%ec%9d%84-%ec%82%ac%ec%9a%a9%ed%95%98%eb%8a%94-%ec%9d%b4%ec%9c%a0 aria-label="6.3.2 AWS IAM을 사용하는 이유">6.3.2 AWS IAM을 사용하는 이유</a></li><li><a href=#633-aws-iam%ec%97%90%ec%84%9c-%eb%8b%a4%ec%9a%b4-%eb%b0%9b%ec%9d%80-key%eb%a5%bc-settingspy%ec%97%90-%eb%b0%98%ec%98%81%ed%95%98%ea%b8%b0 aria-label="6.3.3 AWS IAM에서 다운 받은 key를 settings.py에 반영하기">6.3.3 AWS IAM에서 다운 받은 key를 settings.py에 반영하기</a></li><li><a href=#634-configstoragespy-%ec%b6%94%ea%b0%80%ed%95%98%ea%b8%b0 aria-label="6.3.4 config/storages.py 추가하기">6.3.4 config/storages.py 추가하기</a></li><li><a href=#635-%ed%98%84%ec%9e%ac-%ea%b3%bc%ec%a0%95%ec%97%90%ec%84%9c-file-directory-%ea%b5%ac%ec%a1%b0 aria-label="6.3.5 현재 과정에서 file directory 구조">6.3.5 현재 과정에서 file directory 구조</a></li><li><a href=#636-static-file%eb%93%a4%ec%9d%84-s3%eb%a1%9c-%ec%98%ae%ea%b8%b0%ea%b8%b0python-managepy-collectstatic aria-label="6.3.6 static file들을 S3로 옮기기:`python manage.py collectstatic">6.3.6 static file들을 S3로 옮기기:`python manage.py collectstatic</a></li><li><a href=#637-nginx%ec%9d%98-location-url%eb%a1%9c-%ea%b2%bd%eb%a1%9c-%eb%b0%94%ea%be%b8%ea%b8%b0 aria-label="6.3.7 nginx의 location url로 경로 바꾸기">6.3.7 nginx의 location url로 경로 바꾸기</a></li><li><a href=#error-django-amazon-s3-suspiciousoperation aria-label="❗️Error: Django amazon S3 SuspiciousOperation">❗️Error: Django amazon S3 SuspiciousOperation</a></li><li><a href=#s3-cors-issue aria-label="S3 CORS issue">S3 CORS issue</a></li></ul></li></ul></li><li><a href=#7-django-image-size-%ec%a4%84%ec%9d%b4%ea%b8%b0-slim aria-label="7. Django image size 줄이기: slim">7. Django image size 줄이기: slim</a></li><li><a href=#reference aria-label=Reference>Reference</a></li></ul></div></details></div><div class=post-content><h1 id=0-introduction>0. Introduction<a hidden class=anchor aria-hidden=true href=#0-introduction>#</a></h1><p>이 repository는 현재 <a href=https://learningspoons.com/course/detail/django-backend/>러닝스푼즈 나노디그리 - django backend 부트캠프</a>에서 팀 프로젝트를 진행하면서 다음과 같은 내용들에 대해 정리하고자 만들었습니다.</p><ul><li>팀 정책을 이것으로 정한 이유</li><li>개발하면서 부딪힌 문제들에 대한 원인, 해결방안, 해결과정, 그리고 그 이유들</li></ul><h3 id=배포-작업-시작>배포 작업 시작<a hidden class=anchor aria-hidden=true href=#배포-작업-시작>#</a></h3><p>1차적으로 구현한 기능을 마치고, Docker 내용을 복습한 후 배포 작업을 시작했다. 배포 작업 순서, 에러, 해결방안, 그리고 여러 이유들에 대해 정리해본다.</p><h3 id=배포-관련-이전-학습-내용들>배포 관련 이전 학습 내용들<a hidden class=anchor aria-hidden=true href=#배포-관련-이전-학습-내용들>#</a></h3><p>배포에 관련해서 배운 내용은 다음과 같다.</p><ul><li>django live 강의에서는 docker를 사용하지 않고, AWS EC2 서버에서 nginx, uwsgi와 django app을 연결 후, AWS RDS, IAM, S3와 연결하여 배포했다.</li><li>Docker 강의에서는 AWS EC2 서버에서 Docker container만을 사용하여 nginx, gunicorn, django app, postgreSQL image들을 사용하여 배포했다.</li></ul><h3 id=위-내용을-바탕으로-구성한-배포-구조>위 내용을 바탕으로 구성한 배포 구조<a hidden class=anchor aria-hidden=true href=#위-내용을-바탕으로-구성한-배포-구조>#</a></h3><p>그래서 이번 프로젝트 배포에서는 django live 강의 마지막에 학습한 배포와 docker 강의에서 학습한 docker를 활용한 배포 내용을 정리한 것을 보고 합하여 진행해본다.</p><ul><li>AWS EC2 서버에 docker-compose를 사용하여 nginx, django의 각 custom image를 만든다. django app에는 AWS RDS(postgreSQL), IAM, S3 연결 세팅을 해놓은 후 build 실행한다.</li></ul><h3 id=uwsgi와-gunicorn-중-후자를-택한-이유>uWSGI와 gunicorn 중 후자를 택한 이유<a hidden class=anchor aria-hidden=true href=#uwsgi와-gunicorn-중-후자를-택한-이유>#</a></h3><p>uWSGI 와 gunicorn 중 gunicorn을 선택했다.</p><p>지난 강의 때 들었던 내용을 정리한 <a href=https://jeha00.github.io/post/network/webapplicationbasic01/#wsgi%EC%9D%98-%EC%A2%85%EB%A5%98>WSGI의 종류</a>를 참고하면 gnicorn은 입문자가 사용하기에 편리하고, 성능을 내는 데에는 uWSGI가 좋다고 판단했다.</p><p>하지만, 이외의 여러 블로그 의견들을 취합했고 많은 공통된 의견들을 발견했다.</p><p>한 예로 <a href=https://discord.com/channels/1018414416510861382/1031916397137231955/1051371601402265671>python개발자 uWSGI를 버리고 gunicorn으로 갈아타다.</a>을 근거로 전달하자면 uWSGI는 다른 WSGI에 비해서 무거워 자원 소모가 큰 문제점이 있다.</p><p>하지만, gunicorn은 가볍고 큰 프로젝트가 아닌 경우 uWSGI보다 빠른 성능을 낸다는 장점이 있다.</p><p>현재 프로젝트는 규모가 크지 않아서 uWSGI보다는 gunicorn을 사용하는 것이 적절하다고 판단했다.</p><h3 id=root-계정으로-하지-않기>root 계정으로 하지 않기<a hidden class=anchor aria-hidden=true href=#root-계정으로-하지-않기>#</a></h3><p>root 계정으로 배포를 하게 되면 일반 user는 로그인하지 못하기 때문이다.</p><p> </p><hr><h1 id=1-git-clone-및-file-directory-구조>1. git clone 및 file directory 구조<a hidden class=anchor aria-hidden=true href=#1-git-clone-및-file-directory-구조>#</a></h1><h3 id=git-clone-하여-가져오기>git clone 하여 가져오기<a hidden class=anchor aria-hidden=true href=#git-clone-하여-가져오기>#</a></h3><p><code>~/development/devket</code> directory를 생성하여 git clone으로 가져온다.</p><p>이에 따라 requirements.txt를 docker compose를 실행하기 위해서 위치를 바꾼다. <code>Devket</code> 안이 아니라 <code>Dockerfile</code>과 동일한 레벨로 옮긴다.</p><h3 id=file-directory>file directory<a hidden class=anchor aria-hidden=true href=#file-directory>#</a></h3><p>익숙하지 않아서 먼저 구조를 잡기 위해 파일들을 생성했다.</p><p>아래 파일 구조를 출력하기 위해 <code>sudo apt-get install tree</code>을 설치한 후, <code>tree ./</code>을 입력한다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#6272a4># ~/deployment</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./
</span></span><span style=display:flex><span>├── devket
</span></span><span style=display:flex><span>│   ├── Devket
</span></span><span style=display:flex><span>│   │   ├── config
</span></span><span style=display:flex><span>│   │   ├── manage.py
</span></span><span style=display:flex><span>│   │   ├── pocket
</span></span><span style=display:flex><span>│   │   ├── static
</span></span><span style=display:flex><span>│   │   │   ├── css
</span></span><span style=display:flex><span>│   │   │   └── js
</span></span><span style=display:flex><span>│   │   └── templates
</span></span><span style=display:flex><span>│   ├── Dockerfile
</span></span><span style=display:flex><span>│   └── requirements.txt
</span></span><span style=display:flex><span>├── docker-compose.yml
</span></span><span style=display:flex><span>└── nginx
</span></span><span style=display:flex><span>    ├── Dockerfile
</span></span><span style=display:flex><span>    └── default.conf
</span></span></code></pre></td></tr></table></div></div><p> </p><hr><h1 id=2-dockerfile-생성>2. Dockerfile 생성<a hidden class=anchor aria-hidden=true href=#2-dockerfile-생성>#</a></h1><h2 id=21-django-appdevket-dockerfile>2.1 django app(devket) Dockerfile<a hidden class=anchor aria-hidden=true href=#21-django-appdevket-dockerfile>#</a></h2><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>FROM python:3.10.8
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>WORKDIR /usr/src/app
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>COPY . .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUN python -m pip install --upgrade pip \
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>&amp;&amp;</span> pip install -r requirements.txt \
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>&amp;&amp;</span> pip install boto3 \
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>&amp;&amp;</span> pip install django-storages \
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>&amp;&amp;</span> pip install gunicorn
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># git</span>
</span></span><span style=display:flex><span>WORKDIR ./Devket
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUN python manage.py collectstatic --noinput
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CMD sh -c &#34;python manage.py makemigrations \
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&amp;&amp;</span> python manage.py migrate \
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>&amp;&amp;</span> python manage.py runserver 0:8000&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CMD gunicorn config.wsgi:application --bind 0:8000
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>EXPOSE 8000
</span></span></code></pre></td></tr></table></div></div><ul><li><a href=https://boto3.amazonaws.com/v1/documentation/api/latest/index.html#boto3-documentation>boto3를 사용하는 이유</a>: 파이썬 언어를 사용하여 EC2, S3 같은 AWS 서비스를 구성하고 관리하려면 boto3를 사용해야 한다.</li><li><a href=https://django-storages.readthedocs.io/en/latest/>django-storages를 설치하는 이유</a>: 장고 프로젝트가 특정 storage를 사용하기 위해서 설치한다.</li><li><a href=https://docs.docker.com/engine/reference/builder/#cmd>docs.docker - CMD</a><ul><li>위 문서에 따르면 기본 명령어 형식으로 CMD는 여러 개를 입력할 수 없다. 그래서 shell에 입력하듯이 하는 방식으로 CMD를 입력했다.</li></ul></li></ul><h3 id=-eoferror>❗️ EOFError<a hidden class=anchor aria-hidden=true href=#-eoferror>#</a></h3><p><code>python manage.py collecstatic</code>은 input 값을 기본적으로 필요로 하는 명령어다.</p><p>오랫동안 입력값이 없으면 EOFError가 발생한다. 그래서 옵션으로 <code>--noinput</code>을 하면 input 값을 기다렸다가 yes로 자동적으로 입력되어 진행된다.</p><p>Dockerfile이 진행되는 동안 입력값을 받지 못하고, 처음 image build 시 collectstatic을 반드시 실행해야하기 때문에 이 옵션을 사용했다.</p><ul><li>출처: <a href=https://stackoverflow.com/questions/59719175/where-to-run-collectstatic-when-deploying-django-app-to-heroku-using-docker>Where to run collectstatic when deploying django app&mldr;using Docker</a></li></ul><p> </p><h2 id=22-django-app-dockerfile-version-입력>2.2 django app Dockerfile version 입력<a hidden class=anchor aria-hidden=true href=#22-django-app-dockerfile-version-입력>#</a></h2><p>위 Dockerfile에서 다음 명령어를 삭제 또는 수정하기로 했다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#ff79c6>&amp;&amp;</span> pip install boto3 \
</span></span><span style=display:flex><span><span style=color:#ff79c6>&amp;&amp;</span> pip install django-storages \
</span></span><span style=display:flex><span><span style=color:#ff79c6>&amp;&amp;</span> pip install gunicorn 
</span></span></code></pre></td></tr></table></div></div><p>왜냐하면 정확한 버전이 적혀있지 않아서 설치할 때 최신 버전을 설치하게 되는데, 이런 방식으로 설치하는 건 지금은 문제가 없을 수 있다.</p><p>하지만, <strong>그 당시 최신 버전에서 작동되었던 코드들이 업데이트 되면서 작동되지 않을 수 있기 때문이다.</strong></p><p>그래서 <strong>삭제 후, requirements.txt에 버전 명과 함께 구체적으로 입력한다.</strong></p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>...
</span></span><span style=display:flex><span>boto3==1.26.27
</span></span><span style=display:flex><span>django-storages==1.13.1
</span></span><span style=display:flex><span>gunicorn==20.1.0 
</span></span><span style=display:flex><span>...
</span></span></code></pre></td></tr></table></div></div><p>또는 위 명령어를 삭제하지 않고, 아래와 같이 정확한 버전 명을 입력하는 것도 또 하나의 방법이다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#ff79c6>&amp;&amp;</span> pip install boto3==1.26.27 \
</span></span><span style=display:flex><span><span style=color:#ff79c6>&amp;&amp;</span> pip install django-storages==1.13.1 \
</span></span><span style=display:flex><span><span style=color:#ff79c6>&amp;&amp;</span> pip install gunicorn==20.1.0
</span></span></code></pre></td></tr></table></div></div><p> </p><h2 id=23-nginx-dockerfile>2.3 nginx Dockerfile<a hidden class=anchor aria-hidden=true href=#23-nginx-dockerfile>#</a></h2><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>FROM nginx
</span></span><span style=display:flex><span>RUN rm /etc/nginx/conf.d/default.conf
</span></span><span style=display:flex><span>COPY default.conf /etc/nginx/conf.d
</span></span><span style=display:flex><span>CMD [&#34;nginx&#34;, &#34;-g&#34;, &#34;daemon off;&#34;]
</span></span></code></pre></td></tr></table></div></div><p> </p><hr><h1 id=3-nginx의-defaultconf>3. nginx의 default.conf<a hidden class=anchor aria-hidden=true href=#3-nginx의-defaultconf>#</a></h1><ul><li><p>80 port로 트래픽을 받아서 web application에 전달한다.</p></li><li><p>proxy_pass에서 devket은</p></li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>server {
</span></span><span style=display:flex><span>	listen 80;
</span></span><span style=display:flex><span>	server_name localhost;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	location /{
</span></span><span style=display:flex><span>		proxy_pass http://devket:8000;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p> </p><hr><h1 id=4-docker-composeyml-생성>4. docker-compose.yml 생성<a hidden class=anchor aria-hidden=true href=#4-docker-composeyml-생성>#</a></h1><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#ff79c6>version</span>: <span style=color:#f1fa8c>&#34;3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>services</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>devket</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>build</span>: ./devket
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>container_name</span>: devket
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>restart</span>: always
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>expose</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f1fa8c>&#34;8000&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>devket-nginx</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>build</span>: ./nginx
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>container_name</span>: devket-nginx
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>restart</span>: always
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f1fa8c>&#34;80:80&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>depends_on</span>:
</span></span><span style=display:flex><span>        - devket
</span></span></code></pre></td></tr></table></div></div><h3 id=-502-bad-gateway>❗️ 502 Bad Gateway<a hidden class=anchor aria-hidden=true href=#-502-bad-gateway>#</a></h3><p><code>docker logs &lt;container id></code> 로 nginx와 django app을 확인해보자.</p><ul><li>django error</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#ff79c6>python: can&#39;t open file &#39;/usr/src/app/devket/Devket/manage.py&#39;</span>: [Errno 2] No such file or directory
</span></span></code></pre></td></tr></table></div></div><ul><li>nginx error</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#ff79c6>nginx</span>: [emerg] host not found in upstream &#34;devket&#34; in /etc/nginx/conf.d/default.conf:6 
</span></span></code></pre></td></tr></table></div></div><p>위 두 에러 모두 django Dockerfile의 WORKDIR을 수정하여 해결했다.</p><p> </p><hr><h1 id=5-rds-생성-및-연결>5. RDS 생성 및 연결<a hidden class=anchor aria-hidden=true href=#5-rds-생성-및-연결>#</a></h1><p>RDS 생성 시 설정 세팅은 <a href=https://jeha00.github.io/post/django/deployment-with-nginx-uwsgi-ec2_3/#2-rds-%EC%97%B0%EA%B2%B0%ED%95%98%EA%B8%B0>RDS 연결하기</a>를 참고하여 진행했다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#6272a4># config/settings.py</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DATABASES <span style=color:#ff79c6>=</span> { 
</span></span><span style=display:flex><span>    <span style=color:#f1fa8c>&#34;default&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;ENGINE&#34;</span>: <span style=color:#f1fa8c>&#34;django.db.backends.postgresql_psycopg2&#34;</span>,     
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4># 아래는 예시일 뿐, 리스트말고 문자열로 입력한다.</span>
</span></span><span style=display:flex><span>            “HOST<span style=color:#f1fa8c>&#34;: [RDS 엔드포인트],</span>
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;NAME&#34;</span>: [DB 이름], 
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;PORT&#34;</span>: <span style=color:#f1fa8c>&#34;5432&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;USER&#34;</span>: [마스터 사용자 이름],
</span></span><span style=display:flex><span>            <span style=color:#f1fa8c>&#34;PASSWORD&#34;</span>: [비밀번호], 
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>RDS endpoint 는 <code>연결 & 보안</code>에서 확인 가능</li><li>DB 이름, 마스터 사용자 이름은 <code>구성</code>에서 확인 가능</li></ul><p>🔆 <code>super user</code>가 생성가능하면 DB 연결이 된 것이다.</p><h3 id=-rds-생성할-때-db-이름의-기본값>❗️ RDS 생성할 때 DB 이름의 기본값<a hidden class=anchor aria-hidden=true href=#-rds-생성할-때-db-이름의-기본값>#</a></h3><p>RDS 생성 시, 추가사항 탭 클릭하여 DB 이름을 설정하지 않았다면 기본값으로 &lsquo;postgres&rsquo;가 입력된다.</p><p>DB를 하나만 사용하고 있는 상황에서는 반드시 DB 이름을 입력할 필요는 없다고 판단되나, 프로젝트의 첫 배포 과정으로서 DB에 이름을 부여하고 싶어 입력했다.</p><p> </p><hr><h1 id=6-s3-연결하기>6. S3 연결하기<a hidden class=anchor aria-hidden=true href=#6-s3-연결하기>#</a></h1><p>S3에 연결하기 전에 이전에 학습해던 <a href=https://jeha00.github.io/post/django/deployment-with-nginx-uwsgi-ec2_3/#1-static-file-serving>3가지 방식</a>을 다 사용하면서 왜 S3를 사용하는지 되새겨본다.</p><h2 id=61-첫-번째-방법-location-static-추가>6.1 첫 번째 방법: ’location /static/’ 추가<a hidden class=anchor aria-hidden=true href=#61-첫-번째-방법-location-static-추가>#</a></h2><blockquote><p><strong><em>문제점: admin에 적용되는 css를 확인할 수 없다.</em></strong></p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#6272a4># 경로: nginx의 default.conf</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 추가할 파일 내용</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>location /static/ { 
</span></span><span style=display:flex><span>        alias   /devket/static/;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p> </p><h2 id=62-두-번째-방법-collectstatic>6.2 두 번째 방법: collectstatic<a hidden class=anchor aria-hidden=true href=#62-두-번째-방법-collectstatic>#</a></h2><blockquote><p><strong><em>- 장점: 첫 번째 방법에 대한 문제점 해결</em></strong><br><strong><em>- 문제점: 프로젝트 내부에 정적 파일들을 모아놓기 때문에, 서버 부하를 피할 수 없다.</em></strong></p></blockquote><p><code>python manage.py collectstatic</code> 명령어를 사용하여 모든 static 파일들을 public directory 안에 모으기 위해서 location 설정을 바꾼다.</p><ul><li><p>settings.py 설정 변경</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#6272a4># 경로: cofig/settings.py</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 추가할 파일 내용</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># STATIC</span>
</span></span><span style=display:flex><span>STATIC_URL = &#34;/static/&#34;
</span></span><span style=display:flex><span>STATICFILES_DIRS = [BASE_DIR / &#34;static&#34;]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 위에 두 줄은 이미 입력되어 있기 때문에, 밑에 한 줄만 입력한다.</span>
</span></span><span style=display:flex><span>STATIC_ROOT = os.path.join(BASE_DIR, &#34;public&#34;)
</span></span></code></pre></td></tr></table></div></div></li><li><p><code>python manage.py collectstatic 실행</code>: public 폴더 생김</p><ul><li>먼저 <code>docker compose up -d --build</code>를 실행하여 변경사항이 반영된 container를 실행한다.</li><li>django 명령어를 입력할 때는 해당 image에 접속하여 입력하면 된다.</li></ul></li><li><p>nginx/default.conf 설정 변경</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#6272a4># 경로: nginx의 default.conf</span>
</span></span><span style=display:flex><span><span style=color:#6272a4># 추가할 파일 내용</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>location /static/ { 
</span></span><span style=display:flex><span>        alias   /devket/public/;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></li></ul><p> </p><h2 id=63-세-번째-방법-s3에-연결하기>6.3 세 번째 방법: S3에 연결하기<a hidden class=anchor aria-hidden=true href=#63-세-번째-방법-s3에-연결하기>#</a></h2><blockquote><p><strong><em>admin에 적용되는 css도 확인할 수 있으면서, 내부가 아닌 외부 AWS S3에 모아놓은 정적 파일들을 올려서 서버 부하를 분산시키기 때문에 이 방식을 최종적으로 선택한다.</em></strong></p></blockquote><h3 id=631-aws-s3-bucket-생성하기>6.3.1 AWS S3 bucket 생성하기<a hidden class=anchor aria-hidden=true href=#631-aws-s3-bucket-생성하기>#</a></h3><ul><li>bucket 명: devket</li><li>객체 소유권: ACL 활성화 + 객체 소유권: 객체 라이터</li><li>퍼블릭 액세스 차단 설정
<img loading=lazy src=https://user-images.githubusercontent.com/78094972/206662633-05848dcc-79ba-49f8-924a-97a6fa6103d5.png alt=image></li></ul><h3 id=632-aws-iam을-사용하는-이유>6.3.2 AWS IAM을 사용하는 이유<a hidden class=anchor aria-hidden=true href=#632-aws-iam을-사용하는-이유>#</a></h3><blockquote><p><em>IAM 역할을 사용하면 일반적으로 조직의 AWS 리소스에 대한 액세스 권한이 없는 사용자나 서비스에 액세스 권한을 위임할 수 있습니다. &mldr; 그러면 애플리케이션이 이러한 자격 증명을 사용해 Amazon S3 버킷 또는 Amazon DynamoDB 데이터 등의 리소스에 액세스할 수 있습니다.</em><br>출처: <a href=https://aws.amazon.com/ko/iam/details/manage-roles/>AWS - manage-roles</a></p></blockquote><p>AWS S3 bucket을 데이터 저장소로 사용한다면 IAM을 사용해서 액세스 권한을 위임받아야한다는 내용이므로, 반드시 IAM을 사용해야 한다.</p><h3 id=633-aws-iam에서-다운-받은-key를-settingspy에-반영하기>6.3.3 AWS IAM에서 다운 받은 key를 settings.py에 반영하기<a hidden class=anchor aria-hidden=true href=#633-aws-iam에서-다운-받은-key를-settingspy에-반영하기>#</a></h3><ul><li><p><a href=https://jeha00.github.io/post/django/deployment-with-nginx-uwsgi-ec2_3/#3-aws-iam%EC%97%90%EC%84%9C-%EB%8B%A4%EC%9A%B4-%EB%B0%9B%EC%9D%80-key%EB%A5%BC-settingspy%EC%97%90-%EB%B0%98%EC%98%81%ED%95%98%EA%B8%B0>이 링크</a>를 따라서 생성한다.</p></li><li><p>하지만, config/settings.py 에 추가되는 설정은 아래 코드를 사용한다. 기존에는 KEY가 오픈되었지만, <code>get_secret()</code>을 사용하여 드러나지 않도록 했다.</p></li><li><p><code>secret.json</code> 에도 추가하도록 한다.</p></li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>AWS_ACCESS_KEY_ID <span style=color:#ff79c6>=</span> get_secret(<span style=color:#f1fa8c>&#34;AWS_ACCESS_KEY_ID&#34;</span>)
</span></span><span style=display:flex><span>AWS_SECRET_ACCESS_KEY <span style=color:#ff79c6>=</span> get_secret(<span style=color:#f1fa8c>&#34;AWS_SECRET_ACCESS_KEY&#34;</span>)
</span></span><span style=display:flex><span>AWS_REGION <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;ap-northeast-2&#34;</span>
</span></span><span style=display:flex><span>AWS_STORAGE_BUCKET_NAME <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;devket&#34;</span>
</span></span><span style=display:flex><span>AWS_S3_CUSTOM_DOMAIN <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>f</span><span style=color:#f1fa8c>&#34;</span><span style=color:#f1fa8c>{</span>AWS_STORAGE_BUCKET_NAME<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>.s3.</span><span style=color:#f1fa8c>{</span>AWS_REGION<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>.amazonaws.com&#34;</span>
</span></span><span style=display:flex><span>AWS_DEFAULT_ACL <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;public-read&#34;</span>
</span></span><span style=display:flex><span>DEFAULT_FILE_STORAGE <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;config.storages.S3DefaultStorage&#34;</span>
</span></span><span style=display:flex><span>STATICFILES_STORAGE <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;config.storages.S3StaticStorage&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=634-configstoragespy-추가하기>6.3.4 config/storages.py 추가하기<a hidden class=anchor aria-hidden=true href=#634-configstoragespy-추가하기>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>from</span> storages.backends.s3boto3 <span style=color:#ff79c6>import</span> S3Boto3Storage
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>S3DefaultStorage</span>(S3Boto3Storage): 
</span></span><span style=display:flex><span>        location <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;media&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>S3StaticStorage</span>(S3Boto3Storage): 
</span></span><span style=display:flex><span>        location <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;static&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=635-현재-과정에서-file-directory-구조>6.3.5 현재 과정에서 file directory 구조<a hidden class=anchor aria-hidden=true href=#635-현재-과정에서-file-directory-구조>#</a></h3><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#6272a4># ~/deployment</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./
</span></span><span style=display:flex><span>├── devket
</span></span><span style=display:flex><span>│   ├── Dockerfile
</span></span><span style=display:flex><span>│   ├── Devket
</span></span><span style=display:flex><span>│   │   ├── config
</span></span><span style=display:flex><span>│   │   │   ├── __init__.py
</span></span><span style=display:flex><span>│   │   │   ├── asgi.py
</span></span><span style=display:flex><span>│   │   │   ├── settings.py
</span></span><span style=display:flex><span>│   │   │   ├── storages.py
</span></span><span style=display:flex><span>│   │   │   ├── urls.py
</span></span><span style=display:flex><span>│   │   │   └── wsgi.py
</span></span><span style=display:flex><span>│   │   ├── manage.py
</span></span><span style=display:flex><span>│   │   ├── pocket
</span></span><span style=display:flex><span>│   │   ├── static
</span></span><span style=display:flex><span>│   │   │   ├── css
</span></span><span style=display:flex><span>│   │   │   ├── images
</span></span><span style=display:flex><span>│   │   │   └── js
</span></span><span style=display:flex><span>│   │   └── templates
</span></span><span style=display:flex><span>│   └── requirements.txt
</span></span><span style=display:flex><span>├── docker-compose.yml
</span></span><span style=display:flex><span>└── nginx
</span></span><span style=display:flex><span>    ├── Dockerfile
</span></span><span style=display:flex><span>    └── default.conf
</span></span></code></pre></td></tr></table></div></div><h3 id=636-static-file들을-s3로-옮기기python-managepy-collectstatic>6.3.6 static file들을 S3로 옮기기:`python manage.py collectstatic<a hidden class=anchor aria-hidden=true href=#636-static-file들을-s3로-옮기기python-managepy-collectstatic>#</a></h3><p>❗️<strong>python manage.py collectstatic 시 발생된 Error</strong></p><ul><li><p><strong>첫 번째 Error</strong> : botocore.errorfactory.NoSuchBucket: An error occurred (NoSuchBucket) when calling the PutObject operation: The specified bucket does not exist</p><ul><li>지정한 bucket이 존재하지 않는다는 의미다. S3의 bucket name이 storages.py의 BUCKET_NAME과 동일한지 비교한다.</li></ul></li><li><p><strong>두 번째 Error</strong> : botocore.exceptions.ClientError: An error occurred (AccessControlListNotSupported) when calling the PutObject operation: The bucket does not allow ACLs</p><ul><li>bucket 인식문제는 해결되었지만, 이 문제가 새롭게 발생했다. bucket 생성 시, 아래 설정대로 했는지 확인해보자.</li><li><img loading=lazy src=https://user-images.githubusercontent.com/78094972/206662633-05848dcc-79ba-49f8-924a-97a6fa6103d5.png alt=image></li></ul></li></ul><h3 id=637-nginx의-location-url로-경로-바꾸기>6.3.7 nginx의 location url로 경로 바꾸기<a hidden class=anchor aria-hidden=true href=#637-nginx의-location-url로-경로-바꾸기>#</a></h3><ul><li>이 단계까지 수행하면 css file들이 AWS S3 bucket으로 연결되지 않은 걸 확인할 수 있다. 그래서 nginx의 default.conf 설정을 수정해야한다.</li><li>생성한 bucket에 들어가서 새로고침을 하면 <code>static/</code>이 생긴 걸 확인할 수 있다. 이를 선택하면 <code>URL 복사</code>가 활성화되는데, 이 버튼으로 복사해서 alias 옆 경로를 붙여넣는다.</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>location /static/ {
</span></span><span style=display:flex><span>                alias https://devket.s3.ap-northeast-2.amazonaws.com/static/;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p> </p><h3 id=error-django-amazon-s3-suspiciousoperation>❗️Error: Django amazon S3 SuspiciousOperation<a hidden class=anchor aria-hidden=true href=#error-django-amazon-s3-suspiciousoperation>#</a></h3><p>위 nginx의 location url 경로를 수정해도 이와 같은 error가 발생했다.</p><p><code>django S3 연결 SuspiciousOperation</code>을 검색하니 아래와 같은 문서가 떴다.</p><p>읽어보면 해결 방법은 총 3가지다.</p><ul><li>첫 번째 방법은 storages.py 의 class 내용을 수정하는 방식</li><li>두 번째 방법은 static tag 뒤에 파일 경로의 시작 부분 <code>/</code>를 삭제하는 방식</li><li>세 번째 방법은 img의 src에 static template tag를 사용하는 방식</li></ul><p>기존에 알고 있던 django template tag를 사용하는 방식이 보다 django 를 잘 활용하는 개발 방식이라 판단하여 세 번째 방식을 선택했다. 그래서 img src에도 django template tag를 적용했다.</p><p>그 전에는 이를 적용하지 않았던 이유는 django static template tag를 head tag 안에 import 시에만 사용하고, body 안에는 사용한다는 생각을 못 했기 때문이다.</p><p>위 방식을 알아낸 것은 아래 문서를 통해서 인지했다.</p><p>출처: <a href=https://stackoverflow.com/questions/25456420/django-amazon-s3-suspiciousoperation>Django amazon s3 SuspiciousOperation</a></p><p> </p><h3 id=s3-cors-issue>S3 CORS issue<a hidden class=anchor aria-hidden=true href=#s3-cors-issue>#</a></h3><p>S3 CORS issue는 해당 링크 <a href=https://jeha00.github.io/post/project/deployment/02_deployment_cors/>Project: deployment issue - S3 CORS</a>를 참고한다.</p><hr><h1 id=7-django-image-size-줄이기-slim>7. Django image size 줄이기: slim<a hidden class=anchor aria-hidden=true href=#7-django-image-size-줄이기-slim>#</a></h1><p><code>docker image ls</code>로 확인한 결과 django image의 size는 다음과 같다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>REPOSITORY                TAG       IMAGE ID       CREATED          SIZE
</span></span><span style=display:flex><span>deployment-devket         latest    059f304f1f5d   11 minutes ago   1.09GB
</span></span></code></pre></td></tr></table></div></div><p>1GB를 넘기 때문에 이를 줄이고자 python 버전을 slim으로 다운받아서 비교해본다.</p><p>현재 django Dockerfile에서 <code>FROM python:3.10.8</code>으로 python 설치를 시작하지만, <code>FROM python:3.10.8-slim</code>으로 수정했다.</p><p>docker compose build를 실행한 결과, 설치 실패가 떴다.</p><p>에러 내용은 다음과 같다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#ff79c6>Error</span>: pg_config executable not found.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pg_config is required to build psycopg2 from source.  
</span></span><span style=display:flex><span>Please add the directory containing pg_config to the $PATH 
</span></span><span style=display:flex><span>or specify the full executable path with the
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>option</span>: python setup.py build_ext --pg-config /path/to/pg_config build ... 
</span></span><span style=display:flex><span>    or with the pg_config option in &#39;setup.cfg&#39;
</span></span></code></pre></td></tr></table></div></div><p><a href=https://stackoverflow.com/questions/11618898/pg-config-executable-not-found>stackoverflow - pg_config executable not found</a>에 모든 답변을 따라서 시도했지만 계속해서 같은 오류가 떴다. 그래서 <code>pip install psycopg2-binary=2.9.5</code>을 설치하기로 한다.</p><p>psycopg2 와 psycopg2-binary의 차이는 다음 글을 참고했다.</p><ul><li>먼저 공식문서 <a href=https://www.psycopg.org/docs/install.html#psycopg-vs-psycopg-binary>psycopg2 vs psycopg2-binary</a>와 <a href=https://stackoverflow.com/questions/70330567/what-is-the-different-about-psycopg2-and-psycopg2-binary-python-package>what is the different about psycopg2 and psycopg2-binary python package</a> 를 참고했다.</li></ul><p><code>docker image ls</code>로 확인해보면 다음과 같은 크기로 줄어들었다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>REPOSITORY                TAG       IMAGE ID       CREATED         SIZE
</span></span><span style=display:flex><span>deployment-devket         latest    2c0746fca459   2 minutes ago   308MB
</span></span></code></pre></td></tr></table></div></div><p>동일한 기능을 낸다면 가벼운 것과 상대적으로 무거운 것 중 가벼운 것으로 가는 방향이 cost가 덜 나가기 때문에 size를 줄이는 방향을 선택했다.</p><p> </p><hr><h1 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h1><ul><li><a href=https://jeha00.github.io/post/network/webapplicationbasic01/#wsgi%EC%9D%98-%EC%A2%85%EB%A5%98>WSGI의 종류</a></li><li><a href=https://discord.com/channels/1018414416510861382/1031916397137231955/1051371601402265671>python개발자 uWSGI를 버리고 gunicorn으로 갈아타다.</a></li><li><a href=https://boto3.amazonaws.com/v1/documentation/api/latest/index.html#boto3-documentation>boto3를 사용하는 이유</a></li><li><a href=https://django-storages.readthedocs.io/en/latest/>django-storages를 설치하는 이유</a></li><li><a href=https://docs.docker.com/engine/reference/builder/#cmd>docs.docker - CMD</a></li><li><a href=https://stackoverflow.com/questions/59719175/where-to-run-collectstatic-when-deploying-django-app-to-heroku-using-docker>Where to run collectstatic when deploying django app&mldr;using Docker</a></li><li><a href=https://jeha00.github.io/post/django/deployment-with-nginx-uwsgi-ec2_3/#2-rds-%EC%97%B0%EA%B2%B0%ED%95%98%EA%B8%B0>RDS 연결하기</a></li><li><a href=https://jeha00.github.io/post/django/deployment-with-nginx-uwsgi-ec2_3/#1-static-file-serving>staticfiles 연결 3가지 방식</a></li><li><a href=https://jeha00.github.io/post/django/deployment-with-nginx-uwsgi-ec2_3/#3-aws-iam%EC%97%90%EC%84%9C-%EB%8B%A4%EC%9A%B4-%EB%B0%9B%EC%9D%80-key%EB%A5%BC-settingspy%EC%97%90-%EB%B0%98%EC%98%81%ED%95%98%EA%B8%B0>AWS IAM에서 다운 받은 key를 settings.py에 반영하기</a></li><li><a href=https://stackoverflow.com/questions/25456420/django-amazon-s3-suspiciousoperation>Django amazon s3 SuspiciousOperation</a></li><li><a href=https://aws.amazon.com/ko/iam/details/manage-roles/>AWS - manage-roles</a></li><li><a href=https://stackoverflow.com/questions/11618898/pg-config-executable-not-found>stackoverflow - pg_config executable not found</a>
<a href=https://www.psycopg.org/docs/install.html#psycopg-vs-psycopg-binary>psycopg2 vs psycopg2-binary</a></li><li><a href=https://stackoverflow.com/questions/70330567/what-is-the-different-about-psycopg2-and-psycopg2-binary-python-package>what is the different about psycopg2 and psycopg2-binary python package</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=http://jeha00.github.io/tags/deployment/>deployment</a></li></ul><nav class=paginav><a class=prev href=http://jeha00.github.io/post/project/devket/deployment/02_deployment_cors/><span class=title>« Prev Page</span><br><span>Project: deployment issue - S3 CORS</span></a>
<a class=next href=http://jeha00.github.io/post/docker/04_deployment-by-docker/><span class=title>Next Page »</span><br><span>Docker study: Docker-compose로 nginx, django, postgreSQL을 연결하고 배포하기</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Project: Docker를 사용하여 django app 배포하기 on twitter" href="https://twitter.com/intent/tweet/?text=Project%3a%20Docker%eb%a5%bc%20%ec%82%ac%ec%9a%a9%ed%95%98%ec%97%ac%20django%20app%20%eb%b0%b0%ed%8f%ac%ed%95%98%ea%b8%b0&url=http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdeployment%2f01_deployment%2f&hashtags=deployment"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Project: Docker를 사용하여 django app 배포하기 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdeployment%2f01_deployment%2f&title=Project%3a%20Docker%eb%a5%bc%20%ec%82%ac%ec%9a%a9%ed%95%98%ec%97%ac%20django%20app%20%eb%b0%b0%ed%8f%ac%ed%95%98%ea%b8%b0&summary=Project%3a%20Docker%eb%a5%bc%20%ec%82%ac%ec%9a%a9%ed%95%98%ec%97%ac%20django%20app%20%eb%b0%b0%ed%8f%ac%ed%95%98%ea%b8%b0&source=http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdeployment%2f01_deployment%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Project: Docker를 사용하여 django app 배포하기 on reddit" href="https://reddit.com/submit?url=http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdeployment%2f01_deployment%2f&title=Project%3a%20Docker%eb%a5%bc%20%ec%82%ac%ec%9a%a9%ed%95%98%ec%97%ac%20django%20app%20%eb%b0%b0%ed%8f%ac%ed%95%98%ea%b8%b0"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Project: Docker를 사용하여 django app 배포하기 on facebook" href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdeployment%2f01_deployment%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Project: Docker를 사용하여 django app 배포하기 on whatsapp" href="https://api.whatsapp.com/send?text=Project%3a%20Docker%eb%a5%bc%20%ec%82%ac%ec%9a%a9%ed%95%98%ec%97%ac%20django%20app%20%eb%b0%b0%ed%8f%ac%ed%95%98%ea%b8%b0%20-%20http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdeployment%2f01_deployment%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Project: Docker를 사용하여 django app 배포하기 on telegram" href="https://telegram.me/share/url?text=Project%3a%20Docker%eb%a5%bc%20%ec%82%ac%ec%9a%a9%ed%95%98%ec%97%ac%20django%20app%20%eb%b0%b0%ed%8f%ac%ed%95%98%ea%b8%b0&url=http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdeployment%2f01_deployment%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=http://jeha00.github.io/>Jeha DevLog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>