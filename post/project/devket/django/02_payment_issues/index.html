<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Project: Payment 개발 과정에서의 고려사항들과 개발 이슈들 | Jeha DevLog</title><meta name=keywords content="payment"><meta name=description content="Payment 1차 기능을 개발하는 과정에서의 고려사항들과 개발 이슈들에 대해 정리해본다."><meta name=author content><link rel=canonical href=http://jeha00.github.io/post/project/devket/django/02_payment_issues/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.min.1e44d58192cbf6d7a4eb649bc43dbc3d4cc432677e5d8adc69b08c34cbe461ac.css integrity="sha256-HkTVgZLL9tek62SbxD28PUzEMmd+XYrcabCMNMvkYaw=" rel="preload stylesheet" as=style><link rel=icon href=http://jeha00.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://jeha00.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://jeha00.github.io/favicon-32x32.png><link rel=apple-touch-icon href=http://jeha00.github.io/apple-touch-icon.png><link rel=mask-icon href=http://jeha00.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.101.0"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Project: Payment 개발 과정에서의 고려사항들과 개발 이슈들"><meta property="og:description" content="Payment 1차 기능을 개발하는 과정에서의 고려사항들과 개발 이슈들에 대해 정리해본다."><meta property="og:type" content="article"><meta property="og:url" content="http://jeha00.github.io/post/project/devket/django/02_payment_issues/"><meta property="og:image" content="http://jeha00.github.io/47"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-12-06T11:08:59+09:00"><meta property="article:modified_time" content="2022-12-06T11:08:59+09:00"><meta property="og:site_name" content="JeHa00 DevLog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://jeha00.github.io/47"><meta name=twitter:title content="Project: Payment 개발 과정에서의 고려사항들과 개발 이슈들"><meta name=twitter:description content="Payment 1차 기능을 개발하는 과정에서의 고려사항들과 개발 이슈들에 대해 정리해본다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://jeha00.github.io/post/"},{"@type":"ListItem","position":2,"name":"Project: Payment 개발 과정에서의 고려사항들과 개발 이슈들","item":"http://jeha00.github.io/post/project/devket/django/02_payment_issues/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Project: Payment 개발 과정에서의 고려사항들과 개발 이슈들","name":"Project: Payment 개발 과정에서의 고려사항들과 개발 이슈들","description":"Payment 1차 기능을 개발하는 과정에서의 고려사항들과 개발 이슈들에 대해 정리해본다.","keywords":["payment"],"articleBody":"0. Introduction 이 repository는 현재 러닝스푼즈 나노디그리 - django backend 부트캠프에서 팀 프로젝트를 진행하면서 다음과 같은 내용들에 대해 정리하고자 만들었습니다.\n팀 정책을 이것으로 정한 이유 개발하면서 부딪힌 문제들에 대한 원인, 해결방안, 해결과정, 그리고 그 이유들 이번 포스팅에서는 payment 결제 1차 기능을 개발하는 과정에서의 고려사항들과 개발 이슈들에 대해 정리해보겠습니다.\npayment 결제 1차 기능은 내부적으로 정한 상황들에 대해서 결제 자체가 가능하도록 개발하는 것에 목적을 두었습니다. 이후에는 환불 기능과 정기결제 기능을 추가하여 ‘구독’ 개념을 도입할 예정입니다. 1. Payment model에 대한 고려사항 내가 구상하는 결제 모델은 배달, 장바구니, 할인 같은 모델과 연관이 되어 있지 않는 순수한 결제 자체의 정보만 담는 모델임을 고려하여 구성했다.\n이번 경험을 통해서 결제 api를 가져와 연동할 때에는 입력된 기본값의 타입들이 외부 api에서는 무엇인지 확인하고 나서 모델 설계를 들어가야한다는 걸 알게 되었다.\n1.1 User ForignKey 결제를 할 때는 로그인이 된 후 진행되는 user story로 구성했기 때문에, User model을 foreignKey로 진행한다.\n1.2 merchant_id 필요 이유 merchant_id 는 ‘주문 번호’를 의미한다. 이를 생성한 이유는 다음과 같다.\n주문마다 독립적이고, 결제 정보를 보안의 관점에서 안전히 지킬 수 있기 위해서다. 아임포트를 사용할 때, 결제 금액을 위변하여 결제 진행 자체를 막기 위해 아임포트에 독립된 주문 번호를 전달해야하기 때문이다. merchant_id 암호화 위에 언급된 대로 독립적이고, 안전해야하기 때문에 ‘암호화’ 하여 생성하기로 결정했다.\n암호화는 class PaymentManager(models.Manager)에서 선언한 메서드인 create_new 과정에서 user 정보를 받아 진행된다.\n1) 기존 모듈 vs 외부 모듈 설치\n‘암호화’ 하는 방법에는 기존 라이브러리를 사용하는 방식과 써드 파트를 설치하는 방식이 있지만, 추가 설치하여 무게를 늘리고 싶지 않기 때문에 기존에 존재하는 모듈인 hashlib를 사용하기로 결정했다. 만약 무게가 늘어나면 EC2에 배포 시에 비용이 더 들기 때문이고, 다른 요인들에 영향을 주지 않는다면 비용이 적은 걸 추구하는 게 엔지니어로서 맞다고 생각했다.\n고려 대상 모듈: crytography 2) sha1 vs sha256\n기존 모듈로 고려한 대상은 hashlib를 선택했으며 이 안에서도 sha-1과 sha-256을 고민했다. sha-2에서 sha-256을 선택한 이유는 일반적으로 이 해쉬 알고리즘을 사용한다고 확인했기 때문이다. 일반적으로 사용하는 만큼 안전성과 접근성 등등 여러모로 이유가 있을거라 판단했기 때문이다. 그러면 결국 sha-1을 선택한 이유는 이 두 가지를 사용하여 해시값을 생성해보니 sha-1이 더 짧았기 때문이다. 현재 프로젝트 규모가 크지 않기 때문에 그리 긴 해시값은 필요없다고 판단했기 때문이다.\n❗️ 하지만 프로젝트 발표 후, 프로젝트 진행한 거를 회고하면서 다시 sha-1과 sha-2를 알아보면서 sha-1에 해독 가능성이 제시됭 이를 중단하여, 크롬 브라우저에서는 2019년부터는 SHA-1 인증서를 사용하는 사이트는 접속 못하도록 차단했다고 들어 프로젝트가 다시 착수할 때는 sha-256으로 바꿀 계획이다.\nsha: Secure Hash Algorithm의 약어 참고 문서 hashlib - 보안 해시와 메시지 요약 namu.wiki - SHA 3) 암호화의 대상 구체화하기\n이 다음으로는 사용자 id 외에 구체적으로 무엇을 암호화할지를 고민하기 시작했다.\n사용자 id만 하기에는 안전하지 못하다는 생각이 들어, 지속적으로 변하여 그 값이 이전과 독립적인 게 무엇이 있을까 고민했다. 그건 바로 ‘시간’ 이었다. 그리고, 사용자 한 명이 결제를 여러 번 시도할 때 시간을 지속적으로 흐르기 때문에 사용자 id(user.id)와 시간을 가지고 만든다면 계속해서 독립적인 주문 번호를 생성할 수 있을거라 판단했다.\n4) digest vs hexdigest\ndigest에 대해 먼저 알아보자.\n원본 데이터가 해시함수를 통과하여 암호화된 데이터를 ‘다이제스트(digest)‘라고 한다.\nhashlib.sha1()을 사용하는 코드들을 참고하니 digest와 hexdigest가 많이 언급되어 공식문서를 찾아보니 무엇보다 큰 차이는 digest는 해싱한 바이트 문자열을 반환하고, hexdigest는 바이트 문자열을 16진수로 변환한 문자열을 반환한다. hashlib.sha1(\u003c문자열\u003e.encode()).digest() 또는 .hexdigest()로 비교해보면 된다.\n출력 결과 16진수로 되어있는 hexdigest가 더 짧은 문자열을 가지기 때문에 DB에 저장되는 용량이 더 적어질거라 판단하여 digest를 선택했다.\n5) 해시하기 위한 encoding\n파이썬에서의 문자열은 기본적으로 유니코드이므로, 해시하기 위해서는 바이트 형태가 필요하다. 그래서 해시 전에 반드시 인코딩되어야 하므로 .encode('utf-8')를 사용한다.\n❗️encode의 기본값은 'utf-8'이므로 별도로 입력할 필요는 없다. 프로젝트가 다시 착수될 때 수정할 사항 중 하나다.\n6) merchant_id의 자릿수\nmerchant_id의 자릿수를 설계할 때 아임포트 API에 string(40)을 확인하지 못하고 다음과 같이 과하게 설계했다.\n1 merchant_id = models.CharField(verbose_name='주문번호' , max_length=120, unique=True) 그후 merchant_id를 암호화하여 자릿수를 생성할 때, 40을 20으로 착각했고, 현재 결제 건은 많지 않으니 ‘10’에 맞춰서 진행하기로 결정했다.\n그후, 프로젝트 발표를 마치고 코드를 보면서 회고하는 과정에서 max_length와 암호화 후, 자릿수를 인덱싱하는 과정에서 설계 상 맞지 않는 걸 확인했고, 이 부분 또한 프로젝트가 다시 착수되면 수정 사항으로 확인되었다.\n🔆 max_length는 DB의 VARCHAR 사이즈를 나타내는데, VARCHAR는 mysql에서 버전 4에서는 bytes 였다가 버전 5에서 글자수로 바뀌었다.\na max_length argument which specifies the size of the VARCHAR database field used to store the data. 출처: Field options 7) 두 번 암호화하기\n암호화를 할 때, user의 id와 시간만 합쳐서 암호화를 한 번 하는 것보다 부분적으로 인덱싱하여 가져와서 합친 후, 암호화를 한 번 더 실행하기로 했다. 그 이유는 구글링하여 해시에 대해 알아보다가 여러 번 해시함수를 거쳐서 다이제스트를 생성하는 방식을 보안적으로 사용한다는 글을 확인했기 때문이다.\n1 2 3 user_hash = hashlib.sha1(str(user.id).encode('utf-8')).hexdigest()[:5] time_hash = hashlib.sha1(str(int(time.time())).encode('utf-8')).hexdigest()[-5:] merchant_id = hashlib.sha1((user_hash + time_hash).encode('utf-8')).hexdigest()[:10] 1.3 payment_id 아임포트에 merchant_id와 amount를 전달하고, 결제 이후에 아임포트 내에서 merchant_id를 기준으로 결제내역을 확인할 때 imp_id를 받는다. 이 imp_id와 merchant_id로 정상 거래인지 아닌지를 판단한다.\n이 아임포트에서 전달한 imp_id가 DB에 payment_id로 저장됩니다. 즉 ‘결제 번호’를 의미한다. 이 결제 번호는 결제 오류로 아임포트에서 받지 못할 수도 있어 다음과 같이 blank=True로 설정한다.\n1.4 amount amount는 ‘결제 금액’을 의미한다. 이 결제는 테스트 결제이기 때문에, 테스트 결제를 위한 최소 결제 금액을 알고 있는 것이 중요했다. 최소 결제 금액은 최소,최대 결제금액이 얼만지 궁금해요!에서 KG 이니시스를 확인하면 ‘신용카드’는 100원이라는 걸 알 수 있다. 그래서 다음과 같이 default 값으로 100을 입력해야 한다.\n1 amount = models.PositiveIntegerField(verbose_name='결제 금액', default=100) 만약 이 100원보다 낮은 금액으로 merchant_id와 amount를 아임포트에 전달할 경우, 아임포트에서는 받아들여지지 않아서 다음과 같은 에러가 발생된다.\n발생된 error: 거래건이 존재하지 않습니다. 그렇기 때문에 결제 외부 API를 사용한다면 반드시 테스트를 위한 최소 결제 금액을 확인해야 한다.\n1.5 type type은 결제 방식을 의미한다. 아임포트에서는 결제 수단을 ‘method’라 했지만 이는 다른 의미로 받아들여질 확률이 크다고 판단되어 type이란 명칭을 선택했다.\n또한, 프로젝트의 클론 대상이 되는 사이트에서는 카드 결제만을 고려했기 때문에, 이번 프로젝트 또한 카드 결제만을 고려했다.\ntype의 choices 속성 값에 해당되는 PAYMENT_TYPE_CHOICES가 처음에는 IntegerField에 입력되기 위해서 다음과 같이 before case로 적혔지만, 이런 경우 type 정보를 아임포트에 전달하면 못 받아들였기 때문에 아임포트와의 호환을 위해서 after case로 수정했다.\n1 2 3 4 5 # before case PAYMENT_TYPE_CHOICES = [(1, '신용카드')] # after case PAYMENT_TYPE_CHOICES = [('card', '신용카드')] ❗️ type이란 명칭은 파이썬의 내장 함수 type()에 사용되는 예약어이기 때문에 수정사항에 해당된다.\n1.6 status ‘결제 상태’를 말한다. 결제 객체를 생성 후 중간 중간 과정을 저장하는 게 중요하기 때문이다. 이 저장된 값에 따라서 결제가 어떻게 중단되었고, 어디서 중단되었는지 알 수 있기 때문이다. 또한, 결제가 정확하게 이뤄졌는지 판단할 수 있다.\n처음에는 이 또한 IntegerField를 사용하여 choices를 다음과 같이 만들었다.\n1 2 3 4 5 6 7 8 9 10 11 12 # status choices IS_DONE = 2 IS_AWAITING = 1 IS_CANCELLED = 0 STATUS_CHOICES =[ {IS_DONE, '결제완료'}, {IS_AWAITING, '결제대기'}, {IS_CANCELLED, '결제취소'} ] status = models.IntegerField(choices=STATUS_CHOICES, default=IS_AWAITING, verbose_name='결제상태') 하지만 이럴 경우, 아임포트와 연동하는 과정에서 혼란스러웠기 때문에 아임포트에서 전달하는 상태 값을 최대한 그대로 사용하는 게 낫다는 판단을 하여 CharField를 사용했다.\n1 2 3 4 5 6 7 8 9 STATUS_CHOICES =[ {'await', '결제대기'}, {'paid', '결제성공'}, {'failed', '결제실패'}, {'cancelled', '결제취소'} ] status = models.CharField(verbose_name='결제상태', default='await', choices=STATUS_CHOICES, max_length=10) max_length는 cancelled 를 고려하여 10으로 설정했다.\n2. Iamport.py 작성 시 고려사항 iamport.py 는 아임포트 github에서 제공하는 함수를 그대로 가져온 게 아니라, 이를 참고로 나만의 방식으로 작성했다.\nIMP_KEY와 IMP_SECRET IMP_KEY와 IMP_SECRET 값을 가리키는 인스턴스 변수들을 생성자에 포함시켜서 해당 클래스를 가져와서 변수를 인스턴스화할 때, 별도의 KEY와 SECRET 값을 받지 않도록 설계했다.\n아임포트 api url을 클래스 변수로 만들기 아임포트 api url에서 protocol + host 부분은 클래스 변수로 만들어서 복잡한 url을 보다 가독성 좋고 알아보기 쉽게 만들었다.\n아임포트 응답 성공일 때, ‘code’의 값 아임포트에서 응답을 보낼 때 ‘code’라는 key의 대응되는 값이 0이므로 단지 0으로 두기보다는 response_success라는 변수가 가리키도록 하여 가독성 부분도 고려했다.\nrequest module 아임포트에 url에 데이터를 전달할 때는 request module을 사용했다.\n❗️ 위 부분이 반복되기 때문에 프로젝트를 다시 착수할 때 별도의 메서드로 함수화할 예정이다.\nstatus code status code 부분은 400번대가 존재하는데 아임포트 api 문서에서 실패 시 반환하는 status code를 그대로 가져왔기 때문이다.\n3. models.Manager 작성 시 고려사항 models.Manager를 사용한 이유 models.Manager를 사용한 이유는 로직을 view에서 처리하면 너무 길어지기 때문에, 이보다는 해당 Manager model에서 만든 쿼리 메서드를 만들어서 사용하는 게 관리의 관점에서 낫다고 판단했기 때문이다.\nmodels.Manager 관련 django docs Manager name 공식문서를 참고하여 Manager의 이름은 \u003c이 모델 매니저를 사용할 모델명\u003eManager로 작명한다. 그리고 이 Manager를 사용할 모델에 objects에 할당한다.\n1 2 3 4 class Payments(models.Model): ... objects = PaymentsManager() ... 4. DB에 저장되는 결제 정보 시간대 설정 결제 시간을 저장하기 위해서 DateTimeField를 사용했다.\n저장된 결제 시간을 보니 실제 결제 시간과 DB에 저장된 시간이 다른 issue가 발생했다.\nDjango docs - TIME_ZONE를 보면 settings.py에 TIME_ZONE이 정의되어 있지않으면, default 값으로 America/Chicago 로 설정되는 걸 알 수 있다.\n그래서 다음 두 가지 설정을 추가해본다.\n1 2 3 4 # settings.py TIME_ZONE = 'Asia/Seoul USE_TZ = False USE_TZ 가 True이면 default 값으로 time zone이 인식된다. 그래서 이 부분을 False로 변경한다.\n그리고, TIME_ZONE에 무슨 값을 세팅할지 알지 못해서 구글링을 통해 확인했다. 나중에 위 문서를 보니 list of time zones에 목록들이 나와있는 걸 확인했다.\n5. post_save.connect() post_save.connect를 택한 이유와 역할 이유 post_save.connect()를 사용한 이유는 2가지다.\n첫 번째: Payment 모델 객체에 관한 것이기 때문에, models.py 에서 처리하길 원했다. 두 번째: Payment 모델 save()가 실행되면 자동적으로 payment_validation을 체크하여 아임포트와 로컬 DB에 존재하는지 자동적으로 체크하길 원했다. 1 2 3 from django.db.models.signals import post_save ... post_save.connect(payment_validation, sender=Payment) 역할 docs Django - Signals를 참고하면 post_save는 model 객체에 대해 save() method가 실행된 후, method가 실행되도록 신호를 보낸다.\nPayment model이 저장되면 위 코드를 사용하여 payment_validation 함수를 실행한다. 만약 payment_id가 존재할 경우, 아임포트 내에서 찾은 결제 내역이 실제 모델에도 존재하는지를 확인한다. 한 곳이라도 없으면 ‘비정상 거래’ 임을 알리는 역할을 수행한다.\npost_save.connect의 내부 원리 post_save.connect 실행 전체 순서 post_save.connect(receiver, sender)를 통해서 sender와 receiver를 Signal.connect()에 전달하여 sender와 receiver가 실행이 순차적으로 되도록 연결시키는 단계 model.save()가 실행되어 Signal.send(sender)가 실행 Signal.send(sender)에서 Signal._live_receiver(sender)가 호출된다. 그 결과 sender에 연결된 receiver들을 반환하고, 각 receiver들을 실행시킨다. ModelSignal class and partial class model 객체인 sender 그리고, receiver를 받아서 partial class를 통해 Signal.connect에 전달하기\nmodel.save()가 실행되기 전에 receiver와 sender를 미리 연결하기 위해서 Signal.connect에 전달하는 단계다.\n그러면 그후, model.save()가 실행되어 sender가 실행될 때, receiver가 실행된다.\npost_save는 다음과 같이 ModelSignal class의 인스턴스다. 그래서 이 인스턴스에 접근하여 인스턴스 메서드인 connect가 실행된다. connect에서 받은 인자들을 _lazy_method에 전달한다.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 # signals.py class ModelSignal(Signal): ... def _lazy_method(self, method, apps, receiver, sender, **kwargs): ... partial_method = partial(method, receiver, **kwargs) if isinstance(sender, str): ... else: return partial_method(sender) def connect(self, receiver, sender=None, weak=True, dispatch_uid=None, apps=None): self._lazy_method( super().connect, apps, receiver, sender, weak=weak, dispatch_uid=dispatch_uid, ) ... ... post_save = ModelSignal(use_caching=True) 받은 인자는 아래 코드대로 self를 사용하여 같은 클래스의 메서드를 호출하여 전달된다. 아래에서 super()는 Signal 상위 클래스를 말한다.\n1 self._lazy_method(method=super().connect, apps=None, receiver=payment_validation, sender=Payment, ...) 그러면 partial_method 인스턴스 객체를 만든다. 이 때 partial class 내부의 __new__ method가 실행되서 다음과 같이 func과 args 속성이 각각 method와 receiver를 가리킨다.\n1 2 3 partial_method = partial(method=super().connect, receiver=payment_validation) partial_method.func = super().connect partial_method.args = payment_validation 그 다음으로 _lazy_method method는 객체가 문자열 유무에 따라 분기가 되는데, Payment의 type()은 str이 아니고, ","wordCount":"2080","inLanguage":"en","datePublished":"2022-12-06T11:08:59+09:00","dateModified":"2022-12-06T11:08:59+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://jeha00.github.io/post/project/devket/django/02_payment_issues/"},"publisher":{"@type":"Organization","name":"Jeha DevLog","logo":{"@type":"ImageObject","url":"http://jeha00.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://jeha00.github.io/ accesskey=h title="@Jeha00 (Alt + H)">@Jeha00</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=http://jeha00.github.io/me/ title=About><span>About</span></a></li><li><a href=http://jeha00.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=http://jeha00.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=http://jeha00.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://jeha00.github.io/>Home</a>&nbsp;»&nbsp;<a href=http://jeha00.github.io/post/>Posts</a></div><h1 class=post-title>Project: Payment 개발 과정에서의 고려사항들과 개발 이슈들</h1><div class=post-meta><span title='2022-12-06 11:08:59 +0900 KST'>December 6, 2022</span>&nbsp;|&nbsp;<a href=https://github.com/JeHa00/blog/content/post/Project/Devket/Django/02_Payment_issues.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#0-introduction aria-label="0. Introduction">0. Introduction</a></li><li><a href=#1-payment-model%ec%97%90-%eb%8c%80%ed%95%9c-%ea%b3%a0%eb%a0%a4%ec%82%ac%ed%95%ad aria-label="1. Payment model에 대한 고려사항">1. Payment model에 대한 고려사항</a><ul><li><a href=#11-user-forignkey aria-label="1.1 User ForignKey">1.1 User ForignKey</a></li><li><a href=#12-merchant_id aria-label="1.2 merchant_id">1.2 merchant_id</a><ul><li><a href=#%ed%95%84%ec%9a%94-%ec%9d%b4%ec%9c%a0 aria-label="필요 이유">필요 이유</a></li><li><a href=#merchant_id-%ec%95%94%ed%98%b8%ed%99%94 aria-label="merchant_id 암호화">merchant_id 암호화</a></li></ul></li><li><a href=#13-payment_id aria-label="1.3 payment_id">1.3 payment_id</a></li><li><a href=#14-amount aria-label="1.4 amount">1.4 amount</a></li><li><a href=#15-type aria-label="1.5 type">1.5 type</a></li><li><a href=#16-status aria-label="1.6 status">1.6 status</a></li></ul></li><li><a href=#2-iamportpy-%ec%9e%91%ec%84%b1-%ec%8b%9c-%ea%b3%a0%eb%a0%a4%ec%82%ac%ed%95%ad aria-label="2. Iamport.py 작성 시 고려사항">2. Iamport.py 작성 시 고려사항</a><ul><ul><li><a href=#imp_key%ec%99%80-imp_secret aria-label="IMP_KEY와 IMP_SECRET">IMP_KEY와 IMP_SECRET</a></li><li><a href=#%ec%95%84%ec%9e%84%ed%8f%ac%ed%8a%b8-api-url%ec%9d%84-%ed%81%b4%eb%9e%98%ec%8a%a4-%eb%b3%80%ec%88%98%eb%a1%9c-%eb%a7%8c%eb%93%a4%ea%b8%b0 aria-label="아임포트 api url을 클래스 변수로 만들기">아임포트 api url을 클래스 변수로 만들기</a></li><li><a href=#%ec%95%84%ec%9e%84%ed%8f%ac%ed%8a%b8-%ec%9d%91%eb%8b%b5-%ec%84%b1%ea%b3%b5%ec%9d%bc-%eb%95%8c-code%ec%9d%98-%ea%b0%92 aria-label="아임포트 응답 성공일 때, &amp;lsquo;code&amp;rsquo;의 값">아임포트 응답 성공일 때, &lsquo;code&rsquo;의 값</a></li><li><a href=#request-module aria-label="request module">request module</a></li><li><a href=#status-code aria-label="status code">status code</a></li></ul></ul></li><li><a href=#3-modelsmanager-%ec%9e%91%ec%84%b1-%ec%8b%9c-%ea%b3%a0%eb%a0%a4%ec%82%ac%ed%95%ad aria-label="3. models.Manager 작성 시 고려사항">3. models.Manager 작성 시 고려사항</a><ul><ul><li><a href=#modelsmanager%eb%a5%bc-%ec%82%ac%ec%9a%a9%ed%95%9c-%ec%9d%b4%ec%9c%a0 aria-label="models.Manager를 사용한 이유">models.Manager를 사용한 이유</a></li><li><a href=#manager-name aria-label="Manager name">Manager name</a></li></ul></ul></li><li><a href=#4-db%ec%97%90-%ec%a0%80%ec%9e%a5%eb%90%98%eb%8a%94-%ea%b2%b0%ec%a0%9c-%ec%a0%95%eb%b3%b4-%ec%8b%9c%ea%b0%84%eb%8c%80-%ec%84%a4%ec%a0%95 aria-label="4. DB에 저장되는 결제 정보 시간대 설정">4. DB에 저장되는 결제 정보 시간대 설정</a></li><li><a href=#5-post_saveconnect aria-label="5. post_save.connect()">5. post_save.connect()</a><ul><li><a href=#post_saveconnect%eb%a5%bc-%ed%83%9d%ed%95%9c-%ec%9d%b4%ec%9c%a0%ec%99%80-%ec%97%ad%ed%95%a0 aria-label="post_save.connect를 택한 이유와 역할">post_save.connect를 택한 이유와 역할</a><ul><li><a href=#%ec%9d%b4%ec%9c%a0 aria-label=이유>이유</a></li><li><a href=#%ec%97%ad%ed%95%a0 aria-label=역할>역할</a></li></ul></li><li><a href=#post_saveconnect%ec%9d%98-%eb%82%b4%eb%b6%80-%ec%9b%90%eb%a6%ac aria-label="post_save.connect의 내부 원리">post_save.connect의 내부 원리</a><ul><li><a href=#post_saveconnect-%ec%8b%a4%ed%96%89-%ec%a0%84%ec%b2%b4-%ec%88%9c%ec%84%9c aria-label="post_save.connect 실행 전체 순서">post_save.connect 실행 전체 순서</a></li><li><a href=#modelsignal-class-and-partial-class aria-label="ModelSignal class and partial class">ModelSignal class and partial class</a></li><li><a href=#signalconnect aria-label=Signal.connect>Signal.connect</a></li><li><a href=#connect---send---_live_receivers aria-label="connect() -&amp;gt; send() -&amp;gt; _live_receivers()">connect() -> send() -> _live_receivers()</a></li></ul></li><li><a href=#-%ec%b0%b8%ea%b3%a0-%ec%95%bd%ed%95%9c-%ec%b0%b8%ec%a1%b0-vs-%ea%b0%95%ed%95%9c-%ec%b0%b8%ec%a1%b0 aria-label="🔆 참고: 약한 참조 vs 강한 참조">🔆 참고: 약한 참조 vs 강한 참조</a></li></ul></li><li><a href=#reference aria-label=Reference>Reference</a></li></ul></div></details></div><div class=post-content><h1 id=0-introduction>0. Introduction<a hidden class=anchor aria-hidden=true href=#0-introduction>#</a></h1><ul><li><p>이 repository는 현재 <a href=https://learningspoons.com/course/detail/django-backend/>러닝스푼즈 나노디그리 - django backend 부트캠프</a>에서 팀 프로젝트를 진행하면서 다음과 같은 내용들에 대해 정리하고자 만들었습니다.</p><ul><li>팀 정책을 이것으로 정한 이유</li><li>개발하면서 부딪힌 문제들에 대한 원인, 해결방안, 해결과정, 그리고 그 이유들</li></ul></li><li><p>이번 포스팅에서는 payment 결제 1차 기능을 개발하는 과정에서의 고려사항들과 개발 이슈들에 대해 정리해보겠습니다.</p><ul><li>payment 결제 1차 기능은 내부적으로 정한 상황들에 대해서 결제 자체가 가능하도록 개발하는 것에 목적을 두었습니다.</li><li>이후에는 환불 기능과 정기결제 기능을 추가하여 &lsquo;구독&rsquo; 개념을 도입할 예정입니다.</li></ul></li></ul><p> </p><hr><h1 id=1-payment-model에-대한-고려사항>1. Payment model에 대한 고려사항<a hidden class=anchor aria-hidden=true href=#1-payment-model에-대한-고려사항>#</a></h1><p>내가 구상하는 결제 모델은 배달, 장바구니, 할인 같은 모델과 연관이 되어 있지 않는 순수한 결제 자체의 정보만 담는 모델임을 고려하여 구성했다.</p><p>이번 경험을 통해서 결제 api를 가져와 연동할 때에는 입력된 기본값의 타입들이 외부 api에서는 무엇인지 확인하고 나서 모델 설계를 들어가야한다는 걸 알게 되었다.</p><h2 id=11-user-forignkey>1.1 User ForignKey<a hidden class=anchor aria-hidden=true href=#11-user-forignkey>#</a></h2><p>결제를 할 때는 로그인이 된 후 진행되는 user story로 구성했기 때문에, User model을 foreignKey로 진행한다.</p><p> </p><h2 id=12-merchant_id>1.2 merchant_id<a hidden class=anchor aria-hidden=true href=#12-merchant_id>#</a></h2><h3 id=필요-이유>필요 이유<a hidden class=anchor aria-hidden=true href=#필요-이유>#</a></h3><p>merchant_id 는 &lsquo;주문 번호&rsquo;를 의미한다. 이를 생성한 이유는 다음과 같다.</p><ul><li>주문마다 독립적이고, 결제 정보를 보안의 관점에서 안전히 지킬 수 있기 위해서다.</li><li>아임포트를 사용할 때, 결제 금액을 위변하여 결제 진행 자체를 막기 위해 아임포트에 독립된 주문 번호를 전달해야하기 때문이다.</li></ul><p> </p><h3 id=merchant_id-암호화>merchant_id 암호화<a hidden class=anchor aria-hidden=true href=#merchant_id-암호화>#</a></h3><p>위에 언급된 대로 독립적이고, 안전해야하기 때문에 &lsquo;암호화&rsquo; 하여 생성하기로 결정했다.</p><p>암호화는 <code>class PaymentManager(models.Manager)</code>에서 선언한 메서드인 create_new 과정에서 user 정보를 받아 진행된다.</p><p><strong>1) 기존 모듈 vs 외부 모듈 설치</strong></p><p>&lsquo;암호화&rsquo; 하는 방법에는 기존 라이브러리를 사용하는 방식과 써드 파트를 설치하는 방식이 있지만, 추가 설치하여 무게를 늘리고 싶지 않기 때문에 기존에 존재하는 모듈인 <code>hashlib</code>를 사용하기로 결정했다. 만약 무게가 늘어나면 EC2에 배포 시에 비용이 더 들기 때문이고, 다른 요인들에 영향을 주지 않는다면 비용이 적은 걸 추구하는 게 엔지니어로서 맞다고 생각했다.</p><ul><li>고려 대상 모듈: <code>crytography</code></li></ul><h1 id=heading><a hidden class=anchor aria-hidden=true href=#heading>#</a></h1><p><strong>2) sha1 vs sha256</strong></p><p>기존 모듈로 고려한 대상은 <code>hashlib</code>를 선택했으며 이 안에서도 <code>sha-1</code>과 <code>sha-256</code>을 고민했다. <code>sha-2</code>에서 <code>sha-256</code>을 선택한 이유는 일반적으로 이 해쉬 알고리즘을 사용한다고 확인했기 때문이다. 일반적으로 사용하는 만큼 안전성과 접근성 등등 여러모로 이유가 있을거라 판단했기 때문이다. 그러면 결국 <code>sha-1</code>을 선택한 이유는 이 두 가지를 사용하여 해시값을 생성해보니 <code>sha-1</code>이 더 짧았기 때문이다. 현재 프로젝트 규모가 크지 않기 때문에 그리 긴 해시값은 필요없다고 판단했기 때문이다.</p><p>❗️ 하지만 프로젝트 발표 후, 프로젝트 진행한 거를 회고하면서 다시 sha-1과 sha-2를 알아보면서 sha-1에 해독 가능성이 제시됭 이를 중단하여, 크롬 브라우저에서는 2019년부터는 SHA-1 인증서를 사용하는 사이트는 접속 못하도록 차단했다고 들어 프로젝트가 다시 착수할 때는 sha-256으로 바꿀 계획이다.</p><ul><li>sha: Secure Hash Algorithm의 약어</li><li>참고 문서<ul><li><a href=https://docs.python.org/ko/3/library/hashlib.html>hashlib - 보안 해시와 메시지 요약</a></li><li><a href=https://namu.wiki/w/SHA>namu.wiki - SHA</a></li></ul></li></ul><h1 id=heading-1><a hidden class=anchor aria-hidden=true href=#heading-1>#</a></h1><p><strong>3) 암호화의 대상 구체화하기</strong></p><p>이 다음으로는 사용자 id 외에 구체적으로 무엇을 암호화할지를 고민하기 시작했다.</p><p>사용자 id만 하기에는 안전하지 못하다는 생각이 들어, 지속적으로 변하여 그 값이 이전과 독립적인 게 무엇이 있을까 고민했다.
그건 바로 &lsquo;시간&rsquo; 이었다. 그리고, 사용자 한 명이 결제를 여러 번 시도할 때 시간을 지속적으로 흐르기 때문에 사용자 id(user.id)와 시간을 가지고 만든다면 계속해서 독립적인 주문 번호를 생성할 수 있을거라 판단했다.</p><h1 id=heading-2><a hidden class=anchor aria-hidden=true href=#heading-2>#</a></h1><p><strong>4) digest vs hexdigest</strong></p><p>digest에 대해 먼저 알아보자.</p><p>원본 데이터가 해시함수를 통과하여 암호화된 데이터를 &lsquo;다이제스트(digest)&lsquo;라고 한다.</p><p><code>hashlib.sha1()</code>을 사용하는 코드들을 참고하니 digest와 hexdigest가 많이 언급되어 공식문서를 찾아보니 무엇보다 큰 차이는 digest는 해싱한 바이트 문자열을 반환하고, hexdigest는 바이트 문자열을 16진수로 변환한 문자열을 반환한다. <code>hashlib.sha1(&lt;문자열>.encode()).digest() 또는 .hexdigest()</code>로 비교해보면 된다.</p><p>출력 결과 16진수로 되어있는 hexdigest가 더 짧은 문자열을 가지기 때문에 DB에 저장되는 용량이 더 적어질거라 판단하여 digest를 선택했다.</p><h1 id=heading-3><a hidden class=anchor aria-hidden=true href=#heading-3>#</a></h1><p><strong>5) 해시하기 위한 encoding</strong></p><p>파이썬에서의 문자열은 기본적으로 유니코드이므로, 해시하기 위해서는 바이트 형태가 필요하다. 그래서 해시 전에 반드시 인코딩되어야 하므로 <code>.encode('utf-8')</code>를 사용한다.</p><p>❗️encode의 기본값은 <code>'utf-8'</code>이므로 별도로 입력할 필요는 없다. 프로젝트가 다시 착수될 때 수정할 사항 중 하나다.</p><h1 id=heading-4><a hidden class=anchor aria-hidden=true href=#heading-4>#</a></h1><p><strong>6) merchant_id의 자릿수</strong></p><p>merchant_id의 자릿수를 설계할 때 아임포트 API에 string(40)을 확인하지 못하고 다음과 같이 과하게 설계했다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>merchant_id <span style=color:#ff79c6>=</span> models<span style=color:#ff79c6>.</span>CharField(verbose_name<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;주문번호&#39;</span> , max_length<span style=color:#ff79c6>=</span><span style=color:#bd93f9>120</span>, unique<span style=color:#ff79c6>=</span><span style=color:#ff79c6>True</span>)
</span></span></code></pre></td></tr></table></div></div><p>그후 merchant_id를 암호화하여 자릿수를 생성할 때, 40을 20으로 착각했고, 현재 결제 건은 많지 않으니 &lsquo;10&rsquo;에 맞춰서 진행하기로 결정했다.</p><p>그후, 프로젝트 발표를 마치고 코드를 보면서 회고하는 과정에서 max_length와 암호화 후, 자릿수를 인덱싱하는 과정에서 설계 상 맞지 않는 걸 확인했고, 이 부분 또한 프로젝트가 다시 착수되면 수정 사항으로 확인되었다.</p><p>🔆 max_length는 DB의 VARCHAR 사이즈를 나타내는데, VARCHAR는 mysql에서 버전 4에서는 bytes 였다가 버전 5에서 글자수로 바뀌었다.</p><ul><li>a max_length argument which specifies the size of the VARCHAR database field used to store the data. 출처: <a href=https://docs.djangoproject.com/en/4.1/topics/db/models/#field-options>Field options</a></li></ul><h1 id=heading-5><a hidden class=anchor aria-hidden=true href=#heading-5>#</a></h1><p><strong>7) 두 번 암호화하기</strong></p><p>암호화를 할 때, user의 id와 시간만 합쳐서 암호화를 한 번 하는 것보다 부분적으로 인덱싱하여 가져와서 합친 후, 암호화를 한 번 더 실행하기로 했다. 그 이유는 구글링하여 해시에 대해 알아보다가 여러 번 해시함수를 거쳐서 다이제스트를 생성하는 방식을 보안적으로 사용한다는 글을 확인했기 때문이다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>user_hash <span style=color:#ff79c6>=</span> hashlib<span style=color:#ff79c6>.</span>sha1(<span style=color:#8be9fd;font-style:italic>str</span>(user<span style=color:#ff79c6>.</span>id)<span style=color:#ff79c6>.</span>encode(<span style=color:#f1fa8c>&#39;utf-8&#39;</span>))<span style=color:#ff79c6>.</span>hexdigest()[:<span style=color:#bd93f9>5</span>]
</span></span><span style=display:flex><span>time_hash <span style=color:#ff79c6>=</span> hashlib<span style=color:#ff79c6>.</span>sha1(<span style=color:#8be9fd;font-style:italic>str</span>(<span style=color:#8be9fd;font-style:italic>int</span>(time<span style=color:#ff79c6>.</span>time()))<span style=color:#ff79c6>.</span>encode(<span style=color:#f1fa8c>&#39;utf-8&#39;</span>))<span style=color:#ff79c6>.</span>hexdigest()[<span style=color:#ff79c6>-</span><span style=color:#bd93f9>5</span>:]
</span></span><span style=display:flex><span>merchant_id <span style=color:#ff79c6>=</span> hashlib<span style=color:#ff79c6>.</span>sha1((user_hash <span style=color:#ff79c6>+</span> time_hash)<span style=color:#ff79c6>.</span>encode(<span style=color:#f1fa8c>&#39;utf-8&#39;</span>))<span style=color:#ff79c6>.</span>hexdigest()[:<span style=color:#bd93f9>10</span>]
</span></span></code></pre></td></tr></table></div></div><p> </p><h2 id=13-payment_id>1.3 payment_id<a hidden class=anchor aria-hidden=true href=#13-payment_id>#</a></h2><p>아임포트에 merchant_id와 amount를 전달하고, 결제 이후에 아임포트 내에서 merchant_id를 기준으로 결제내역을 확인할 때 <code>imp_id</code>를 받는다. 이 imp_id와 merchant_id로 정상 거래인지 아닌지를 판단한다.</p><p>이 아임포트에서 전달한 imp_id가 DB에 payment_id로 저장됩니다. 즉 &lsquo;결제 번호&rsquo;를 의미한다. 이 결제 번호는 결제 오류로 아임포트에서 받지 못할 수도 있어 다음과 같이 <code>blank=True</code>로 설정한다.</p><p> </p><h2 id=14-amount>1.4 amount<a hidden class=anchor aria-hidden=true href=#14-amount>#</a></h2><p>amount는 &lsquo;결제 금액&rsquo;을 의미한다. 이 결제는 테스트 결제이기 때문에, 테스트 결제를 위한 최소 결제 금액을 알고 있는 것이 중요했다. 최소 결제 금액은 <a href=https://faq.iamport.kr/7e1f6e5f-5e36-4617-b509-c26602079561>최소,최대 결제금액이 얼만지 궁금해요!</a>에서 KG 이니시스를 확인하면 &lsquo;신용카드&rsquo;는 100원이라는 걸 알 수 있다. 그래서 다음과 같이 default 값으로 100을 입력해야 한다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>amount <span style=color:#ff79c6>=</span> models<span style=color:#ff79c6>.</span>PositiveIntegerField(verbose_name<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;결제 금액&#39;</span>, default<span style=color:#ff79c6>=</span><span style=color:#bd93f9>100</span>)
</span></span></code></pre></td></tr></table></div></div><p>만약 이 100원보다 낮은 금액으로 merchant_id와 amount를 아임포트에 전달할 경우, 아임포트에서는 받아들여지지 않아서 다음과 같은 에러가 발생된다.</p><ul><li>발생된 error: <code>거래건이 존재하지 않습니다.</code></li></ul><p>그렇기 때문에 결제 외부 API를 사용한다면 반드시 테스트를 위한 최소 결제 금액을 확인해야 한다.</p><p> </p><h2 id=15-type>1.5 type<a hidden class=anchor aria-hidden=true href=#15-type>#</a></h2><p>type은 결제 방식을 의미한다. 아임포트에서는 결제 수단을 &lsquo;method&rsquo;라 했지만 이는 다른 의미로 받아들여질 확률이 크다고 판단되어 type이란 명칭을 선택했다.</p><p>또한, 프로젝트의 클론 대상이 되는 사이트에서는 카드 결제만을 고려했기 때문에, 이번 프로젝트 또한 카드 결제만을 고려했다.</p><p>type의 choices 속성 값에 해당되는 PAYMENT_TYPE_CHOICES가 처음에는 IntegerField에 입력되기 위해서
다음과 같이 before case로 적혔지만, 이런 경우 type 정보를 아임포트에 전달하면 못 받아들였기 때문에 아임포트와의 호환을 위해서 after case로 수정했다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#6272a4># before case</span>
</span></span><span style=display:flex><span>PAYMENT_TYPE_CHOICES <span style=color:#ff79c6>=</span> [(<span style=color:#bd93f9>1</span>, <span style=color:#f1fa8c>&#39;신용카드&#39;</span>)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># after case</span>
</span></span><span style=display:flex><span>PAYMENT_TYPE_CHOICES <span style=color:#ff79c6>=</span> [(<span style=color:#f1fa8c>&#39;card&#39;</span>, <span style=color:#f1fa8c>&#39;신용카드&#39;</span>)]
</span></span></code></pre></td></tr></table></div></div><p>❗️ type이란 명칭은 파이썬의 내장 함수 type()에 사용되는 예약어이기 때문에 수정사항에 해당된다.</p><h1 id=heading-6><a hidden class=anchor aria-hidden=true href=#heading-6>#</a></h1><h2 id=16-status>1.6 status<a hidden class=anchor aria-hidden=true href=#16-status>#</a></h2><p>&lsquo;결제 상태&rsquo;를 말한다. 결제 객체를 생성 후 중간 중간 과정을 저장하는 게 중요하기 때문이다. 이 저장된 값에 따라서 결제가 어떻게 중단되었고, 어디서 중단되었는지 알 수 있기 때문이다. 또한, 결제가 정확하게 이뤄졌는지 판단할 수 있다.</p><p>처음에는 이 또한 IntegerField를 사용하여 choices를 다음과 같이 만들었다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#6272a4># status choices</span>
</span></span><span style=display:flex><span>IS_DONE <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>
</span></span><span style=display:flex><span>IS_AWAITING <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>IS_CANCELLED <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>STATUS_CHOICES <span style=color:#ff79c6>=</span>[
</span></span><span style=display:flex><span>        {IS_DONE, <span style=color:#f1fa8c>&#39;결제완료&#39;</span>},
</span></span><span style=display:flex><span>        {IS_AWAITING, <span style=color:#f1fa8c>&#39;결제대기&#39;</span>},
</span></span><span style=display:flex><span>        {IS_CANCELLED, <span style=color:#f1fa8c>&#39;결제취소&#39;</span>}
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>status <span style=color:#ff79c6>=</span> models<span style=color:#ff79c6>.</span>IntegerField(choices<span style=color:#ff79c6>=</span>STATUS_CHOICES, default<span style=color:#ff79c6>=</span>IS_AWAITING, verbose_name<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;결제상태&#39;</span>)
</span></span></code></pre></td></tr></table></div></div><p>하지만 이럴 경우, 아임포트와 연동하는 과정에서 혼란스러웠기 때문에 아임포트에서 전달하는 상태 값을 최대한 그대로 사용하는 게 낫다는 판단을 하여 CharField를 사용했다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>STATUS_CHOICES <span style=color:#ff79c6>=</span>[
</span></span><span style=display:flex><span>                 {<span style=color:#f1fa8c>&#39;await&#39;</span>, <span style=color:#f1fa8c>&#39;결제대기&#39;</span>},
</span></span><span style=display:flex><span>                 {<span style=color:#f1fa8c>&#39;paid&#39;</span>, <span style=color:#f1fa8c>&#39;결제성공&#39;</span>},
</span></span><span style=display:flex><span>                 {<span style=color:#f1fa8c>&#39;failed&#39;</span>, <span style=color:#f1fa8c>&#39;결제실패&#39;</span>},
</span></span><span style=display:flex><span>                 {<span style=color:#f1fa8c>&#39;cancelled&#39;</span>, <span style=color:#f1fa8c>&#39;결제취소&#39;</span>}
</span></span><span style=display:flex><span>                ]
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>status <span style=color:#ff79c6>=</span> models<span style=color:#ff79c6>.</span>CharField(verbose_name<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;결제상태&#39;</span>, default<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#39;await&#39;</span>, 
</span></span><span style=display:flex><span>choices<span style=color:#ff79c6>=</span>STATUS_CHOICES, max_length<span style=color:#ff79c6>=</span><span style=color:#bd93f9>10</span>)
</span></span></code></pre></td></tr></table></div></div><p>max_length는 <code>cancelled</code> 를 고려하여 10으로 설정했다.</p><p> </p><hr><h1 id=2-iamportpy-작성-시-고려사항>2. Iamport.py 작성 시 고려사항<a hidden class=anchor aria-hidden=true href=#2-iamportpy-작성-시-고려사항>#</a></h1><p>iamport.py 는 아임포트 github에서 제공하는 함수를 그대로 가져온 게 아니라, 이를 참고로 나만의 방식으로 작성했다.</p><h3 id=imp_key와-imp_secret>IMP_KEY와 IMP_SECRET<a hidden class=anchor aria-hidden=true href=#imp_key와-imp_secret>#</a></h3><p><code>IMP_KEY</code>와 <code>IMP_SECRET</code> 값을 가리키는 인스턴스 변수들을 생성자에 포함시켜서 해당 클래스를 가져와서 변수를 인스턴스화할 때, 별도의 KEY와 SECRET 값을 받지 않도록 설계했다.</p><h3 id=아임포트-api-url을-클래스-변수로-만들기>아임포트 api url을 클래스 변수로 만들기<a hidden class=anchor aria-hidden=true href=#아임포트-api-url을-클래스-변수로-만들기>#</a></h3><p>아임포트 api url에서 protocol + host 부분은 클래스 변수로 만들어서 복잡한 url을 보다 가독성 좋고 알아보기 쉽게 만들었다.</p><h3 id=아임포트-응답-성공일-때-code의-값>아임포트 응답 성공일 때, &lsquo;code&rsquo;의 값<a hidden class=anchor aria-hidden=true href=#아임포트-응답-성공일-때-code의-값>#</a></h3><p>아임포트에서 응답을 보낼 때 &lsquo;code&rsquo;라는 key의 대응되는 값이 0이므로 단지 0으로 두기보다는 <code>response_success</code>라는 변수가 가리키도록 하여 가독성 부분도 고려했다.</p><h3 id=request-module>request module<a hidden class=anchor aria-hidden=true href=#request-module>#</a></h3><p>아임포트에 url에 데이터를 전달할 때는 <code>request</code> module을 사용했다.</p><p>❗️ 위 부분이 반복되기 때문에 프로젝트를 다시 착수할 때 별도의 메서드로 함수화할 예정이다.</p><h3 id=status-code>status code<a hidden class=anchor aria-hidden=true href=#status-code>#</a></h3><p>status code 부분은 400번대가 존재하는데 아임포트 api 문서에서 실패 시 반환하는 status code를 그대로 가져왔기 때문이다.</p><p> </p><hr><h1 id=3-modelsmanager-작성-시-고려사항>3. models.Manager 작성 시 고려사항<a hidden class=anchor aria-hidden=true href=#3-modelsmanager-작성-시-고려사항>#</a></h1><h3 id=modelsmanager를-사용한-이유>models.Manager를 사용한 이유<a hidden class=anchor aria-hidden=true href=#modelsmanager를-사용한-이유>#</a></h3><p>models.Manager를 사용한 이유는 로직을 view에서 처리하면 너무 길어지기 때문에, 이보다는 해당 Manager model에서 만든 쿼리 메서드를 만들어서 사용하는 게 관리의 관점에서 낫다고 판단했기 때문이다.</p><ul><li><a href=https://docs.djangoproject.com/en/4.0/topics/db/managers/>models.Manager 관련 django docs</a></li></ul><h3 id=manager-name>Manager name<a hidden class=anchor aria-hidden=true href=#manager-name>#</a></h3><p>공식문서를 참고하여 Manager의 이름은 <code>&lt;이 모델 매니저를 사용할 모델명>Manager</code>로 작명한다. 그리고 이 Manager를 사용할 모델에 objects에 할당한다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>Payments</span>(models<span style=color:#ff79c6>.</span>Model):
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>    objects <span style=color:#ff79c6>=</span> PaymentsManager()
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>...</span>
</span></span></code></pre></td></tr></table></div></div><p> </p><hr><h1 id=4-db에-저장되는-결제-정보-시간대-설정>4. DB에 저장되는 결제 정보 시간대 설정<a hidden class=anchor aria-hidden=true href=#4-db에-저장되는-결제-정보-시간대-설정>#</a></h1><p>결제 시간을 저장하기 위해서 DateTimeField를 사용했다.</p><p>저장된 결제 시간을 보니 실제 결제 시간과 DB에 저장된 시간이 다른 issue가 발생했다.</p><p><a href=https://docs.djangoproject.com/el/1.10/ref/settings/#std:setting-TIME_ZONE>Django docs - TIME_ZONE</a>를 보면 settings.py에 <code>TIME_ZONE</code>이 정의되어 있지않으면, default 값으로 <code>America/Chicago</code> 로 설정되는 걸 알 수 있다.</p><p>그래서 다음 두 가지 설정을 추가해본다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#6272a4># settings.py</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TIME_ZONE <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;Asia/Seoul</span>
</span></span><span style=display:flex><span>USE_TZ <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>False</span>
</span></span></code></pre></td></tr></table></div></div><p><code>USE_TZ</code> 가 True이면 default 값으로 time zone이 인식된다. 그래서 이 부분을 False로 변경한다.</p><p>그리고, <code>TIME_ZONE</code>에 무슨 값을 세팅할지 알지 못해서 구글링을 통해 확인했다. 나중에 위 문서를 보니
<a href=https://en.wikipedia.org/wiki/List_of_tz_database_time_zones>list of time zones</a>에 목록들이 나와있는 걸 확인했다.</p><p> </p><hr><h1 id=5-post_saveconnect>5. post_save.connect()<a hidden class=anchor aria-hidden=true href=#5-post_saveconnect>#</a></h1><h2 id=post_saveconnect를-택한-이유와-역할>post_save.connect를 택한 이유와 역할<a hidden class=anchor aria-hidden=true href=#post_saveconnect를-택한-이유와-역할>#</a></h2><h3 id=이유>이유<a hidden class=anchor aria-hidden=true href=#이유>#</a></h3><p>post_save.connect()를 사용한 이유는 2가지다.</p><ul><li>첫 번째: Payment 모델 객체에 관한 것이기 때문에, models.py 에서 처리하길 원했다.</li><li>두 번째: Payment 모델 save()가 실행되면 자동적으로 payment_validation을 체크하여 아임포트와 로컬 DB에 존재하는지 자동적으로 체크하길 원했다.</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>from</span> django.db.models.signals <span style=color:#ff79c6>import</span> post_save
</span></span><span style=display:flex><span><span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>post_save<span style=color:#ff79c6>.</span>connect(payment_validation, sender<span style=color:#ff79c6>=</span>Payment)
</span></span></code></pre></td></tr></table></div></div><h3 id=역할>역할<a hidden class=anchor aria-hidden=true href=#역할>#</a></h3><p><a href=https://docs.djangoproject.com/en/4.1/ref/signals/>docs Django - Signals</a>를 참고하면 post_save는 model 객체에 대해 save() method가 실행된 후, method가 실행되도록 신호를 보낸다.</p><p>Payment model이 저장되면 위 코드를 사용하여 payment_validation 함수를 실행한다. 만약 payment_id가 존재할 경우, 아임포트 내에서 찾은 결제 내역이 실제 모델에도 존재하는지를 확인한다. 한 곳이라도 없으면 &lsquo;비정상 거래&rsquo; 임을 알리는 역할을 수행한다.</p><p> </p><h2 id=post_saveconnect의-내부-원리>post_save.connect의 내부 원리<a hidden class=anchor aria-hidden=true href=#post_saveconnect의-내부-원리>#</a></h2><h3 id=post_saveconnect-실행-전체-순서>post_save.connect 실행 전체 순서<a hidden class=anchor aria-hidden=true href=#post_saveconnect-실행-전체-순서>#</a></h3><ol><li>post_save.connect(receiver, sender)를 통해서 sender와 receiver를 Signal.connect()에 전달하여 sender와 receiver가 실행이 순차적으로 되도록 연결시키는 단계</li><li>model.save()가 실행되어 Signal.send(sender)가 실행</li><li>Signal.send(sender)에서 Signal._live_receiver(sender)가 호출된다. 그 결과 sender에 연결된 receiver들을 반환하고, 각 receiver들을 실행시킨다.</li></ol><h3 id=modelsignal-class-and-partial-class>ModelSignal class and partial class<a hidden class=anchor aria-hidden=true href=#modelsignal-class-and-partial-class>#</a></h3><blockquote><p><strong><em>model 객체인 sender 그리고, receiver를 받아서 partial class를 통해 Signal.connect에 전달하기</em></strong></p></blockquote><p>model.save()가 실행되기 전에 receiver와 sender를 미리 연결하기 위해서 Signal.connect에 전달하는 단계다.</p><p>그러면 그후, model.save()가 실행되어 sender가 실행될 때, receiver가 실행된다.</p><p>post_save는 다음과 같이 ModelSignal class의 인스턴스다. 그래서 이 인스턴스에 접근하여 인스턴스 메서드인 connect가 실행된다. connect에서 받은 인자들을 _lazy_method에 전달한다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#6272a4># signals.py</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>ModelSignal</span>(Signal):
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>_lazy_method</span>(self, method, apps, receiver, sender, <span style=color:#ff79c6>**</span>kwargs):
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>        partial_method <span style=color:#ff79c6>=</span> partial(method, receiver, <span style=color:#ff79c6>**</span>kwargs)
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#8be9fd;font-style:italic>isinstance</span>(sender, <span style=color:#8be9fd;font-style:italic>str</span>):
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> partial_method(sender)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>connect</span>(self, receiver, sender<span style=color:#ff79c6>=</span><span style=color:#ff79c6>None</span>, weak<span style=color:#ff79c6>=</span><span style=color:#ff79c6>True</span>, dispatch_uid<span style=color:#ff79c6>=</span><span style=color:#ff79c6>None</span>, apps<span style=color:#ff79c6>=</span><span style=color:#ff79c6>None</span>):
</span></span><span style=display:flex><span>        self<span style=color:#ff79c6>.</span>_lazy_method(
</span></span><span style=display:flex><span>            <span style=color:#8be9fd;font-style:italic>super</span>()<span style=color:#ff79c6>.</span>connect, apps, receiver, sender,
</span></span><span style=display:flex><span>            weak<span style=color:#ff79c6>=</span>weak, dispatch_uid<span style=color:#ff79c6>=</span>dispatch_uid,
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>post_save <span style=color:#ff79c6>=</span> ModelSignal(use_caching<span style=color:#ff79c6>=</span><span style=color:#ff79c6>True</span>)
</span></span></code></pre></td></tr></table></div></div><p>받은 인자는 아래 코드대로 self를 사용하여 같은 클래스의 메서드를 호출하여 전달된다. 아래에서 super()는 Signal 상위 클래스를 말한다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>self<span style=color:#ff79c6>.</span>_lazy_method(method<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>super</span>()<span style=color:#ff79c6>.</span>connect, apps<span style=color:#ff79c6>=</span><span style=color:#ff79c6>None</span>, receiver<span style=color:#ff79c6>=</span>payment_validation, sender<span style=color:#ff79c6>=</span>Payment, <span style=color:#ff79c6>...</span>)
</span></span></code></pre></td></tr></table></div></div><p>그러면 partial_method 인스턴스 객체를 만든다. 이 때 partial class 내부의 <code>__new__</code> method가 실행되서 다음과 같이 func과 args 속성이 각각 method와 receiver를 가리킨다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>partial_method <span style=color:#ff79c6>=</span> partial(method<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>super</span>()<span style=color:#ff79c6>.</span>connect, receiver<span style=color:#ff79c6>=</span>payment_validation)
</span></span><span style=display:flex><span>partial_method<span style=color:#ff79c6>.</span>func <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>super</span>()<span style=color:#ff79c6>.</span>connect
</span></span><span style=display:flex><span>partial_method<span style=color:#ff79c6>.</span>args <span style=color:#ff79c6>=</span> payment_validation
</span></span></code></pre></td></tr></table></div></div><p>그 다음으로 <code>_lazy_method</code> method는 객체가 문자열 유무에 따라 분기가 되는데, Payment의 type()은 str이 아니고, <code>&lt;class 'django.db.models.base.ModelBase'></code> 이므로, <code>partial_method(sender=Payment)</code>를 실행한다.</p><p><code>partial_method(sender=Payment)</code> 실행되면 &lsquo;partial class&rsquo;의 <code>__call__</code> method가 호출된다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>def</span> __call__(self, <span style=color:#ff79c6>/</span>, <span style=color:#ff79c6>*</span>args, <span style=color:#ff79c6>**</span>keywords):
</span></span><span style=display:flex><span>    keywords <span style=color:#ff79c6>=</span> {<span style=color:#ff79c6>**</span>self<span style=color:#ff79c6>.</span>keywords, <span style=color:#ff79c6>**</span>keywords}
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> self<span style=color:#ff79c6>.</span>func(<span style=color:#ff79c6>*</span>self<span style=color:#ff79c6>.</span>args, <span style=color:#ff79c6>*</span>args, <span style=color:#ff79c6>**</span>keywords)
</span></span></code></pre></td></tr></table></div></div><p>위의 각 매개변수는 다음을 의미한다.</p><ul><li>self.func: super().connect -> Signal.connect</li><li>*self.args: payment_validation</li><li>*args: Payment</li></ul><h3 id=signalconnect>Signal.connect<a hidden class=anchor aria-hidden=true href=#signalconnect>#</a></h3><blockquote><p><strong><em>전달받은 sender와 receiver를 매핑하는 단계</em></strong></p></blockquote><p>그러면 <code>self.func(*self.args, *args, **keywords)</code>가 어떻게 실행되는지 알아보자.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>self<span style=color:#ff79c6>.</span>lock <span style=color:#ff79c6>=</span> threading<span style=color:#ff79c6>.</span>Lock()
</span></span><span style=display:flex><span>self<span style=color:#ff79c6>.</span>sender_receivers_cache <span style=color:#ff79c6>=</span> weakref<span style=color:#ff79c6>.</span>WeakKeyDictionary() <span style=color:#ff79c6>if</span> use_caching <span style=color:#ff79c6>else</span> {}
</span></span><span style=display:flex><span>self<span style=color:#ff79c6>.</span>_dead_receivers <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>def</span> <span style=color:#50fa7b>connect</span>(self, receiver, sender<span style=color:#ff79c6>=</span><span style=color:#ff79c6>None</span>, weak<span style=color:#ff79c6>=</span><span style=color:#ff79c6>True</span>, dispatch_uid<span style=color:#ff79c6>=</span><span style=color:#ff79c6>None</span>):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> dispatch_uid:
</span></span><span style=display:flex><span>            lookup_key <span style=color:#ff79c6>=</span> (dispatch_uid, _make_id(sender))
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>else</span>:
</span></span><span style=display:flex><span>            lookup_key <span style=color:#ff79c6>=</span> (_make_id(receiver), _make_id(sender))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> weak:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>        weakref<span style=color:#ff79c6>.</span>finalize(receiver, self<span style=color:#ff79c6>.</span>_remove_receiver)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>with</span> self<span style=color:#ff79c6>.</span>lock:
</span></span><span style=display:flex><span>        self<span style=color:#ff79c6>.</span>_clear_dead_receivers()
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>not</span> <span style=color:#8be9fd;font-style:italic>any</span>(r_key <span style=color:#ff79c6>==</span> lookup_key <span style=color:#ff79c6>for</span> r_key, _ <span style=color:#ff79c6>in</span> self<span style=color:#ff79c6>.</span>receivers):
</span></span><span style=display:flex><span>            self<span style=color:#ff79c6>.</span>receivers<span style=color:#ff79c6>.</span>append((lookup_key, receiver))
</span></span><span style=display:flex><span>        self<span style=color:#ff79c6>.</span>sender_receivers_cache<span style=color:#ff79c6>.</span>clear()
</span></span></code></pre></td></tr></table></div></div><p><strong>[weakref.finalize()]</strong></p><p>Signal class는 weak라는 변수로 약한 참조와 강한 참조를 구분한다. weak가 True이면 약한 참조를 의미하여, weakref.finalize() class를 통해 receiver가 garbage collector에 의해서 수거될 때 실행할 콜백함수를 등록한다. 여기서 콜백함수는 self._remove_receiver다.</p><p><strong>[dead_receivers]</strong>
만약 receiver가 실행 및 완료되면 <code>self._remove_receiver</code>가 실행되어 <code>self._dead_receivers = True</code> 값으로 변경되어 self.receivers에 dead_receiver가 존재하는 걸 알린다.</p><p>이 dead_receiver는 self.lock이 유지되는 동안 _clear_dead_receivers에 의해서</p><ul><li><ol><li>플래그 변수인 self._dead_receivers를 존재하지 않는다는 의미로 False로 바꾼 후,</li></ol></li><li><ol start=2><li>dead_receivers를 self.receivers에서 제외시킨다.</li></ol></li></ul><p><strong>[sender_receivers_cache]</strong>
dead_receivers 를 clear 후, sender_receivers_cache도 clear 한다.</p><h3 id=connect---send---_live_receivers>connect() -> send() -> _live_receivers()<a hidden class=anchor aria-hidden=true href=#connect---send---_live_receivers>#</a></h3><blockquote><p><strong><em>model.save() 후, Signal.send(sender)를 통해 sender와 연결된 receiver들을 실행</em></strong></p></blockquote><p>model인 sender가 model.save() 되면 send(self, sender)에 의해서 signal을 receiver한테 보내는 과정이 실행된다.</p><p>이 send(self, sender) 안에서 _live_receivers(self, sender)를 호출한다.</p><p>이 <code>_live_receivers()</code>의 역할은 self.sender_receivers_cache에 sender에 대응되는 receiver를 <code>.get(sender)</code>를 사용하여 가져와 send()에 보내준다. 그러면 이 send()에서 sender에 대응되는 receiver를 실행시킨다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>sender: <span style=color:#ff79c6>&lt;</span><span style=color:#ff79c6>class</span> &#39;<span style=color:#50fa7b>pocket</span><span style=color:#ff79c6>.</span>models<span style=color:#ff79c6>.</span>Payment<span style=color:#f1fa8c>&#39;&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># send()의 반환값: [(receiver, response)]</span>
</span></span><span style=display:flex><span>[(<span style=color:#ff79c6>&lt;</span>function payment_validation at <span style=color:#bd93f9>0x10547d510</span><span style=color:#ff79c6>&gt;</span>, <span style=color:#ff79c6>None</span>)]
</span></span></code></pre></td></tr></table></div></div><p>참고 문서: <a href=https://docs.djangoproject.com/en/4.0/topics/signals/#sending-signals>docs Django - signals: sending signals</a></p><p> </p><h2 id=-참고-약한-참조-vs-강한-참조>🔆 참고: 약한 참조 vs 강한 참조<a hidden class=anchor aria-hidden=true href=#-참고-약한-참조-vs-강한-참조>#</a></h2><ul><li><p>약한 참조(Weak reference): 참조수(reference count)를 증가시키지 않는 reference 객체</p></li><li><p>강한 참조(Strong reference): 참조수(reference count)를 증가시키는 reference 객체</p></li><li><p>Garbage collector는 reference count가 0인 경우, 해당 reference 객체를 삭제하고 사용하지 않는 메모리라고 판단하여 해당 메모리를 반환한다.</p><ul><li>그렇다면 약한 참조는 언제든지 GC에 의해서 언제든지 제거될 수 있다.</li><li>강한 참조는 reference count가 0이 되거나 메모리에서 해제될 때 제거된다.</li></ul></li><li><p>Reference count 확인하기</p><ul><li>reference count는 <code>sys.getrefcount(value)</code>를 사용하면 value의 참조 수를 알 수 있다.</li></ul></li></ul><p> </p><hr><h1 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h1><ul><li><a href=https://docs.python.org/ko/3/library/hashlib.html>hashlib - 보안 해시와 메시지 요약</a></li><li><a href=https://namu.wiki/w/SHA>namu.wiki - SHA</a></li><li><a href=https://docs.djangoproject.com/en/4.1/topics/db/models/#field-options>Field options</a></li><li><a href=https://faq.iamport.kr/7e1f6e5f-5e36-4617-b509-c26602079561>최소,최대 결제금액이 얼만지 궁금해요!</a></li><li><a href=https://docs.djangoproject.com/en/4.0/topics/db/managers/>models.Manager 관련 django docs</a></li><li><a href=https://en.wikipedia.org/wiki/List_of_tz_database_time_zones>list of time zones</a></li><li><a href=https://docs.djangoproject.com/en/4.1/ref/signals/>docs Django - Signals</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=http://jeha00.github.io/tags/payment/>payment</a></li></ul><nav class=paginav><a class=prev href=http://jeha00.github.io/post/docker/04_deployment-by-docker/><span class=title>« Prev Page</span><br><span>Docker study: Docker-compose로 nginx, django, postgreSQL을 연결하고 배포하기</span></a>
<a class=next href=http://jeha00.github.io/post/project/devket/django/01_payment_overall_flow/><span class=title>Next Page »</span><br><span>Project: Iamport를 선택한 이유, 사용 시 결제 과정과 장점, 그리고 아임포트 javascript SDK를 사용한 결제 흐름</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Project: Payment 개발 과정에서의 고려사항들과 개발 이슈들 on twitter" href="https://twitter.com/intent/tweet/?text=Project%3a%20Payment%20%ea%b0%9c%eb%b0%9c%20%ea%b3%bc%ec%a0%95%ec%97%90%ec%84%9c%ec%9d%98%20%ea%b3%a0%eb%a0%a4%ec%82%ac%ed%95%ad%eb%93%a4%ea%b3%bc%20%ea%b0%9c%eb%b0%9c%20%ec%9d%b4%ec%8a%88%eb%93%a4&url=http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdjango%2f02_payment_issues%2f&hashtags=payment"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Project: Payment 개발 과정에서의 고려사항들과 개발 이슈들 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdjango%2f02_payment_issues%2f&title=Project%3a%20Payment%20%ea%b0%9c%eb%b0%9c%20%ea%b3%bc%ec%a0%95%ec%97%90%ec%84%9c%ec%9d%98%20%ea%b3%a0%eb%a0%a4%ec%82%ac%ed%95%ad%eb%93%a4%ea%b3%bc%20%ea%b0%9c%eb%b0%9c%20%ec%9d%b4%ec%8a%88%eb%93%a4&summary=Project%3a%20Payment%20%ea%b0%9c%eb%b0%9c%20%ea%b3%bc%ec%a0%95%ec%97%90%ec%84%9c%ec%9d%98%20%ea%b3%a0%eb%a0%a4%ec%82%ac%ed%95%ad%eb%93%a4%ea%b3%bc%20%ea%b0%9c%eb%b0%9c%20%ec%9d%b4%ec%8a%88%eb%93%a4&source=http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdjango%2f02_payment_issues%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Project: Payment 개발 과정에서의 고려사항들과 개발 이슈들 on reddit" href="https://reddit.com/submit?url=http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdjango%2f02_payment_issues%2f&title=Project%3a%20Payment%20%ea%b0%9c%eb%b0%9c%20%ea%b3%bc%ec%a0%95%ec%97%90%ec%84%9c%ec%9d%98%20%ea%b3%a0%eb%a0%a4%ec%82%ac%ed%95%ad%eb%93%a4%ea%b3%bc%20%ea%b0%9c%eb%b0%9c%20%ec%9d%b4%ec%8a%88%eb%93%a4"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Project: Payment 개발 과정에서의 고려사항들과 개발 이슈들 on facebook" href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdjango%2f02_payment_issues%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Project: Payment 개발 과정에서의 고려사항들과 개발 이슈들 on whatsapp" href="https://api.whatsapp.com/send?text=Project%3a%20Payment%20%ea%b0%9c%eb%b0%9c%20%ea%b3%bc%ec%a0%95%ec%97%90%ec%84%9c%ec%9d%98%20%ea%b3%a0%eb%a0%a4%ec%82%ac%ed%95%ad%eb%93%a4%ea%b3%bc%20%ea%b0%9c%eb%b0%9c%20%ec%9d%b4%ec%8a%88%eb%93%a4%20-%20http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdjango%2f02_payment_issues%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Project: Payment 개발 과정에서의 고려사항들과 개발 이슈들 on telegram" href="https://telegram.me/share/url?text=Project%3a%20Payment%20%ea%b0%9c%eb%b0%9c%20%ea%b3%bc%ec%a0%95%ec%97%90%ec%84%9c%ec%9d%98%20%ea%b3%a0%eb%a0%a4%ec%82%ac%ed%95%ad%eb%93%a4%ea%b3%bc%20%ea%b0%9c%eb%b0%9c%20%ec%9d%b4%ec%8a%88%eb%93%a4&url=http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdjango%2f02_payment_issues%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=http://jeha00.github.io/>Jeha DevLog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>