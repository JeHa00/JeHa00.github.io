<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Project: Iamport를 선택한 이유, 사용 시 결제 과정과 장점, 그리고 아임포트 javascript SDK를 사용한 결제 흐름 | Jeha DevLog</title><meta name=keywords content="iamport"><meta name=description content="기존 결제 과정과 iamport를 사용 시 변한 결제 과정을 정리하고, iamport 사용 시 얻는 장점들에 대해 정리해본다. 마지막으로 프로젝트에서 아임포트 javascript SDK를 사용한 결제 흐름을 정리해본다."><meta name=author content><link rel=canonical href=http://jeha00.github.io/post/project/devket/django/01_payment_overall_flow/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.min.268b216eea772711d318d156ce02a8190962367a0bf469fa9a959114ea6b9ca3.css integrity="sha256-Joshbup3JxHTGNFWzgKoGQliNnoL9Gn6mpWRFOprnKM=" rel="preload stylesheet" as=style><link rel=icon href=http://jeha00.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://jeha00.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://jeha00.github.io/favicon-32x32.png><link rel=apple-touch-icon href=http://jeha00.github.io/apple-touch-icon.png><link rel=mask-icon href=http://jeha00.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.101.0"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Project: Iamport를 선택한 이유, 사용 시 결제 과정과 장점, 그리고 아임포트 javascript SDK를 사용한 결제 흐름"><meta property="og:description" content="기존 결제 과정과 iamport를 사용 시 변한 결제 과정을 정리하고, iamport 사용 시 얻는 장점들에 대해 정리해본다. 마지막으로 프로젝트에서 아임포트 javascript SDK를 사용한 결제 흐름을 정리해본다."><meta property="og:type" content="article"><meta property="og:url" content="http://jeha00.github.io/post/project/devket/django/01_payment_overall_flow/"><meta property="og:image" content="http://jeha00.github.io/47"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-12-04T14:56:16+09:00"><meta property="article:modified_time" content="2022-12-04T14:56:16+09:00"><meta property="og:site_name" content="JeHa00 DevLog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://jeha00.github.io/47"><meta name=twitter:title content="Project: Iamport를 선택한 이유, 사용 시 결제 과정과 장점, 그리고 아임포트 javascript SDK를 사용한 결제 흐름"><meta name=twitter:description content="기존 결제 과정과 iamport를 사용 시 변한 결제 과정을 정리하고, iamport 사용 시 얻는 장점들에 대해 정리해본다. 마지막으로 프로젝트에서 아임포트 javascript SDK를 사용한 결제 흐름을 정리해본다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://jeha00.github.io/post/"},{"@type":"ListItem","position":2,"name":"Project: Iamport를 선택한 이유, 사용 시 결제 과정과 장점, 그리고 아임포트 javascript SDK를 사용한 결제 흐름","item":"http://jeha00.github.io/post/project/devket/django/01_payment_overall_flow/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Project: Iamport를 선택한 이유, 사용 시 결제 과정과 장점, 그리고 아임포트 javascript SDK를 사용한 결제 흐름","name":"Project: Iamport를 선택한 이유, 사용 시 결제 과정과 장점, 그리고 아임포트 javascript SDK를 사용한 결제 흐름","description":"기존 결제 과정과 iamport를 사용 시 변한 결제 과정을 정리하고, iamport 사용 시 얻는 장점들에 대해 정리해본다. 마지막으로 프로젝트에서 아임포트 javascript SDK를 사용한 결제 흐름을 정리해본다.","keywords":["iamport"],"articleBody":"0. Introduction 이 repository는 현재 러닝스푼즈 나노디그리 - django backend 부트캠프에서 팀 프로젝트를 진행하면서 다음과 같은 내용들에 대해 정리하고자 만들었습니다.\n팀 정책을 이것으로 정한 이유 개발하면서 부딪힌 문제들에 대한 원인, 해결방안, 해결과정, 그리고 그 이유들 이번 포스팅에서는 제가 맡은 결제 기능의 전체적인 프로세스와 아임포트를 사용하면서 이 과정이 어떻게 변하는 지에 대해 설명하겠습니다.\n1. 기존 결제 과정 결제의 기본 진행 과정: 인증 -\u003e 결제 순서로 진행\n하지만, 한국에서는 이 인증 부분에서 차이가 있다. 한국에서 카드 결제 과정은 다음과 같다. 왜냐하면 한국에서는 카드 정보(카드 번호 / 유효기간 / cvc )를 일부 가맹점 또는 PG 사를 제외하고는 저장할 수 없기 때문이다. 카드 정보는 오로지 카드사에서만 저장 가능하다.\n카드사 서버가 구매자 브라우저로부터 직접 카드 정보를 전달받아 인증처리하는 게 다른 나라와 가장 큰 차이이다.\n이 카드 인증된 결과를 바탕으로 결제 프로세스가 진행된다. 결제 프로세스는 3번부터 8번까지의 과정을 말한다.\n출처: 아임포트 공식문서 - webhook\nPG 사에서 저장할 수 없도록 만든 방법 출처: 아임포트 공식문서 - webhook\n그래서 결제를 진행할 때 PG 사의 결제 모달 창이 뜬 후, 카드사를 클릭하면 또 다른 모달 창이 뜬다.\n이것이 PG 사에서 카드 정보를 저장하지 못하도록 하기 위함이다.\n그래서 PG 결제 모듈 창을 띄우고 나서 결제 과정의 첫 시작인 ‘인증’ 과정이 시작될 수 있다.\n2. Iamport 선택 이유와 장점 Iamport 사용 시 결제 과정 출처: 아임포트 공식문서 - webhook\n아임 포트를 선택한 이유 PG 사와의 복잡한 연동 과정 해소 직접 api로 만들어야하는 많은 부분을 아임포트가 대신 해주기 때문에, 짧은 기간 안에 결제 기능을 추가하기 좋은 라이브러리로서, 경험이 없는 학습자가 사용하기에 보다 퀄리티에 집중할 수 있다.\n직접 PG 서버와 통신해야 했던 가맹점 서버의 역할을 대신한다. PG 서버와 직접 통신하기 위해서 PG가 지원하는 제한적인 개발환경을 사용해야하고, PG 모듈을 설치하는 등 절차가 복잡했지만, 아임포트를 사용하면서 간결하고 REST API를 통해 쉽게 결제를 연동할 수 있다.\n위 이미지의 1, 2, 5, 7번 과정만 신경쓰면 된다. 카드정보가 잘못되었다면 카드사 모듈 창에서 입력 시, 인증 오류가 날 것이다. 결제 정보가 잘못되었다던가, 카드 한드가 초과되었다던가, 사용자 변심으로 결제가 취소했다면 결제 단계에서 에러가 난다.\n결제 기능 확장성 토스에서도 결제 API를 제공한다. 하지만, 나중에 ‘구독’이란 정기 결제를 도입할 상황에서 아임포트는 정기 결제 기능을 제공하고 토스에서는 그렇지 않기 때문에, 추후 결제 기능 확장성을 고려할 때 아임포트를 선택했다.\n편리한 복수 PG 사용 연동되는 PG 선택도 iamport admin에서 로그인하여 테스트 버전으로 자유롭게 선택할 수 있다.\n잘 정리된 api 문서 아임포트 api 문서 를 보면 아임포트 API가 체계적으로 정리되어 있다.\n적절한 api url에 필요한 정보만 보내면 결제 정보를 조회할 수 있다.\n3. 아임포트 Javascript SDK를 사용한 결제 흐름 아임포트 결제 연동 서비스를 사용하기 위해서는 아임포트 Javascript SDK(Software Development Kit)를 사용해야 한다. 이 SDK를 통해서 내가 생성한 주문번호와 금액을 아임포트에 전달하고, 아임포트는 결제 번호를 나에게 전달한다.\n그래서 이 SDK를 통해 결제 각 단계에서의 데이터 처리를 js function을 통해서 해당 api로 데이터를 전달하기 위해서 fetch를 사용했다. 그리고, 이 view에서 model에 접근하여 고유 주문 번호, 결제 상태, 결제 금액 등의 정보를 저장한다. model에 접근할 때는 ModelManager를 사용하여 해당 Model 객체만의 ORM을 만들었다.\n3.1 결제 프로세스 과정 순서 해당 프로젝트에서 설계한 결제 프로세스의 전체 흐름은 다음 이미지와 같다.\n1), 2) 결제 버튼 클릭 및 call-payment.js 실행 아래 이미지의 ‘이 옵션 선택’ 태그를 클릭하여 call-payment.js를 실행한다.\n❗️ 원래 사이트에서는 월간 멤버쉽과 연간 멤버쉽 둘 다 존재했다. 하지만, 월간 멤버쉽만 고려한 이유는 1차로 결제 자체 기능만 구현한 후, 그 다음으로 월간 멤버쉽만을 추가로 구현할 계획이기 때문이다.\ncall-payment.js의 전체 소스 코드를 보고 싶다면 이 링크를 클릭한다.\n위 이미지의 버튼은 .order이라는 클래스 명을 가지고 있기 때문에 이를 통해서 DOM을 인식하여 event를 건다.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 import {getElement ,setFetchData} from './common.js'; window.onload = function () { const IMP = window.IMP; IMP.init('imp62676076'); const paymentButton = getElement('.order') paymentButton.addEventListener('click', async (e) =\u003e { const type = 'card'; let buyer_name, buyer_email, merchant_id, amount, payment_info; payment_info = await passPaymentInfo(e, type); [buyer_name, buyer_email, merchant_id, amount] = payment_info if (merchant_id !== '' \u0026\u0026 merchant_id !== undefined) { ... } return false; }) }; 3) 가맹점 식별코드로 IMP 객체 초기화 ‘call-payment.js’가 실행되면서 제일 먼저 하는 건 ‘가맹점 식별코드’로 인한 초기화 작업이다. ‘가맹점 식별코드’는 아임포트를 가입할 때 IMP_KEY와, IMP_SECRET 그리고 가맹점 식별코드인 MERCHANT_ID가 제공된다. 이 MERCHANT_ID를 입력해야 한다. IMP_KEY와 IMP_SECRET은 아임포트에 접근하기 위한 토큰을 받기 위해서 필요하다.\n4) passPaymentInfo 함수 실행 IMP.request_pay()에 전달하기 위한 merchant_id(고유 주문 번호), buyer_name, buyer_email을 backend에서 받아내는 함수\n이벤트가 발생 시, call-payment.js에서 가장 먼저 실행되는 함수다. 그 이유는 아임포트 api에 전달할 merchant_id (고유 주문 번호)를 생성하고, amount(결제 금액)와 함께 전달하기 위해서다.\nargument(or parameter)로 받은 type은 결제 방식을 말한다. 현재 개발 단계에서는 카드 결제만 고려하고 있기 때문에 const type = 'card'로 정해져있다.\n[4-1, 4-2] 과정 merchant_id를 생성하기 위해서 정해놓은 /api/payment/checkout 으로 fetch를 사용하여 data를 보낸다. 그러면 urls.py 에 의해서 이 api url과 mapping된 django view class로 request를 보낸다. 이 api url과 연결된 class는 PaymentPassView 다. [4-5] 과정 PaymentPassView에서 보낸 response에서 json형태로 데이터를 뽑아낸다. .works는 아임포트 api에서 응답 결과를 알려주는 key 값이다. 아임포트에서 응답이 성공했으면 \"works\": True로, 실패하면 False로 값이 온다. 그래서 works가 True이면 view class에서 원하는 값을 받은 것이기 때문에, 이 경우 unpacking을 사용하고자 배열의 형태로 결과값을 반환했다.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // IMP.request_pay를 호출하기 위한 merchant_id 반환 async function passPaymentInfo(e, type) { e.preventDefault(); let merchant_id = '' let amount = 0 let buyer_name = '' let buyer_email = '' const data = setFetchData('POST', { amount: amount, type: type }) const response = await fetch(`/api/payment/checkout`, data) const result = await response.json() if (result.works) { buyer_name = result.buyer_name buyer_email = result.buyer_email merchant_id = result.merchant_id amount = result.amount return [buyer_name, buyer_email, merchant_id, amount] } else if (response.status === 401) { alert('로그인 해주세요.') } else { alert('문제가 발생했습니다. 다시 시도해주세요.') }}; 그러면 PaymentPassView class에서 어떻게 merchant_id를 생성하여 반환하는지 알아보자.\n로그인 후, 결제를 시도하면 다음 ORM으로 user과 email를 조회한다.\n1 2 3 user = User.objects.get(id=kwards['user_id']) buyer_email = Email.objects.get(user=user).email # Email model에서 email은 회원가입 시 사용한 이메일을 말한다. 그 후, 이 객체 정보를 사용하여 merchant_id를 생성한다.\n1 2 3 4 5 merchant_id = Payment.objects.create_new( user=user, amount=amount, type=payment_type, ) [4-3 ~ 4-5 과정] (4-3) class PaymentManager\nPayment만의 orm을 사용하기 위해 만든 PaymentManager를 통해서 merchant_id를 생성한다. (4-4) import.py \u0026 Payment object 생성\n그후, 이 merchant_id와 amount를 아임포트에 전달한다. PaymentManager의 클래스 변수로 선언한 imp를 사용하여 prepare_payments method를 통해 생성한 merchant_id를 amount와 함께 아임포트에 전달한다. 이 때 전달하는 아임포트 api url은 {아임포트 기본 api url}/payments/prepare 이다. 그 다음에 payment 객체를 새롭게 생성한다. 1 2 3 4 5 6 7 8 9 10 11 class PaymentManager(models.Manager): imp = Iamport() def create_new(self, user, amount, type): ... # 아임포트에 전달 PaymentManager.imp.prepare_payments(merchant_id, amount) # 새로운 payment 객체 생성 new_payment = self.model(user=user, merchant_id=merchant_id, amount=int(amount), type=type) (4-5) class PaymentPassView\nPaymentManager의 create_new에서 반환한 merchant_id와 함께 필요한 정보들을 call-payments.js의 passPaymentInfo function에 response를 보낸다. 5) IMP.request_pay()에 결제 정보 전달 이전 단계에서 보낸 amount, merchant_id, pay_method, buyer_name, buyer_email와 함께 어느 pg사를 호출할 것인지 pg key 값에 value로 입력해야 한다. 이는 아임포트 공식문서를 참고한다.\npg사로는 KG 이니시스를 선택했는데, 그 이유로는 웹표준으로서 브라우저 제약 없이 결제가 가능하기 때문이다.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 if (merchant_id !== '' \u0026\u0026 merchant_id !== undefined) { IMP.request_pay({ pg: 'html5_inicis', // KG 이니시스 merchant_uid: merchant_id, name: 'Devket Premium 서비스', pay_method: 'card', amount: amount, buyer_name : buyer_name, buyer_email : buyer_email }, // 결제창 오픈 function (response) { if (response.success) { ... } else { ... } }); } 6) PG사의 결제창 오픈 및 카드사 선택하여 결제 진행 다음과 같은 KG 이니시스의 결제창이 떠서 결제가 진행된다.\n7), 8) 결제 성공: storeImpIdInDB 함수 실행 -\u003e redirect 결제가 성공하여 아임포트에서 받은 imp_uid를, 생성했던 payment 객체에 imp_id로서 결제 상태를 저장하고, User 객체의 결제 상태를 변경하는 함수\n(7-1) urls.py\nfetch를 사용하여 ‘/api/payment/validation’ api url에 data를 보내면 urls.py에서 이 api url에 mapping된 PaymentImpStoreView로 request가 가도록 한다. (7-2, 7-3, 7-4, 7-5) class PaymentImpStoreView\nrequest로부터 imp_id, amount, merchant_id, status를 가져와 이에 해당하는 payment 정보와 User 정보를 조회한다. 1 2 3 4 class PaymentImpStoreView: ... user = User.objects.get(id=kwards['user_id']) payment = Payment.objects.get(user, merchant_id, amount) 조회 후, payment 객체에 imp_id, status 정보를 저장한다. user 객체에는 기존에 미결제 상태인 것을 ‘결제’ 상태로 변경한다. 1 2 3 4 5 user.payment_status = User.PAYMENT_ON user.save() payment_data = {'payment_id': imp_id, 'status': payment_status} self.check_validation(payment, data=payment_data) ... 그리고, 변경 결과에 따라서 works의 값이 변경되고, 이를 storeImpIdInDB에 전달한다. (7-5 ~ 7-7) 결제 검증하기: payment_validation \u0026 get_transaction\npost_save에 의해서 Payment 객체가 저장되면 결제가 유효한지 검증하는 payment_validation function이 실행된다. 1 post_save.connect(payment_validation, sender=Payment) payment_validation 내부에는 PaymentManager로 정의한 get_transaction 메서드가 있어서, 이를 통해서 iamport 내에 결제 내역이 있는지 확인하여 아임포트에도 존재하고, db에도 다 존재하는지를 확인합니다. 다 존재해야 결제가 올바르게 된 것입니다. [8] 과정- redirect : PG 결제 창에서 결제가 완료되면 다른 화면으로 리다이렉트합니다.\n9) 결제 실패: makeStatusFailure 함수 실행 사용자가 결제 정보를 다 입력하고, 완료버튼만 누르면 되는 상황에서 ‘사용자 변심’으로 결제를 취소할 경우 결제 상태를 반영하는 함수\n(9-1) urls.py\nfetch를 사용하여 ‘/api/payment/failure’ api url에 data를 보내면 urls.py에서 이 api url에 mapping된 PaymentFailedView로 request가 간다. (9-2 ~ 9-5) class PaymentFailedView\nrequest로부터 imp_id 와 merchant_id를 가져와 아래아 같이 객체 조회 및 수정에 사용한다. Payment 객체 조회 및 수정 1 2 3 4 5 6 7 8 9 imp_id = request.data['imp_id'] merchant_id = request.data['merchant_id'] # Payment 객체 조회 payment = Payment.objects.get(merchant_id= merchant_id) # Payment 객체 정보 수정 payment_data = {'payment_id': 'imp_id', 'status': 'failed'} serializer = PaymentSerializer(payment, data=payment_data, partial=True) 처리 결과에 따라서 \"works\"의 값을 True, False로 바꿔서 Response를 보낸다. 10) 결제 실패 안내문 9)의 경우처럼 사용자 변심으로 결제 실패한 경우와 그 외의 실패했을 때 다음과 같이 alert를 사용하여 안내한다.\n1 2 3 4 5 6 7 8 9 else { if (response.imp_uid) { // 결제한 유저의 이름과 이메일 확인 후, 사용자 변심으로 결제 창을 닫아 결제 취소되는 로직 makeStatusFailure(e, response.merchant_uid, response.imp_uid); } let msg = '결제에 실패하였습니다. \\n'; msg += '에러내용: ' + response.error_msg; alert(msg) } 3.2 결제 프로세스에서 고려한 발생할 수 있는 상황들 결제 기능에서 중요하고 어려운 것은 다음 3가지라고 생각한다.\n내부 정책에 따라서 무엇보다 여러 상황에 대해서 고려해보고 이에 대해 어떻게 코드를 짰는지 배달을 하는 e-commerce처럼 장바구니, 배달, 쿠폰 할인 같은 여러 모델들이 엮어져야 복잡해지는 상황 대규모 트래픽 상황에서 많은 사용자들이 동시에 결제 요청들이 들어올 때 이를 얼마나 빠르고 정확하게 처리하는지 하지만, 현재 프로젝트는 단지 구독 같은 개념이고, e-commerce처럼 복잡하지 않다. 또한, 트래픽이 거의 없는 상황이다. 그래서 내가 최대한 고려할 것은 첫 번째 경우라고 생각한다.\n이런 상황에서 최대한 내가 생각해낼 수 있는 결제 상황들에 대해 정리해보려고 한다.\n고려한 결제 상황 merchant_id imp_id status x x failed (1) o x await (2) o x failed (3) o o failed (4) o o paid (5) 로그인 전 =\u003e\n로그인 전 결제를 시도할려고 한다면 alert()를 사용하여 결제 후 시도하라는 안내문이 뜬다. 로그인 후 =\u003e\n(1) 새로운 객체를 생성하는데 실패하여, PG 결제 창이 뜨지 못한 경우 merchant id와 imp id는 존재하지 않고, 결제 상태는 failed (2) PG 결제 창을 띄웠지만 카드사를 선택하지 않고, 사용자 변심으로 취소했을 경우 =\u003e 결제 실패 merchant id는 존재하지만, imp id는 존재하지 않고, 결제 상태는 await (2) 카드 정보 입력 실패 =\u003e 결제 실패 카드 정보 불일치, 한도 초과, 잔액 부족 등의 사유로 결제가 중단 merchant id는 존재하지만, imp id는 존재하지 않고, 결제 상태는 await (3) 주문 번호가 이미 존재할 경우 =\u003e 결제 실패 주문 번호는 시간에 따라 다른 주문 번호를 생성하도록 했기 때문에, 이미 존재하는 주문 번호가 들어왔다는 건 에러가 발생한 상황을 의미 merchant id는 존재하지만, imp id는 존재하지 않고, 결제 상태는 failed 카드 정보 입력 완료 =\u003e (4) ‘취소’ 버튼 클릭 =\u003e 사용자 변심으로 인한 결제 실패 merchant id, imp id는 존재하지만 결제 상태는 failed (5) ‘완료’ 버튼 클릭 =\u003e 결제 성공 merchant id, imp id는 다 존재하면서 결제 상태는 paid 위의 상황들은 1차 결제 기능 구현 시 고려한 상황이다. 계속해서 환불과 정기 결제를 추가하려고 한다.\n그렇다면 환불 시에는 사용 기간에 따른 환불 정책을 어떻게 세울 것인지, 정기 결제를 도입한다면 결제 기간 몇 일 전에 알림을 주는 것이 사용자 편의성에 좋을텐데 이를 기술적으로 어떻게 구현할지가 고려사항으로 올라온다.\n1차적인 결제 과정에서의 고려사항은 Project: Payment 개발 과정에서의 고려사항들과 개발 이슈들 문서를 참고하도록 한다.\nReference 한국 전자결제 서비스 흐름 Django에서 아임포트를 통해 결제 구현하기 - (1) 아임포트 세팅 및 결제 구조 iamport admin 아임포트 api 문서 ","wordCount":"1941","inLanguage":"en","datePublished":"2022-12-04T14:56:16+09:00","dateModified":"2022-12-04T14:56:16+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://jeha00.github.io/post/project/devket/django/01_payment_overall_flow/"},"publisher":{"@type":"Organization","name":"Jeha DevLog","logo":{"@type":"ImageObject","url":"http://jeha00.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://jeha00.github.io/ accesskey=h title="@Jeha00 (Alt + H)">@Jeha00</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=http://jeha00.github.io/me/ title=About><span>About</span></a></li><li><a href=http://jeha00.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=http://jeha00.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=http://jeha00.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://jeha00.github.io/>Home</a>&nbsp;»&nbsp;<a href=http://jeha00.github.io/post/>Posts</a></div><h1 class=post-title>Project: Iamport를 선택한 이유, 사용 시 결제 과정과 장점, 그리고 아임포트 javascript SDK를 사용한 결제 흐름</h1><div class=post-meta><span title='2022-12-04 14:56:16 +0900 KST'>December 4, 2022</span>&nbsp;|&nbsp;<a href=https://github.com/JeHa00/blog/content/post/Project/Devket/Django/01_Payment_overall_flow.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#0-introduction aria-label="0. Introduction">0. Introduction</a></li><li><a href=#1-%ea%b8%b0%ec%a1%b4-%ea%b2%b0%ec%a0%9c-%ea%b3%bc%ec%a0%95 aria-label="1. 기존 결제 과정">1. 기존 결제 과정</a><ul><ul><li><a href=#pg-%ec%82%ac%ec%97%90%ec%84%9c-%ec%a0%80%ec%9e%a5%ed%95%a0-%ec%88%98-%ec%97%86%eb%8f%84%eb%a1%9d-%eb%a7%8c%eb%93%a0-%eb%b0%a9%eb%b2%95 aria-label="PG 사에서 저장할 수 없도록 만든 방법">PG 사에서 저장할 수 없도록 만든 방법</a></li></ul></ul></li><li><a href=#2-iamport-%ec%84%a0%ed%83%9d-%ec%9d%b4%ec%9c%a0%ec%99%80-%ec%9e%a5%ec%a0%90 aria-label="2. Iamport 선택 이유와 장점">2. Iamport 선택 이유와 장점</a><ul><ul><li><a href=#iamport-%ec%82%ac%ec%9a%a9-%ec%8b%9c-%ea%b2%b0%ec%a0%9c-%ea%b3%bc%ec%a0%95 aria-label="Iamport 사용 시 결제 과정">Iamport 사용 시 결제 과정</a></li></ul><li><a href=#%ec%95%84%ec%9e%84-%ed%8f%ac%ed%8a%b8%eb%a5%bc-%ec%84%a0%ed%83%9d%ed%95%9c-%ec%9d%b4%ec%9c%a0 aria-label="아임 포트를 선택한 이유">아임 포트를 선택한 이유</a><ul><li><a href=#pg-%ec%82%ac%ec%99%80%ec%9d%98-%eb%b3%b5%ec%9e%a1%ed%95%9c-%ec%97%b0%eb%8f%99-%ea%b3%bc%ec%a0%95-%ed%95%b4%ec%86%8c aria-label="PG 사와의 복잡한 연동 과정 해소">PG 사와의 복잡한 연동 과정 해소</a></li><li><a href=#%ea%b2%b0%ec%a0%9c-%ea%b8%b0%eb%8a%a5-%ed%99%95%ec%9e%a5%ec%84%b1 aria-label="결제 기능 확장성">결제 기능 확장성</a></li><li><a href=#%ed%8e%b8%eb%a6%ac%ed%95%9c-%eb%b3%b5%ec%88%98-pg-%ec%82%ac%ec%9a%a9 aria-label="편리한 복수 PG 사용">편리한 복수 PG 사용</a></li><li><a href=#%ec%9e%98-%ec%a0%95%eb%a6%ac%eb%90%9c-api-%eb%ac%b8%ec%84%9c aria-label="잘 정리된 api 문서">잘 정리된 api 문서</a></li></ul></li></ul></li><li><a href=#3-%ec%95%84%ec%9e%84%ed%8f%ac%ed%8a%b8-javascript-sdk%eb%a5%bc-%ec%82%ac%ec%9a%a9%ed%95%9c-%ea%b2%b0%ec%a0%9c-%ed%9d%90%eb%a6%84 aria-label="3. 아임포트 Javascript SDK를 사용한 결제 흐름">3. 아임포트 Javascript SDK를 사용한 결제 흐름</a><ul><li><a href=#31-%ea%b2%b0%ec%a0%9c-%ed%94%84%eb%a1%9c%ec%84%b8%ec%8a%a4-%ea%b3%bc%ec%a0%95-%ec%88%9c%ec%84%9c aria-label="3.1 결제 프로세스 과정 순서">3.1 결제 프로세스 과정 순서</a><ul><li><a href=#1-2-%ea%b2%b0%ec%a0%9c-%eb%b2%84%ed%8a%bc-%ed%81%b4%eb%a6%ad-%eb%b0%8f-call-paymentjs-%ec%8b%a4%ed%96%89 aria-label="1), 2) 결제 버튼 클릭 및 call-payment.js 실행">1), 2) 결제 버튼 클릭 및 call-payment.js 실행</a></li><li><a href=#3-%ea%b0%80%eb%a7%b9%ec%a0%90-%ec%8b%9d%eb%b3%84%ec%bd%94%eb%93%9c%eb%a1%9c-imp-%ea%b0%9d%ec%b2%b4-%ec%b4%88%ea%b8%b0%ed%99%94 aria-label="3) 가맹점 식별코드로 IMP 객체 초기화">3) 가맹점 식별코드로 IMP 객체 초기화</a></li><li><a href=#4-passpaymentinfo-%ed%95%a8%ec%88%98-%ec%8b%a4%ed%96%89 aria-label="4) passPaymentInfo 함수 실행">4) passPaymentInfo 함수 실행</a></li><li><a href=#5-imprequest_pay%ec%97%90-%ea%b2%b0%ec%a0%9c-%ec%a0%95%eb%b3%b4-%ec%a0%84%eb%8b%ac aria-label="5) IMP.request_pay()에 결제 정보 전달">5) IMP.request_pay()에 결제 정보 전달</a></li><li><a href=#6-pg%ec%82%ac%ec%9d%98-%ea%b2%b0%ec%a0%9c%ec%b0%bd-%ec%98%a4%ed%94%88-%eb%b0%8f-%ec%b9%b4%eb%93%9c%ec%82%ac-%ec%84%a0%ed%83%9d%ed%95%98%ec%97%ac-%ea%b2%b0%ec%a0%9c-%ec%a7%84%ed%96%89 aria-label="6) PG사의 결제창 오픈 및 카드사 선택하여 결제 진행">6) PG사의 결제창 오픈 및 카드사 선택하여 결제 진행</a></li><li><a href=#7-8-%ea%b2%b0%ec%a0%9c-%ec%84%b1%ea%b3%b5-storeimpidindb-%ed%95%a8%ec%88%98-%ec%8b%a4%ed%96%89---redirect aria-label="7), 8) 결제 성공: storeImpIdInDB 함수 실행 -&amp;gt; redirect">7), 8) 결제 성공: storeImpIdInDB 함수 실행 -> redirect</a></li><li><a href=#9-%ea%b2%b0%ec%a0%9c-%ec%8b%a4%ed%8c%a8-makestatusfailure-%ed%95%a8%ec%88%98-%ec%8b%a4%ed%96%89 aria-label="9) 결제 실패: makeStatusFailure 함수 실행">9) 결제 실패: makeStatusFailure 함수 실행</a></li><li><a href=#10-%ea%b2%b0%ec%a0%9c-%ec%8b%a4%ed%8c%a8-%ec%95%88%eb%82%b4%eb%ac%b8 aria-label="10) 결제 실패 안내문">10) 결제 실패 안내문</a></li></ul></li><li><a href=#32-%ea%b2%b0%ec%a0%9c-%ed%94%84%eb%a1%9c%ec%84%b8%ec%8a%a4%ec%97%90%ec%84%9c-%ea%b3%a0%eb%a0%a4%ed%95%9c-%eb%b0%9c%ec%83%9d%ed%95%a0-%ec%88%98-%ec%9e%88%eb%8a%94-%ec%83%81%ed%99%a9%eb%93%a4 aria-label="3.2 결제 프로세스에서 고려한 발생할 수 있는 상황들">3.2 결제 프로세스에서 고려한 발생할 수 있는 상황들</a><ul><li><a href=#%ea%b3%a0%eb%a0%a4%ed%95%9c-%ea%b2%b0%ec%a0%9c-%ec%83%81%ed%99%a9 aria-label="고려한 결제 상황">고려한 결제 상황</a></li></ul></li></ul></li><li><a href=#reference aria-label=Reference>Reference</a></li></ul></div></details></div><div class=post-content><h1 id=0-introduction>0. Introduction<a hidden class=anchor aria-hidden=true href=#0-introduction>#</a></h1><ul><li><p>이 repository는 현재 <a href=https://learningspoons.com/course/detail/django-backend/>러닝스푼즈 나노디그리 - django backend 부트캠프</a>에서 팀 프로젝트를 진행하면서 다음과 같은 내용들에 대해 정리하고자 만들었습니다.</p><ul><li>팀 정책을 이것으로 정한 이유</li><li>개발하면서 부딪힌 문제들에 대한 원인, 해결방안, 해결과정, 그리고 그 이유들</li></ul></li><li><p>이번 포스팅에서는 제가 맡은 결제 기능의 전체적인 프로세스와 아임포트를 사용하면서 이 과정이 어떻게 변하는 지에 대해 설명하겠습니다.</p></li></ul><p> </p><hr><h1 id=1-기존-결제-과정>1. 기존 결제 과정<a hidden class=anchor aria-hidden=true href=#1-기존-결제-과정>#</a></h1><ul><li><p>결제의 기본 진행 과정: <code>인증 -> 결제</code> 순서로 진행</p></li><li><p>하지만, 한국에서는 이 인증 부분에서 차이가 있다. 한국에서 카드 결제 과정은 다음과 같다. 왜냐하면 <strong>한국에서는 카드 정보(카드 번호 / 유효기간 / cvc )를 일부 가맹점 또는 PG 사를 제외하고는 저장할 수 없기 때문이다. 카드 정보는 오로지 카드사에서만 저장 가능하다.</strong></p></li><li><p>카드사 서버가 구매자 브라우저로부터 직접 카드 정보를 전달받아 인증처리하는 게 다른 나라와 가장 큰 차이이다.</p></li><li><p>이 카드 인증된 결과를 바탕으로 결제 프로세스가 진행된다. 결제 프로세스는 3번부터 8번까지의 과정을 말한다.</p></li></ul><p><img loading=lazy src=https://docs.iamport.kr/static/images/tech/webhook/pg-flow.svg alt=image>
출처: <a href=https://docs.iamport.kr/tech/webhook>아임포트 공식문서 - webhook</a></p><p> </p><h3 id=pg-사에서-저장할-수-없도록-만든-방법>PG 사에서 저장할 수 없도록 만든 방법<a hidden class=anchor aria-hidden=true href=#pg-사에서-저장할-수-없도록-만든-방법>#</a></h3><p><img loading=lazy src=https://github.com/iamport/iamport-manual/raw/master/%EC%9D%B8%EC%A6%9D%EA%B2%B0%EC%A0%9C/screenshot/background/authentication.png alt=image>
출처: <a href=https://docs.iamport.kr/tech/webhook>아임포트 공식문서 - webhook</a></p><h3 id=heading><a hidden class=anchor aria-hidden=true href=#heading>#</a></h3><p>그래서 결제를 진행할 때 PG 사의 결제 모달 창이 뜬 후, 카드사를 클릭하면 또 다른 모달 창이 뜬다.</p><p>이것이 PG 사에서 카드 정보를 저장하지 못하도록 하기 위함이다.</p><p>그래서 PG 결제 모듈 창을 띄우고 나서 결제 과정의 첫 시작인 &lsquo;인증&rsquo; 과정이 시작될 수 있다.</p><p> </p><hr><h1 id=2-iamport-선택-이유와-장점>2. Iamport 선택 이유와 장점<a hidden class=anchor aria-hidden=true href=#2-iamport-선택-이유와-장점>#</a></h1><h3 id=iamport-사용-시-결제-과정>Iamport 사용 시 결제 과정<a hidden class=anchor aria-hidden=true href=#iamport-사용-시-결제-과정>#</a></h3><p><img loading=lazy src=https://docs.iamport.kr/static/images/tech/webhook/iamport-flow.svg alt=image>
출처: <a href=https://docs.iamport.kr/tech/webhook>아임포트 공식문서 - webhook</a></p><h2 id=아임-포트를-선택한-이유>아임 포트를 선택한 이유<a hidden class=anchor aria-hidden=true href=#아임-포트를-선택한-이유>#</a></h2><h3 id=pg-사와의-복잡한-연동-과정-해소>PG 사와의 복잡한 연동 과정 해소<a hidden class=anchor aria-hidden=true href=#pg-사와의-복잡한-연동-과정-해소>#</a></h3><blockquote><p><strong><em>직접 api로 만들어야하는 많은 부분을 아임포트가 대신 해주기 때문에, 짧은 기간 안에 결제 기능을 추가하기 좋은 라이브러리로서, 경험이 없는 학습자가 사용하기에 보다 퀄리티에 집중할 수 있다.</em></strong></p></blockquote><p>직접 PG 서버와 통신해야 했던 가맹점 서버의 역할을 대신한다. PG 서버와 직접 통신하기 위해서 PG가 지원하는 제한적인 개발환경을 사용해야하고, PG 모듈을 설치하는 등 절차가 복잡했지만, 아임포트를 사용하면서 간결하고 REST API를 통해 쉽게 결제를 연동할 수 있다.</p><p>위 이미지의 1, 2, 5, 7번 과정만 신경쓰면 된다. 카드정보가 잘못되었다면 카드사 모듈 창에서 입력 시, 인증 오류가 날 것이다. 결제 정보가 잘못되었다던가, 카드 한드가 초과되었다던가, 사용자 변심으로 결제가 취소했다면 결제 단계에서 에러가 난다.</p><h3 id=결제-기능-확장성>결제 기능 확장성<a hidden class=anchor aria-hidden=true href=#결제-기능-확장성>#</a></h3><p>토스에서도 결제 API를 제공한다. 하지만, 나중에 &lsquo;구독&rsquo;이란 정기 결제를 도입할 상황에서 아임포트는 정기 결제 기능을 제공하고 토스에서는 그렇지 않기 때문에, 추후 결제 기능 확장성을 고려할 때 아임포트를 선택했다.</p><h3 id=편리한-복수-pg-사용>편리한 복수 PG 사용<a hidden class=anchor aria-hidden=true href=#편리한-복수-pg-사용>#</a></h3><p>연동되는 PG 선택도 <a href=https://admin.iamport.kr/auth/signin>iamport admin</a>에서 로그인하여 테스트 버전으로 자유롭게 선택할 수 있다.</p><h3 id=잘-정리된-api-문서>잘 정리된 api 문서<a hidden class=anchor aria-hidden=true href=#잘-정리된-api-문서>#</a></h3><p><a href=https://api.iamport.kr/>아임포트 api 문서</a> 를 보면 아임포트 API가 체계적으로 정리되어 있다.</p><p>적절한 api url에 필요한 정보만 보내면 결제 정보를 조회할 수 있다.</p><p> </p><hr><h1 id=3-아임포트-javascript-sdk를-사용한-결제-흐름>3. 아임포트 Javascript SDK를 사용한 결제 흐름<a hidden class=anchor aria-hidden=true href=#3-아임포트-javascript-sdk를-사용한-결제-흐름>#</a></h1><p>아임포트 결제 연동 서비스를 사용하기 위해서는 아임포트 Javascript SDK(Software Development Kit)를 사용해야 한다. 이 SDK를 통해서 내가 생성한 주문번호와 금액을 아임포트에 전달하고, 아임포트는 결제 번호를 나에게 전달한다.</p><p>그래서 이 SDK를 통해 결제 각 단계에서의 데이터 처리를 js function을 통해서 해당 api로 데이터를 전달하기 위해서 fetch를 사용했다. 그리고, 이 view에서 model에 접근하여 고유 주문 번호, 결제 상태, 결제 금액 등의 정보를 저장한다. model에 접근할 때는 ModelManager를 사용하여 해당 Model 객체만의 ORM을 만들었다.</p><h2 id=31-결제-프로세스-과정-순서>3.1 결제 프로세스 과정 순서<a hidden class=anchor aria-hidden=true href=#31-결제-프로세스-과정-순서>#</a></h2><p>해당 프로젝트에서 설계한 결제 프로세스의 전체 흐름은 다음 이미지와 같다.</p><p><img loading=lazy src=https://user-images.githubusercontent.com/78094972/211764083-805f1ddb-8622-45c4-90f2-3ef80d5d9a70.png alt=image></p><p> </p><h3 id=1-2-결제-버튼-클릭-및-call-paymentjs-실행>1), 2) 결제 버튼 클릭 및 call-payment.js 실행<a hidden class=anchor aria-hidden=true href=#1-2-결제-버튼-클릭-및-call-paymentjs-실행>#</a></h3><p>아래 이미지의 &lsquo;이 옵션 선택&rsquo; 태그를 클릭하여 <code>call-payment.js</code>를 실행한다.</p><p>❗️ 원래 사이트에서는 월간 멤버쉽과 연간 멤버쉽 둘 다 존재했다. 하지만, 월간 멤버쉽만 고려한 이유는 1차로 결제 자체 기능만 구현한 후, 그 다음으로 월간 멤버쉽만을 추가로 구현할 계획이기 때문이다.</p><p><img loading=lazy src=https://user-images.githubusercontent.com/78094972/204946352-7f8cb13c-11f5-4cb6-bec3-8b37daa64504.png alt=image></p><p>call-payment.js의 전체 소스 코드를 보고 싶다면 <a href=https://github.com/backendnanodegree/Devket/blob/main/static/js/call-payment.js>이 링크</a>를 클릭한다.</p><p>위 이미지의 버튼은 <code>.order</code>이라는 클래스 명을 가지고 있기 때문에 이를 통해서 DOM을 인식하여 event를 건다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#ff79c6>import</span> {getElement ,setFetchData} from <span style=color:#f1fa8c>&#39;./common.js&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>window</span>.onload <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>function</span> () {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>const</span> IMP <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>window</span>.IMP;
</span></span><span style=display:flex><span>    IMP.init(<span style=color:#f1fa8c>&#39;imp62676076&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>const</span> paymentButton <span style=color:#ff79c6>=</span> getElement(<span style=color:#f1fa8c>&#39;.order&#39;</span>)
</span></span><span style=display:flex><span>    paymentButton.addEventListener(<span style=color:#f1fa8c>&#39;click&#39;</span>, <span style=color:#ff79c6>async</span> (e) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>const</span> type              <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;card&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>let</span> buyer_name, buyer_email, merchant_id, amount, payment_info;
</span></span><span style=display:flex><span>        payment_info            <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>await</span> passPaymentInfo(e, type);
</span></span><span style=display:flex><span>        [buyer_name, buyer_email, merchant_id, amount] <span style=color:#ff79c6>=</span> payment_info
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (merchant_id <span style=color:#ff79c6>!==</span> <span style=color:#f1fa8c>&#39;&#39;</span> <span style=color:#ff79c6>&amp;&amp;</span> merchant_id <span style=color:#ff79c6>!==</span> <span style=color:#ff79c6>undefined</span>) {
</span></span><span style=display:flex><span>           ...
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>false</span>;
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><p> </p><h3 id=3-가맹점-식별코드로-imp-객체-초기화>3) 가맹점 식별코드로 IMP 객체 초기화<a hidden class=anchor aria-hidden=true href=#3-가맹점-식별코드로-imp-객체-초기화>#</a></h3><p>&lsquo;call-payment.js&rsquo;가 실행되면서 제일 먼저 하는 건 &lsquo;가맹점 식별코드&rsquo;로 인한 초기화 작업이다.
&lsquo;가맹점 식별코드&rsquo;는 아임포트를 가입할 때 IMP_KEY와, IMP_SECRET 그리고 가맹점 식별코드인 MERCHANT_ID가 제공된다. 이 MERCHANT_ID를 입력해야 한다. IMP_KEY와 IMP_SECRET은 아임포트에 접근하기 위한 토큰을 받기 위해서 필요하다.</p><p> </p><h3 id=4-passpaymentinfo-함수-실행>4) passPaymentInfo 함수 실행<a hidden class=anchor aria-hidden=true href=#4-passpaymentinfo-함수-실행>#</a></h3><blockquote><p><strong><em>IMP.request_pay()에 전달하기 위한 merchant_id(고유 주문 번호), buyer_name, buyer_email을 backend에서 받아내는 함수</em></strong></p></blockquote><p><img loading=lazy src=https://user-images.githubusercontent.com/78094972/211742667-8b37833c-0dbc-42f0-a6d5-6e2c17eb8848.png alt=image></p><p>이벤트가 발생 시, call-payment.js에서 가장 먼저 실행되는 함수다. 그 이유는 아임포트 api에 전달할 merchant_id (고유 주문 번호)를 생성하고, amount(결제 금액)와 함께 전달하기 위해서다.</p><p>argument(or parameter)로 받은 type은 결제 방식을 말한다. 현재 개발 단계에서는 카드 결제만 고려하고 있기 때문에 <code>const type = 'card'</code>로 정해져있다.</p><ul><li><strong>[4-1, 4-2] 과정</strong><ul><li>merchant_id를 생성하기 위해서 정해놓은 <code>/api/payment/checkout</code> 으로 fetch를 사용하여 data를 보낸다. 그러면 urls.py 에 의해서 이 api url과 mapping된 django view class로 request를 보낸다. 이 api url과 연결된 class는 <code>PaymentPassView</code> 다.</li></ul></li><li><strong>[4-5] 과정</strong><ul><li><code>PaymentPassView</code>에서 보낸 response에서 json형태로 데이터를 뽑아낸다. <code>.works</code>는 아임포트 api에서 응답 결과를 알려주는 key 값이다. 아임포트에서 응답이 성공했으면 <code>"works": True</code>로, 실패하면 <code>False</code>로 값이 온다.</li></ul></li></ul><p>그래서 works가 True이면 view class에서 원하는 값을 받은 것이기 때문에, 이 경우 unpacking을 사용하고자 배열의 형태로 결과값을 반환했다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#6272a4>// IMP.request_pay를 호출하기 위한 merchant_id 반환
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>async</span> <span style=color:#8be9fd;font-style:italic>function</span> passPaymentInfo(e, type) {
</span></span><span style=display:flex><span>    e.preventDefault(); 
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>let</span> merchant_id <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>let</span> amount <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>let</span> buyer_name <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>let</span> buyer_email <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>const</span> data <span style=color:#ff79c6>=</span> setFetchData(<span style=color:#f1fa8c>&#39;POST&#39;</span>, {
</span></span><span style=display:flex><span>        amount<span style=color:#ff79c6>:</span> amount, 
</span></span><span style=display:flex><span>        type<span style=color:#ff79c6>:</span> type
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>const</span> response <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>await</span> fetch(<span style=color:#f1fa8c>`/api/payment/checkout`</span>, data)
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>const</span> result   <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>await</span> response.json() 
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (result.works) {
</span></span><span style=display:flex><span>        buyer_name <span style=color:#ff79c6>=</span> result.buyer_name 
</span></span><span style=display:flex><span>        buyer_email <span style=color:#ff79c6>=</span> result.buyer_email
</span></span><span style=display:flex><span>        merchant_id <span style=color:#ff79c6>=</span> result.merchant_id
</span></span><span style=display:flex><span>        amount <span style=color:#ff79c6>=</span> result.amount
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> [buyer_name, buyer_email, merchant_id, amount]
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (response.status <span style=color:#ff79c6>===</span> <span style=color:#bd93f9>401</span>) {
</span></span><span style=display:flex><span>        alert(<span style=color:#f1fa8c>&#39;로그인 해주세요.&#39;</span>)
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        alert(<span style=color:#f1fa8c>&#39;문제가 발생했습니다. 다시 시도해주세요.&#39;</span>)
</span></span><span style=display:flex><span>    }};
</span></span></code></pre></td></tr></table></div></div><p>그러면 PaymentPassView class에서 어떻게 merchant_id를 생성하여 반환하는지 알아보자.</p><p>로그인 후, 결제를 시도하면 다음 ORM으로 user과 email를 조회한다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>user <span style=color:#ff79c6>=</span> User<span style=color:#ff79c6>.</span>objects<span style=color:#ff79c6>.</span>get(<span style=color:#8be9fd;font-style:italic>id</span><span style=color:#ff79c6>=</span>kwards[<span style=color:#f1fa8c>&#39;user_id&#39;</span>])
</span></span><span style=display:flex><span>buyer_email <span style=color:#ff79c6>=</span> Email<span style=color:#ff79c6>.</span>objects<span style=color:#ff79c6>.</span>get(user<span style=color:#ff79c6>=</span>user)<span style=color:#ff79c6>.</span>email 
</span></span><span style=display:flex><span><span style=color:#6272a4># Email model에서 email은 회원가입 시 사용한 이메일을 말한다.</span>
</span></span></code></pre></td></tr></table></div></div><p>그 후, 이 객체 정보를 사용하여 merchant_id를 생성한다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>merchant_id <span style=color:#ff79c6>=</span> Payment<span style=color:#ff79c6>.</span>objects<span style=color:#ff79c6>.</span>create_new(
</span></span><span style=display:flex><span>                user<span style=color:#ff79c6>=</span>user,
</span></span><span style=display:flex><span>                amount<span style=color:#ff79c6>=</span>amount,
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>type</span><span style=color:#ff79c6>=</span>payment_type,
</span></span><span style=display:flex><span>                )
</span></span></code></pre></td></tr></table></div></div><ul><li><strong>[4-3 ~ 4-5 과정]</strong><ul><li><p><strong>(4-3) class PaymentManager</strong></p><ul><li>Payment만의 orm을 사용하기 위해 만든 PaymentManager를 통해서 merchant_id를 생성한다.</li></ul></li><li><p><strong>(4-4) import.py & Payment object 생성</strong></p><ul><li>그후, 이 merchant_id와 amount를 아임포트에 전달한다.</li><li>PaymentManager의 클래스 변수로 선언한 imp를 사용하여 <code>prepare_payments</code> method를 통해 생성한 merchant_id를 amount와 함께 아임포트에 전달한다.</li><li>이 때 전달하는 아임포트 api url은 <code>{아임포트 기본 api url}/payments/prepare</code> 이다.</li><li>그 다음에 payment 객체를 새롭게 생성한다.</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>PaymentManager</span>(models<span style=color:#ff79c6>.</span>Manager):
</span></span><span style=display:flex><span>    imp <span style=color:#ff79c6>=</span> Iamport()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>def</span> <span style=color:#50fa7b>create_new</span>(self, user, amount, <span style=color:#8be9fd;font-style:italic>type</span>):
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># 아임포트에 전달</span>
</span></span><span style=display:flex><span>        PaymentManager<span style=color:#ff79c6>.</span>imp<span style=color:#ff79c6>.</span>prepare_payments(merchant_id, amount)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4># 새로운 payment 객체 생성</span>
</span></span><span style=display:flex><span>        new_payment <span style=color:#ff79c6>=</span> self<span style=color:#ff79c6>.</span>model(user<span style=color:#ff79c6>=</span>user, merchant_id<span style=color:#ff79c6>=</span>merchant_id,
</span></span><span style=display:flex><span>                                amount<span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>int</span>(amount), <span style=color:#8be9fd;font-style:italic>type</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>type</span>)
</span></span></code></pre></td></tr></table></div></div></li><li><p><strong>(4-5) class PaymentPassView</strong></p><ul><li>PaymentManager의 create_new에서 반환한 merchant_id와 함께 필요한 정보들을 call-payments.js의 passPaymentInfo function에 response를 보낸다.</li></ul></li></ul></li></ul><p> </p><h3 id=5-imprequest_pay에-결제-정보-전달>5) IMP.request_pay()에 결제 정보 전달<a hidden class=anchor aria-hidden=true href=#5-imprequest_pay에-결제-정보-전달>#</a></h3><p>이전 단계에서 보낸 amount, merchant_id, pay_method, buyer_name, buyer_email와 함께 어느 pg사를 호출할 것인지 pg key 값에 value로 입력해야 한다. 이는 아임포트 공식문서를 참고한다.</p><p>pg사로는 KG 이니시스를 선택했는데, 그 이유로는 웹표준으로서 브라우저 제약 없이 결제가 가능하기 때문이다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#ff79c6>if</span> (merchant_id <span style=color:#ff79c6>!==</span> <span style=color:#f1fa8c>&#39;&#39;</span> <span style=color:#ff79c6>&amp;&amp;</span> merchant_id <span style=color:#ff79c6>!==</span> <span style=color:#ff79c6>undefined</span>) {
</span></span><span style=display:flex><span>            IMP.request_pay({
</span></span><span style=display:flex><span>                pg<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;html5_inicis&#39;</span>, <span style=color:#6272a4>// KG 이니시스
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>                merchant_uid<span style=color:#ff79c6>:</span> merchant_id,
</span></span><span style=display:flex><span>                name<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;Devket Premium 서비스&#39;</span>,
</span></span><span style=display:flex><span>                pay_method<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;card&#39;</span>,
</span></span><span style=display:flex><span>                amount<span style=color:#ff79c6>:</span> amount,
</span></span><span style=display:flex><span>                buyer_name <span style=color:#ff79c6>:</span> buyer_name,
</span></span><span style=display:flex><span>                buyer_email <span style=color:#ff79c6>:</span> buyer_email
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 결제창 오픈
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            <span style=color:#8be9fd;font-style:italic>function</span> (response) {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (response.success) {
</span></span><span style=display:flex><span>                   ...
</span></span><span style=display:flex><span>                } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>                   ...
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span></code></pre></td></tr></table></div></div><p> </p><h3 id=6-pg사의-결제창-오픈-및-카드사-선택하여-결제-진행>6) PG사의 결제창 오픈 및 카드사 선택하여 결제 진행<a hidden class=anchor aria-hidden=true href=#6-pg사의-결제창-오픈-및-카드사-선택하여-결제-진행>#</a></h3><p>다음과 같은 KG 이니시스의 결제창이 떠서 결제가 진행된다.</p><p><img loading=lazy src=https://user-images.githubusercontent.com/78094972/204946409-f7df613c-15af-43df-a5b1-4c1633f7deb0.png alt=image></p><p> </p><h3 id=7-8-결제-성공-storeimpidindb-함수-실행---redirect>7), 8) 결제 성공: storeImpIdInDB 함수 실행 -> redirect<a hidden class=anchor aria-hidden=true href=#7-8-결제-성공-storeimpidindb-함수-실행---redirect>#</a></h3><blockquote><p><strong><em>결제가 성공하여 아임포트에서 받은 imp_uid를, 생성했던 payment 객체에 imp_id로서 결제 상태를 저장하고, User 객체의 결제 상태를 변경하는 함수</em></strong></p></blockquote><p><img loading=lazy src=https://user-images.githubusercontent.com/78094972/211764278-c8cfba87-185a-49db-9604-58da610fe634.png alt=image></p><ul><li><p><strong>(7-1) urls.py</strong></p><ul><li>fetch를 사용하여 &lsquo;/api/payment/validation&rsquo; api url에 data를 보내면 urls.py에서 이 api url에 mapping된 PaymentImpStoreView로 request가 가도록 한다.</li></ul></li><li><p><strong>(7-2, 7-3, 7-4, 7-5) class PaymentImpStoreView</strong></p><ul><li>request로부터 imp_id, amount, merchant_id, status를 가져와 이에 해당하는 payment 정보와 User 정보를 조회한다.</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>PaymentImpStoreView</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>...</span>
</span></span><span style=display:flex><span>    user <span style=color:#ff79c6>=</span> User<span style=color:#ff79c6>.</span>objects<span style=color:#ff79c6>.</span>get(<span style=color:#8be9fd;font-style:italic>id</span><span style=color:#ff79c6>=</span>kwards[<span style=color:#f1fa8c>&#39;user_id&#39;</span>])
</span></span><span style=display:flex><span>    payment <span style=color:#ff79c6>=</span> Payment<span style=color:#ff79c6>.</span>objects<span style=color:#ff79c6>.</span>get(user, merchant_id, amount)
</span></span></code></pre></td></tr></table></div></div><ul><li>조회 후, payment 객체에 imp_id, status 정보를 저장한다. user 객체에는 기존에 미결제 상태인 것을 &lsquo;결제&rsquo; 상태로 변경한다.</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>user<span style=color:#ff79c6>.</span>payment_status <span style=color:#ff79c6>=</span> User<span style=color:#ff79c6>.</span>PAYMENT_ON
</span></span><span style=display:flex><span>user<span style=color:#ff79c6>.</span>save()
</span></span><span style=display:flex><span>payment_data <span style=color:#ff79c6>=</span> {<span style=color:#f1fa8c>&#39;payment_id&#39;</span>: imp_id, <span style=color:#f1fa8c>&#39;status&#39;</span>: payment_status}
</span></span><span style=display:flex><span>self<span style=color:#ff79c6>.</span>check_validation(payment, data<span style=color:#ff79c6>=</span>payment_data)
</span></span><span style=display:flex><span><span style=color:#ff79c6>...</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>그리고, 변경 결과에 따라서 <code>works</code>의 값이 변경되고, 이를 storeImpIdInDB에 전달한다.</li></ul></li><li><p><strong>(7-5 ~ 7-7) 결제 검증하기: payment_validation & get_transaction</strong></p><ul><li>post_save에 의해서 Payment 객체가 저장되면 결제가 유효한지 검증하는 <code>payment_validation</code> function이 실행된다.</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>post_save<span style=color:#ff79c6>.</span>connect(payment_validation, sender<span style=color:#ff79c6>=</span>Payment)
</span></span></code></pre></td></tr></table></div></div><ul><li>payment_validation 내부에는 PaymentManager로 정의한 <code>get_transaction</code> 메서드가 있어서, 이를 통해서 iamport 내에 결제 내역이 있는지 확인하여 아임포트에도 존재하고, db에도 다 존재하는지를 확인합니다.</li><li>다 존재해야 결제가 올바르게 된 것입니다.</li></ul></li><li><p><strong>[8] 과정- redirect</strong> : PG 결제 창에서 결제가 완료되면 다른 화면으로 리다이렉트합니다.</p></li></ul><p> </p><h3 id=9-결제-실패-makestatusfailure-함수-실행>9) 결제 실패: makeStatusFailure 함수 실행<a hidden class=anchor aria-hidden=true href=#9-결제-실패-makestatusfailure-함수-실행>#</a></h3><p><img loading=lazy src=https://user-images.githubusercontent.com/78094972/211742647-d5694554-81bc-4483-9351-016ca109380f.png alt=image></p><blockquote><p><strong><em>사용자가 결제 정보를 다 입력하고, 완료버튼만 누르면 되는 상황에서 &lsquo;사용자 변심&rsquo;으로 결제를 취소할 경우 결제 상태를 반영하는 함수</em></strong></p></blockquote><ul><li><p><strong>(9-1) urls.py</strong></p><ul><li>fetch를 사용하여 &lsquo;/api/payment/failure&rsquo; api url에 data를 보내면 urls.py에서 이 api url에 mapping된 PaymentFailedView로 request가 간다.</li></ul></li><li><p><strong>(9-2 ~ 9-5) class PaymentFailedView</strong></p><ul><li>request로부터 imp_id 와 merchant_id를 가져와 아래아 같이 객체 조회 및 수정에 사용한다.</li><li>Payment 객체 조회 및 수정</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>imp_id <span style=color:#ff79c6>=</span> request<span style=color:#ff79c6>.</span>data[<span style=color:#f1fa8c>&#39;imp_id&#39;</span>]
</span></span><span style=display:flex><span>merchant_id <span style=color:#ff79c6>=</span> request<span style=color:#ff79c6>.</span>data[<span style=color:#f1fa8c>&#39;merchant_id&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Payment 객체 조회</span>
</span></span><span style=display:flex><span>payment <span style=color:#ff79c6>=</span> Payment<span style=color:#ff79c6>.</span>objects<span style=color:#ff79c6>.</span>get(merchant_id<span style=color:#ff79c6>=</span> merchant_id)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Payment 객체 정보 수정</span>
</span></span><span style=display:flex><span>payment_data <span style=color:#ff79c6>=</span> {<span style=color:#f1fa8c>&#39;payment_id&#39;</span>: <span style=color:#f1fa8c>&#39;imp_id&#39;</span>, <span style=color:#f1fa8c>&#39;status&#39;</span>: <span style=color:#f1fa8c>&#39;failed&#39;</span>}
</span></span><span style=display:flex><span>serializer <span style=color:#ff79c6>=</span> PaymentSerializer(payment, data<span style=color:#ff79c6>=</span>payment_data, partial<span style=color:#ff79c6>=</span><span style=color:#ff79c6>True</span>)
</span></span></code></pre></td></tr></table></div></div><ul><li>처리 결과에 따라서 <code>"works"</code>의 값을 True, False로 바꿔서 Response를 보낸다.</li></ul></li></ul><p> </p><h3 id=10-결제-실패-안내문>10) 결제 실패 안내문<a hidden class=anchor aria-hidden=true href=#10-결제-실패-안내문>#</a></h3><p>9)의 경우처럼 사용자 변심으로 결제 실패한 경우와 그 외의 실패했을 때 다음과 같이 alert를 사용하여 안내한다.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (response.imp_uid) {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 결제한 유저의 이름과 이메일 확인 후, 사용자 변심으로 결제 창을 닫아 결제 취소되는 로직
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        makeStatusFailure(e, response.merchant_uid, response.imp_uid);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>let</span> msg <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;결제에 실패하였습니다. \n&#39;</span>;
</span></span><span style=display:flex><span>    msg <span style=color:#ff79c6>+=</span> <span style=color:#f1fa8c>&#39;에러내용: &#39;</span> <span style=color:#ff79c6>+</span> response.error_msg;
</span></span><span style=display:flex><span>    alert(msg)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p> </p><h2 id=32-결제-프로세스에서-고려한-발생할-수-있는-상황들>3.2 결제 프로세스에서 고려한 발생할 수 있는 상황들<a hidden class=anchor aria-hidden=true href=#32-결제-프로세스에서-고려한-발생할-수-있는-상황들>#</a></h2><p>결제 기능에서 중요하고 어려운 것은 다음 3가지라고 생각한다.</p><ul><li>내부 정책에 따라서 무엇보다 여러 상황에 대해서 고려해보고 이에 대해 어떻게 코드를 짰는지</li><li>배달을 하는 e-commerce처럼 장바구니, 배달, 쿠폰 할인 같은 여러 모델들이 엮어져야 복잡해지는 상황</li><li>대규모 트래픽 상황에서 많은 사용자들이 동시에 결제 요청들이 들어올 때 이를 얼마나 빠르고 정확하게 처리하는지</li></ul><p>하지만, 현재 프로젝트는 단지 구독 같은 개념이고, e-commerce처럼 복잡하지 않다. 또한, 트래픽이 거의 없는 상황이다. 그래서 내가 최대한 고려할 것은 첫 번째 경우라고 생각한다.</p><p>이런 상황에서 최대한 내가 생각해낼 수 있는 결제 상황들에 대해 정리해보려고 한다.</p><h3 id=고려한-결제-상황>고려한 결제 상황<a hidden class=anchor aria-hidden=true href=#고려한-결제-상황>#</a></h3><table><thead><tr><th>merchant_id</th><th>imp_id</th><th>status</th><th></th></tr></thead><tbody><tr><td>x</td><td>x</td><td>failed</td><td>(1)</td></tr><tr><td>o</td><td>x</td><td>await</td><td>(2)</td></tr><tr><td>o</td><td>x</td><td>failed</td><td>(3)</td></tr><tr><td>o</td><td>o</td><td>failed</td><td>(4)</td></tr><tr><td>o</td><td>o</td><td>paid</td><td>(5)</td></tr></tbody></table><ul><li><p>로그인 전 =></p><ul><li>로그인 전 결제를 시도할려고 한다면 <code>alert()</code>를 사용하여 결제 후 시도하라는 안내문이 뜬다.</li></ul></li><li><p>로그인 후 =></p><ul><li>(1) 새로운 객체를 생성하는데 실패하여, PG 결제 창이 뜨지 못한 경우<ul><li><em>merchant id와 imp id는 존재하지 않고, 결제 상태는 failed</em></li></ul></li><li>(2) PG 결제 창을 띄웠지만 카드사를 선택하지 않고, 사용자 변심으로 취소했을 경우 => 결제 실패<ul><li><em>merchant id는 존재하지만, imp id는 존재하지 않고, 결제 상태는 await</em></li></ul></li><li>(2) 카드 정보 입력 실패 => 결제 실패<ul><li>카드 정보 불일치, 한도 초과, 잔액 부족 등의 사유로 결제가 중단<ul><li><em>merchant id는 존재하지만, imp id는 존재하지 않고, 결제 상태는 await</em></li></ul></li></ul></li><li>(3) 주문 번호가 이미 존재할 경우 => 결제 실패<ul><li>주문 번호는 시간에 따라 다른 주문 번호를 생성하도록 했기 때문에, 이미 존재하는 주문 번호가 들어왔다는 건 에러가 발생한 상황을 의미</li><li><em>merchant id는 존재하지만, imp id는 존재하지 않고, 결제 상태는 failed</em></li></ul></li><li>카드 정보 입력 완료 =><ul><li>(4) &lsquo;취소&rsquo; 버튼 클릭 => 사용자 변심으로 인한 결제 실패<ul><li><em>merchant id, imp id는 존재하지만 결제 상태는 failed</em></li></ul></li><li>(5) &lsquo;완료&rsquo; 버튼 클릭 => 결제 성공<ul><li><em>merchant id, imp id는 다 존재하면서 결제 상태는 paid</em></li></ul></li></ul></li></ul></li></ul><p>위의 상황들은 1차 결제 기능 구현 시 고려한 상황이다. 계속해서 환불과 정기 결제를 추가하려고 한다.</p><p>그렇다면 환불 시에는 사용 기간에 따른 환불 정책을 어떻게 세울 것인지, 정기 결제를 도입한다면 결제 기간 몇 일 전에 알림을 주는 것이 사용자 편의성에 좋을텐데 이를 기술적으로 어떻게 구현할지가 고려사항으로 올라온다.</p><p>1차적인 결제 과정에서의 고려사항은 <a href=https://jeha00.github.io/post/project/django/02_payment_issues/>Project: Payment 개발 과정에서의 고려사항들과 개발 이슈들</a> 문서를 참고하도록 한다.</p><p> </p><hr><h1 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h1><ul><li><a href=https://github.com/iamport/iamport-manual/blob/master/%EC%9D%B8%EC%A6%9D%EA%B2%B0%EC%A0%9C/background.md>한국 전자결제 서비스 흐름</a></li><li><a href=https://skyseven73.tistory.com/17>Django에서 아임포트를 통해 결제 구현하기 - (1) 아임포트 세팅 및 결제 구조</a></li><li><a href=https://admin.iamport.kr/auth/signin>iamport admin</a></li><li><a href=https://api.iamport.kr/>아임포트 api 문서</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=http://jeha00.github.io/tags/iamport/>iamport</a></li></ul><nav class=paginav><a class=prev href=http://jeha00.github.io/post/project/devket/django/02_payment_issues/><span class=title>« Prev Page</span><br><span>Project: Payment 개발 과정에서의 고려사항들과 개발 이슈들</span></a>
<a class=next href=http://jeha00.github.io/post/docker/00_docker-commands-02/><span class=title>Next Page »</span><br><span>Docker study: Docker command list 02</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Project: Iamport를 선택한 이유, 사용 시 결제 과정과 장점, 그리고 아임포트 javascript SDK를 사용한 결제 흐름 on twitter" href="https://twitter.com/intent/tweet/?text=Project%3a%20Iamport%eb%a5%bc%20%ec%84%a0%ed%83%9d%ed%95%9c%20%ec%9d%b4%ec%9c%a0%2c%20%ec%82%ac%ec%9a%a9%20%ec%8b%9c%20%ea%b2%b0%ec%a0%9c%20%ea%b3%bc%ec%a0%95%ea%b3%bc%20%ec%9e%a5%ec%a0%90%2c%20%ea%b7%b8%eb%a6%ac%ea%b3%a0%20%ec%95%84%ec%9e%84%ed%8f%ac%ed%8a%b8%20javascript%20SDK%eb%a5%bc%20%ec%82%ac%ec%9a%a9%ed%95%9c%20%ea%b2%b0%ec%a0%9c%20%ed%9d%90%eb%a6%84&url=http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdjango%2f01_payment_overall_flow%2f&hashtags=iamport"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Project: Iamport를 선택한 이유, 사용 시 결제 과정과 장점, 그리고 아임포트 javascript SDK를 사용한 결제 흐름 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdjango%2f01_payment_overall_flow%2f&title=Project%3a%20Iamport%eb%a5%bc%20%ec%84%a0%ed%83%9d%ed%95%9c%20%ec%9d%b4%ec%9c%a0%2c%20%ec%82%ac%ec%9a%a9%20%ec%8b%9c%20%ea%b2%b0%ec%a0%9c%20%ea%b3%bc%ec%a0%95%ea%b3%bc%20%ec%9e%a5%ec%a0%90%2c%20%ea%b7%b8%eb%a6%ac%ea%b3%a0%20%ec%95%84%ec%9e%84%ed%8f%ac%ed%8a%b8%20javascript%20SDK%eb%a5%bc%20%ec%82%ac%ec%9a%a9%ed%95%9c%20%ea%b2%b0%ec%a0%9c%20%ed%9d%90%eb%a6%84&summary=Project%3a%20Iamport%eb%a5%bc%20%ec%84%a0%ed%83%9d%ed%95%9c%20%ec%9d%b4%ec%9c%a0%2c%20%ec%82%ac%ec%9a%a9%20%ec%8b%9c%20%ea%b2%b0%ec%a0%9c%20%ea%b3%bc%ec%a0%95%ea%b3%bc%20%ec%9e%a5%ec%a0%90%2c%20%ea%b7%b8%eb%a6%ac%ea%b3%a0%20%ec%95%84%ec%9e%84%ed%8f%ac%ed%8a%b8%20javascript%20SDK%eb%a5%bc%20%ec%82%ac%ec%9a%a9%ed%95%9c%20%ea%b2%b0%ec%a0%9c%20%ed%9d%90%eb%a6%84&source=http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdjango%2f01_payment_overall_flow%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Project: Iamport를 선택한 이유, 사용 시 결제 과정과 장점, 그리고 아임포트 javascript SDK를 사용한 결제 흐름 on reddit" href="https://reddit.com/submit?url=http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdjango%2f01_payment_overall_flow%2f&title=Project%3a%20Iamport%eb%a5%bc%20%ec%84%a0%ed%83%9d%ed%95%9c%20%ec%9d%b4%ec%9c%a0%2c%20%ec%82%ac%ec%9a%a9%20%ec%8b%9c%20%ea%b2%b0%ec%a0%9c%20%ea%b3%bc%ec%a0%95%ea%b3%bc%20%ec%9e%a5%ec%a0%90%2c%20%ea%b7%b8%eb%a6%ac%ea%b3%a0%20%ec%95%84%ec%9e%84%ed%8f%ac%ed%8a%b8%20javascript%20SDK%eb%a5%bc%20%ec%82%ac%ec%9a%a9%ed%95%9c%20%ea%b2%b0%ec%a0%9c%20%ed%9d%90%eb%a6%84"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Project: Iamport를 선택한 이유, 사용 시 결제 과정과 장점, 그리고 아임포트 javascript SDK를 사용한 결제 흐름 on facebook" href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdjango%2f01_payment_overall_flow%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Project: Iamport를 선택한 이유, 사용 시 결제 과정과 장점, 그리고 아임포트 javascript SDK를 사용한 결제 흐름 on whatsapp" href="https://api.whatsapp.com/send?text=Project%3a%20Iamport%eb%a5%bc%20%ec%84%a0%ed%83%9d%ed%95%9c%20%ec%9d%b4%ec%9c%a0%2c%20%ec%82%ac%ec%9a%a9%20%ec%8b%9c%20%ea%b2%b0%ec%a0%9c%20%ea%b3%bc%ec%a0%95%ea%b3%bc%20%ec%9e%a5%ec%a0%90%2c%20%ea%b7%b8%eb%a6%ac%ea%b3%a0%20%ec%95%84%ec%9e%84%ed%8f%ac%ed%8a%b8%20javascript%20SDK%eb%a5%bc%20%ec%82%ac%ec%9a%a9%ed%95%9c%20%ea%b2%b0%ec%a0%9c%20%ed%9d%90%eb%a6%84%20-%20http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdjango%2f01_payment_overall_flow%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Project: Iamport를 선택한 이유, 사용 시 결제 과정과 장점, 그리고 아임포트 javascript SDK를 사용한 결제 흐름 on telegram" href="https://telegram.me/share/url?text=Project%3a%20Iamport%eb%a5%bc%20%ec%84%a0%ed%83%9d%ed%95%9c%20%ec%9d%b4%ec%9c%a0%2c%20%ec%82%ac%ec%9a%a9%20%ec%8b%9c%20%ea%b2%b0%ec%a0%9c%20%ea%b3%bc%ec%a0%95%ea%b3%bc%20%ec%9e%a5%ec%a0%90%2c%20%ea%b7%b8%eb%a6%ac%ea%b3%a0%20%ec%95%84%ec%9e%84%ed%8f%ac%ed%8a%b8%20javascript%20SDK%eb%a5%bc%20%ec%82%ac%ec%9a%a9%ed%95%9c%20%ea%b2%b0%ec%a0%9c%20%ed%9d%90%eb%a6%84&url=http%3a%2f%2fjeha00.github.io%2fpost%2fproject%2fdevket%2fdjango%2f01_payment_overall_flow%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=http://jeha00.github.io/>Jeha DevLog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>